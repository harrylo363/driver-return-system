<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Command Center - Enhanced</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #0F172A;
            --primary-light: #1E293B;
            --accent: #3B82F6;
            --accent-hover: #2563EB;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --bg-dark: #0F172A;
            --bg-card: #1E293B;
            --bg-hover: #334155;
            --border: #334155;
            --gradient-primary: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            --gradient-dark: linear-gradient(180deg, #0F172A 0%, #1E293B 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
            z-index: -1;
        }
        
        /* Premium Header */
        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 0;
        }
        
        .header-content {
            max-width: 1920px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            width: 48px;
            height: 48px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .logo::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .brand-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        
        .brand-text p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 100px;
            font-size: 0.875rem;
            color: var(--success);
            font-weight: 500;
        }
        
        .status-indicator.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }
        
        .pulse {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .pulse.error {
            background: var(--danger);
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* Main Container */
        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--accent);
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .kpi-card:hover::before {
            opacity: 1;
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .kpi-icon {
            width: 48px;
            height: 48px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 0.5rem;
            font-variant-numeric: tabular-nums;
        }
        
        .kpi-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .kpi-sublabel {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        /* Control Panel */
        .control-panel {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
            transform: translateY(-2px);
        }
        
        .filter-group {
            display: flex;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .filter-btn {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .filter-btn:not(:last-child) {
            border-right: 1px solid var(--border);
        }
        
        .filter-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        
        .filter-btn.active {
            color: white;
            background: var(--accent);
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }
        
        /* Activity Section */
        .activity-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .section-header {
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .activity-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .activity-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .activity-list::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        .activity-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .activity-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        .activity-item {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .activity-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: transparent;
            transition: all 0.2s ease;
        }
        
        .activity-item:hover {
            background: var(--bg-hover);
            padding-left: 2rem;
        }
        
        .activity-item.en-route::before { background: var(--warning); }
        .activity-item.arrived::before { background: var(--success); }
        .activity-item.still-working::before { background: var(--text-muted); }
        .activity-item.completed::before { background: var(--success); }
        
        .activity-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .activity-info {
            flex: 1;
        }
        
        .activity-driver {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }
        
        .activity-details {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }
        
        .activity-detail {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .status-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-en-route {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .status-arrived {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-still-working {
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-muted);
            border: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        .status-completed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        /* Analytics Panel */
        .analytics-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
        }
        
        .analytics-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .metric-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .metric-card:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }
        
        .metric-change {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        /* Map Container */
        #map {
            height: 400px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
        }
        
        /* Messaging Panel */
        .messaging-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            z-index: 999;
            transition: transform 0.3s ease;
        }
        
        .messaging-panel.minimized {
            transform: translateY(calc(100% - 60px));
        }
        
        .messaging-header {
            background: var(--bg-dark);
            color: var(--text-primary);
            padding: 1rem;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .message-count {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .messages-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-card);
        }
        
        .message {
            background: var(--bg-dark);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .message.priority-high {
            border-left: 4px solid var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        
        .message-from {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .message-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .message-reply {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--border);
            gap: 0.5rem;
        }
        
        .message-input {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .send-btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .send-btn:hover {
            background: var(--accent-hover);
        }
        
        /* Export Panel */
        .export-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .export-options {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .export-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .export-csv {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .export-pdf {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .export-excel {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-xl);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            max-width: 350px;
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .notification-toast.success {
            border-left: 4px solid var(--success);
        }
        
        .notification-toast.warning {
            border-left: 4px solid var(--warning);
        }
        
        .notification-toast.error {
            border-left: 4px solid var(--danger);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Input Styles */
        input[type="date"] {
            padding: 0.5rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
        }
        
        /* Loading Animation */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 1400px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                flex-direction: column;
            }
            
            .messaging-panel {
                width: calc(100% - 40px);
            }
        }
    </style>
</head>
<body>
    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div id="notificationContent"></div>
    </div>

    <!-- Premium Header -->
    <header class="header">
        <div class="header-content">
            <div class="brand">
                <div class="logo">‚ö°</div>
                <div class="brand-text">
                    <h1>Fleet Command Center</h1>
                    <p>Real-time Fleet Management</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="status-indicator" id="connectionIndicator">
                    <div class="pulse" id="statusDot"></div>
                    <span id="connectionText">Connecting...</span>
                </div>
                <div class="warehouse-label" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: var(--accent); padding: 0.5rem 1rem; border-radius: 100px; font-size: 0.875rem; font-weight: 500;">
                    5856 Tampa FDC
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üöö</div>
                </div>
                <div class="kpi-value" id="activeCount">0</div>
                <div class="kpi-label">Active Drivers</div>
                <div class="kpi-sublabel">Currently on duty</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon" style="background: rgba(245, 158, 11, 0.1);">üìç</div>
                </div>
                <div class="kpi-value" id="enrouteCount">0</div>
                <div class="kpi-label">En Route</div>
                <div class="kpi-sublabel">30 min away</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon" style="background: rgba(16, 185, 129, 0.1);">üèÅ</div>
                </div>
                <div class="kpi-value" id="arrivedCount">0</div>
                <div class="kpi-label">Arrived</div>
                <div class="kpi-sublabel">At warehouse</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon" style="background: rgba(16, 185, 129, 0.1);">‚úÖ</div>
                </div>
                <div class="kpi-value" id="completedCount">0</div>
                <div class="kpi-label">Completed</div>
                <div class="kpi-sublabel">Checked in today</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon" style="background: rgba(100, 116, 139, 0.1);">üì¶</div>
                </div>
                <div class="kpi-value" id="workingCount">0</div>
                <div class="kpi-label">Still Working</div>
                <div class="kpi-sublabel">Out on routes</div>
            </div>
        </div>

        <!-- CORRECTED ORDER OF BUTTONS -->
        <!-- TOP ROW: Activity Filter Panel -->
        <div class="control-panel">
            <div class="filter-group" style="flex: 1;">
                <button class="filter-btn active" onclick="filterDrivers('overview', this)">Overview</button>
                <button class="filter-btn" onclick="filterDrivers('en-route', this)">En Route</button>
                <button class="filter-btn" onclick="filterDrivers('arrived', this)">Arrived</button>
                <button class="filter-btn" onclick="filterDrivers('completed', this)">‚úì Completed</button>
                <button class="filter-btn" onclick="filterDrivers('still-working', this)">Still Working</button>
            </div>
            <button class="btn btn-secondary" onclick="refreshDashboard()">
                <span>üîÑ</span>
                <span>Refresh</span>
            </button>
        </div>

        <!-- BOTTOM ROW: Tab Navigation -->
        <div class="control-panel" style="margin-bottom: 2rem;">
            <div class="filter-group">
                <button class="filter-btn active" onclick="switchTab('activeops', this)">Active Operations</button>
                <button class="filter-btn" onclick="switchTab('map', this)">Live Map</button>
                <button class="filter-btn" onclick="switchTab('messages', this)">Messages</button>
                <button class="filter-btn" onclick="switchTab('export', this)">Reports</button>
            </div>
        </div>

        <!-- Active Operations Tab (renamed from Overview) -->
        <div id="activeopsTab" class="tab-content active">
            <div class="dashboard-grid">
                <!-- Activity Feed -->
                <div class="activity-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <span>üì°</span>
                            <span>Real-Time Activity Feed</span>
                        </h2>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span id="activityCount" style="font-size: 0.875rem; color: var(--text-secondary);"></span>
                            <span id="lastUpdate" style="font-size: 0.875rem; color: var(--text-secondary);">
                                <span class="loader" style="margin-right: 0.5rem;"></span>
                                Syncing...
                            </span>
                        </div>
                    </div>
                    <div class="activity-list" id="activityList">
                        <div class="empty-state">
                            <div class="empty-icon">üõ∏</div>
                            <p>Initializing fleet tracking system...</p>
                        </div>
                    </div>
                </div>

                <!-- Equipment Status Panel -->
                <div>
                    <div class="analytics-panel" style="margin-bottom: 1.5rem;">
                        <h3 class="analytics-title">
                            <span>üîß</span>
                            <span>Equipment Status</span>
                        </h3>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">üöõ Tractor Issues</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 1rem; margin-top: 1rem;">
                                <div class="metric-value" id="tractorIssues">0</div>
                                <div class="metric-change">active issues</div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">üöö Trailer Issues</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 1rem; margin-top: 1rem;">
                                <div class="metric-value" id="trailerIssues">0</div>
                                <div class="metric-change">active issues</div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">üèóÔ∏è Moffett Issues</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 1rem; margin-top: 1rem;">
                                <div class="metric-value" id="moffettIssues">0</div>
                                <div class="metric-change">active issues</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-panel">
                        <h3 class="analytics-title">
                            <span>‚ö°</span>
                            <span>Quick Actions</span>
                        </h3>
                        
                        <div style="display: grid; gap: 1rem;">
                            <button class="btn btn-primary" style="width: 100%;" onclick="window.location.href='admin.html'">
                                <span>üë§</span>
                                <span>Admin Panel</span>
                            </button>
                            <button class="btn btn-secondary" style="width: 100%;" onclick="window.location.href='driver.html'">
                                <span>üöö</span>
                                <span>Driver Portal</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Tab -->
        <div id="mapTab" class="tab-content">
            <div class="activity-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>üìç</span>
                        <span>Live Driver Locations</span>
                    </h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="centerMap()">Center Map</button>
                        <button class="btn btn-secondary" onclick="refreshMap()">Refresh</button>
                    </div>
                </div>
                <div style="padding: 1rem;">
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <!-- Messages Tab -->
        <div id="messagesTab" class="tab-content">
            <div class="activity-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>üí¨</span>
                        <span>Driver Messages</span>
                    </h2>
                    <button class="btn btn-secondary" onclick="markAllRead()">Mark All Read</button>
                </div>
                <div id="messagesList" style="padding: 1rem;">
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <p>No messages</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="exportTab" class="tab-content">
            <div class="export-panel">
                <div class="section-header" style="padding: 0; background: transparent; border: none;">
                    <h2 class="section-title">
                        <span>üìä</span>
                        <span>Export Reports</span>
                    </h2>
                </div>
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">Date Range:</label>
                    <input type="date" id="startDate" style="margin-right: 1rem;">
                    <input type="date" id="endDate">
                </div>
                <div class="export-options">
                    <button class="export-btn export-csv" onclick="exportToCSV()">
                        <span>üìÑ</span>
                        <span>CSV</span>
                    </button>
                    <button class="export-btn export-pdf" onclick="exportToPDF()">
                        <span>üìë</span>
                        <span>PDF</span>
                    </button>
                    <button class="export-btn export-excel" onclick="exportToExcel()">
                        <span>üìà</span>
                        <span>Excel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messaging Panel (Floating) -->
    <div class="messaging-panel minimized" id="messagingPanel">
        <div class="messaging-header" onclick="toggleMessaging()">
            <span>üí¨ Driver Messages</span>
            <span class="message-count" id="messageCount">0</span>
        </div>
        <div class="messages-container" id="messagesContainer"></div>
        <div class="message-reply">
            <input type="text" class="message-input" id="replyInput" placeholder="Type a reply...">
            <button class="send-btn" onclick="sendReply()">Send</button>
        </div>
    </div>

    <script>
        // Initialize variables
        let socket;
        let map;
        let driverMarkers = {};
        let currentTab = 'activeops';
        let currentFilter = 'overview';
        let allDrivers = [];
        let messages = [];
        let completedCheckIns = [];
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            loadInitialData();
            startPolling();
            
            // Set today's date for export
            document.getElementById('endDate').valueAsDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            document.getElementById('startDate').valueAsDate = startDate;
        });
        
        // Initialize Socket.io connection
        function initializeSocket() {
            try {
                socket = io(window.location.origin, {
                    transports: ['websocket', 'polling'],
                    reconnection: true
                });
                
                socket.on('connect', () => {
                    updateConnectionStatus(true);
                    socket.emit('join-dashboard');
                    showNotification('Connected to real-time updates', 'success');
                });
                
                socket.on('disconnect', () => {
                    updateConnectionStatus(false);
                });
                
                // Listen for real-time updates
                socket.on('driver-update', handleDriverUpdate);
                socket.on('driver-location-update', handleLocationUpdate);
                socket.on('new-driver-message', handleNewMessage);
                
            } catch (error) {
                console.log('WebSocket not available, using polling');
                updateConnectionStatus(false);
            }
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionIndicator');
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.classList.remove('error');
                dot.classList.remove('error');
                text.textContent = 'Live Updates';
            } else {
                indicator.classList.add('error');
                dot.classList.add('error');
                text.textContent = 'Polling Mode';
            }
        }
        
        // Load initial data
        async function loadInitialData() {
            await loadDrivers();
            await loadMessages();
            updateKPIs();
        }
        
        // Load drivers
        async function loadDrivers() {
            try {
                const response = await fetch('/api/notifications?limit=100');
                if (response.ok) {
                    const result = await response.json();
                    allDrivers = result.data || [];
                    
                    // Separate completed check-ins for today
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    
                    completedCheckIns = allDrivers.filter(driver => {
                        const driverTime = new Date(driver.timestamp);
                        return driver.status === 'completed' && driverTime >= today;
                    });
                    
                    updateDriverList();
                    updateKPIs();
                }
            } catch (error) {
                console.error('Error loading drivers:', error);
            }
        }
        
        // Filter drivers
        function filterDrivers(filter, button) {
            currentFilter = filter;
            
            // Update button states
            button.parentElement.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            updateDriverList();
        }
        
        // Update driver list based on filter
        function updateDriverList() {
            const activityList = document.getElementById('activityList');
            let filteredDrivers = [];
            
            // Filter based on selected status
            if (currentFilter === 'overview') {
                // Overview shows ALL active (non-completed) drivers
                filteredDrivers = allDrivers.filter(d => 
                    d.status !== 'completed'
                );
            } else if (currentFilter === 'en-route') {
                // Only drivers who are 30 minutes away
                filteredDrivers = allDrivers.filter(d => 
                    d.status === '30 minutes away' || 
                    d.status === 'en-route' ||
                    d.status === 'en route'
                );
            } else if (currentFilter === 'arrived') {
                // Only drivers who have arrived at warehouse
                filteredDrivers = allDrivers.filter(d => 
                    d.status === 'arrived' || 
                    d.status === 'Arrived'
                );
            } else if (currentFilter === 'completed') {
                // Only completed check-ins for today
                filteredDrivers = completedCheckIns;
            } else if (currentFilter === 'still-working') {
                // Drivers who haven't started their return (no status or other status)
                filteredDrivers = allDrivers.filter(d => 
                    !d.status || 
                    (d.status !== '30 minutes away' && 
                     d.status !== 'en-route' && 
                     d.status !== 'en route' &&
                     d.status !== 'arrived' && 
                     d.status !== 'Arrived' &&
                     d.status !== 'completed')
                );
            }
            
            // Update activity count with proper label
            let filterLabel = '';
            if (currentFilter === 'overview') {
                filterLabel = 'active drivers';
            } else if (currentFilter === 'en-route') {
                filterLabel = 'en route';
            } else if (currentFilter === 'arrived') {
                filterLabel = 'arrived';
            } else if (currentFilter === 'completed') {
                filterLabel = 'completed today';
            } else if (currentFilter === 'still-working') {
                filterLabel = 'still working';
            }
            
            document.getElementById('activityCount').textContent = `${filteredDrivers.length} ${filterLabel}`;
            
            if (filteredDrivers.length === 0) {
                activityList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <p>No ${filterLabel}</p>
                    </div>
                `;
                return;
            }
            
            // Sort by timestamp (newest first)
            filteredDrivers.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            activityList.innerHTML = filteredDrivers
                .slice(0, 50) // Show up to 50 drivers
                .map(driver => {
                    const time = new Date(driver.timestamp).toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    
                    let statusClass = 'still-working';
                    let statusText = 'Still Working';
                    
                    if (driver.status === '30 minutes away' || driver.status === 'en-route' || driver.status === 'en route') {
                        statusClass = 'en-route';
                        statusText = 'En Route (30 min)';
                    } else if (driver.status === 'arrived' || driver.status === 'Arrived') {
                        statusClass = 'arrived';
                        statusText = 'Arrived';
                    } else if (driver.status === 'completed') {
                        statusClass = 'completed';
                        statusText = 'Completed';
                    }
                    
                    return `
                        <div class="activity-item ${statusClass}">
                            <div class="activity-content">
                                <div class="activity-info">
                                    <div class="activity-driver">${driver.driver || 'Unknown Driver'}</div>
                                    <div class="activity-details">
                                        <span class="activity-detail">
                                            <span>‚è±</span>
                                            <span>${time}</span>
                                        </span>
                                        <span class="activity-detail">
                                            <span>üìç</span>
                                            <span>${driver.warehouse || '5856 Tampa FDC'}</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="activity-actions">
                                    <span class="status-badge status-${statusClass}">
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            document.getElementById('lastUpdate').innerHTML = `Updated: ${new Date().toLocaleTimeString()}`;
        }
        
        // Load messages
        async function loadMessages() {
            try {
                const response = await fetch('/api/messages/dispatch');
                if (response.ok) {
                    messages = await response.json();
                    updateMessagesDisplay();
                    updateMessageCount();
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        // Update KPIs
        function updateKPIs() {
            const now = new Date();
            const todayStart = new Date(now.setHours(0,0,0,0));
            
            const counts = {
                active: 0,
                enroute: 0,
                arrived: 0,
                completed: 0,
                working: 0
            };
            
            allDrivers.forEach(driver => {
                const updateTime = new Date(driver.timestamp);
                
                if (updateTime >= todayStart) {
                    if (driver.status === '30 minutes away' || driver.status === 'en-route') counts.enroute++;
                    else if (driver.status === 'arrived') counts.arrived++;
                    else if (driver.status === 'completed') counts.completed++;
                    
                    if (driver.status !== 'completed') {
                        counts.active++;
                        if (driver.status !== '30 minutes away' && driver.status !== 'en-route' && driver.status !== 'arrived') {
                            counts.working++;
                        }
                    }
                }
            });
            
            document.getElementById('activeCount').textContent = counts.active;
            document.getElementById('enrouteCount').textContent = counts.enroute;
            document.getElementById('arrivedCount').textContent = counts.arrived;
            document.getElementById('completedCount').textContent = counts.completed;
            document.getElementById('workingCount').textContent = counts.working;
            
            // Update equipment issues (placeholder)
            document.getElementById('tractorIssues').textContent = '0';
            document.getElementById('trailerIssues').textContent = '0';
            document.getElementById('moffettIssues').textContent = '0';
        }
        
        // Update messages display
        function updateMessagesDisplay() {
            const container = document.getElementById('messagesContainer');
            const messagesList = document.getElementById('messagesList');
            
            if (messages.length === 0) {
                const emptyHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <p>No messages</p>
                    </div>
                `;
                container.innerHTML = emptyHTML;
                messagesList.innerHTML = emptyHTML;
                return;
            }
            
            const messagesHTML = messages.slice(0, 10).map(msg => `
                <div class="message ${msg.priority === 'high' ? 'priority-high' : ''}">
                    <div class="message-header">
                        <span class="message-from">Driver ${msg.from}</span>
                        <span class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="message-text">${msg.message}</div>
                </div>
            `).join('');
            
            container.innerHTML = messagesHTML;
            messagesList.innerHTML = `<div style="padding: 1rem;">${messagesHTML}</div>`;
        }
        
        // Update message count
        function updateMessageCount() {
            const unreadCount = messages.filter(m => !m.read).length;
            document.getElementById('messageCount').textContent = unreadCount;
        }
        
        // Switch tabs
        function switchTab(tabName, button) {
            currentTab = tabName;
            
            // Update tab buttons
            if (button) {
                button.parentElement.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Initialize map when map tab is opened
            if (tabName === 'map' && !map) {
                setTimeout(initializeMap, 100);
            }
        }
        
        // Initialize map
        function initializeMap() {
            map = L.map('map').setView([27.9506, -82.4572], 11); // Tampa coordinates
            
            // Dark theme tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO'
            }).addTo(map);
            
            // Add warehouse marker
            L.marker([27.9506, -82.4572], {
                icon: L.divIcon({
                    className: 'warehouse-marker',
                    html: '<div style="background: var(--accent); color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold;">üè≠ Warehouse</div>',
                    iconSize: [120, 30]
                })
            }).addTo(map);
            
            updateMapMarkers();
        }
        
        // Update map markers
        function updateMapMarkers() {
            if (!map) return;
            
            // Clear existing markers
            Object.values(driverMarkers).forEach(marker => {
                map.removeLayer(marker);
            });
            driverMarkers = {};
            
            // Add driver markers (simulated positions)
            allDrivers.forEach((driver, index) => {
                if (driver.status !== 'completed') {
                    const lat = 27.9506 + (Math.random() - 0.5) * 0.2;
                    const lng = -82.4572 + (Math.random() - 0.5) * 0.2;
                    
                    const icon = L.divIcon({
                        className: 'driver-marker',
                        html: driver.status === 'arrived' ? 'üèÅ' : 'üöö',
                        iconSize: [25, 25]
                    });
                    
                    const marker = L.marker([lat, lng], { icon })
                        .addTo(map)
                        .bindPopup(`
                            <strong>${driver.driver}</strong><br>
                            Status: ${driver.status}<br>
                            Time: ${new Date(driver.timestamp).toLocaleTimeString()}
                        `);
                    
                    driverMarkers[driver.driverId] = marker;
                }
            });
        }
        
        // Map controls
        function centerMap() {
            if (map) {
                map.setView([27.9506, -82.4572], 11);
            }
        }
        
        function refreshMap() {
            loadDrivers();
            if (map) updateMapMarkers();
            showNotification('Map refreshed', 'success');
        }
        
        // Messaging
        function toggleMessaging() {
            const panel = document.getElementById('messagingPanel');
            panel.classList.toggle('minimized');
        }
        
        function sendReply() {
            const input = document.getElementById('replyInput');
            const message = input.value.trim();
            
            if (message) {
                if (socket && socket.connected) {
                    socket.emit('dispatch-message', {
                        from: 'dispatch',
                        message: message,
                        timestamp: new Date()
                    });
                }
                
                input.value = '';
                showNotification('Message sent', 'success');
            }
        }
        
        function markAllRead() {
            messages.forEach(m => m.read = true);
            updateMessageCount();
            showNotification('All messages marked as read', 'success');
        }
        
        // Export functions
        async function exportToCSV() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            window.location.href = `/api/export/csv?startDate=${startDate}&endDate=${endDate}`;
            showNotification('Exporting to CSV...', 'success');
        }
        
        async function exportToPDF() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            window.location.href = `/api/export/pdf?startDate=${startDate}&endDate=${endDate}`;
            showNotification('Exporting to PDF...', 'success');
        }
        
        async function exportToExcel() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            window.location.href = `/api/export/excel?startDate=${startDate}&endDate=${endDate}`;
            showNotification('Exporting to Excel...', 'success');
        }
        
        // Handle real-time updates
        function handleDriverUpdate(data) {
            loadDrivers();
            showNotification(`Driver ${data.driverId} status updated`, 'success');
        }
        
        function handleLocationUpdate(data) {
            if (map && driverMarkers[data.driverId]) {
                driverMarkers[data.driverId].setLatLng([data.position.lat, data.position.lng]);
            }
        }
        
        function handleNewMessage(data) {
            messages.unshift(data);
            updateMessagesDisplay();
            updateMessageCount();
            showNotification(`New message from Driver ${data.from}`, 'warning');
        }
        
        // Refresh dashboard
        function refreshDashboard() {
            loadInitialData();
            showNotification('Dashboard refreshed', 'success');
        }
        
        // Notification system
        function showNotification(message, type = 'success') {
            const toast = document.getElementById('notificationToast');
            const content = document.getElementById('notificationContent');
            
            toast.className = `notification-toast ${type}`;
            content.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Polling fallback
        function startPolling() {
            setInterval(() => {
                if (!socket || !socket.connected) {
                    loadInitialData();
                }
            }, 30000);
        }
    </script>
</body>
</html>
