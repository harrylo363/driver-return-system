<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dispatch Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #4A6CF7;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        #map {
            height: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .activity-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .activity-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-item:hover {
            background: #f9f9f9;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4A6CF7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3651D8;
        }
        
        .btn-success {
            background: #10B981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-en-route {
            background: #FEF3C7;
            color: #92400E;
        }
        
        .status-arrived {
            background: #D1FAE5;
            color: #065F46;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.success {
            border-left: 4px solid #10B981;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .filter-btn.active {
            background: #4A6CF7;
            color: white;
            border-color: #4A6CF7;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🚚 Driver Dispatch Dashboard</h1>
            <p style="color: #666; margin-top: 5px;">Real-time driver tracking and management</p>
        </div>
    </div>
    
    <div class="container">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalDrivers">0</div>
                <div class="stat-label">Total Active Drivers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="enRouteCount">0</div>
                <div class="stat-label">En Route</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="arrivedCount">0</div>
                <div class="stat-label">Arrived</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayCount">0</div>
                <div class="stat-label">Updates Today</div>
            </div>
        </div>
        
        <!-- Map -->
        <div id="map"></div>
        
        <!-- Controls -->
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterStatus('all')">All</button>
            <button class="filter-btn" onclick="filterStatus('en-route')">En Route</button>
            <button class="filter-btn" onclick="filterStatus('arrived')">Arrived</button>
            <button class="btn btn-primary" onclick="refreshData()">🔄 Refresh</button>
            <button class="btn btn-primary" onclick="loadDemoData()">📊 Demo Data</button>
        </div>
        
        <!-- Activity List -->
        <div class="activity-section">
            <div class="activity-header">
                <h2>Recent Driver Activity</h2>
                <span id="lastUpdate" style="color: #666; font-size: 14px;">Last updated: Never</span>
            </div>
            <div id="activityList" class="activity-list">
                <div class="loading">Loading driver data...</div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global variables
        let map;
        let markers = {};
        let notifications = [];
        let currentFilter = 'all';
        let lastNotificationIds = new Set();
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([25.7617, -80.1918], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }
        
        // Load notifications from API
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                if (!response.ok) throw new Error('Failed to fetch');
                
                const data = await response.json();
                const newNotifications = Array.isArray(data) ? data : (data.data || []);
                
                // Check for new driver updates
                checkForNewDriverUpdates(newNotifications);
                
                notifications = newNotifications;
                updateDisplay();
                updateLastUpdateTime();
            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('activityList').innerHTML = 
                    '<div class="loading">Error loading data. Please check your connection.</div>';
            }
        }
        
        // Check for new driver updates and show notifications
        function checkForNewDriverUpdates(newNotifications) {
            // Only check if we have previous data to compare
            if (lastNotificationIds.size === 0) {
                // First load - just store the IDs
                newNotifications.forEach(n => {
                    if (n._id) lastNotificationIds.add(n._id);
                });
                return;
            }
            
            // Find new driver notifications
            const newDriverUpdates = newNotifications.filter(n => 
                n._id && 
                n.driver && 
                n.status && 
                !lastNotificationIds.has(n._id) &&
                // Only notify for updates within last 30 seconds
                (new Date() - new Date(n.timestamp)) < 30000
            );
            
            // Show notifications for new updates
            newDriverUpdates.forEach(update => {
                const icon = update.status === 'arrived' ? '🎉' : '🚚';
                const message = update.status === 'arrived' 
                    ? `${update.driver} has arrived at ${update.warehouse || 'the warehouse'}!`
                    : `${update.driver} is 30 minutes away from ${update.warehouse || 'the warehouse'}!`;
                
                showToast(message, 'success', icon);
                
                // Play a sound if arrived
                if (update.status === 'arrived') {
                    playNotificationSound();
                }
            });
            
            // Update the stored IDs
            lastNotificationIds.clear();
            newNotifications.forEach(n => {
                if (n._id) lastNotificationIds.add(n._id);
            });
        }
        
        // Update display
        function updateDisplay() {
            // Filter driver notifications
            const driverNotifications = notifications.filter(n => n.driver && n.status);
            
            // Update stats
            updateStats(driverNotifications);
            
            // Update map
            updateMap(driverNotifications);
            
            // Update activity list
            updateActivityList(driverNotifications);
        }
        
        // Update statistics
        function updateStats(driverNotifications) {
            const today = new Date().toDateString();
            const todayNotifications = driverNotifications.filter(n => 
                new Date(n.timestamp).toDateString() === today
            );
            
            const enRoute = driverNotifications.filter(n => n.status === 'en-route').length;
            const arrived = driverNotifications.filter(n => n.status === 'arrived').length;
            
            document.getElementById('totalDrivers').textContent = driverNotifications.length;
            document.getElementById('enRouteCount').textContent = enRoute;
            document.getElementById('arrivedCount').textContent = arrived;
            document.getElementById('todayCount').textContent = todayNotifications.length;
        }
        
        // Update map markers
        function updateMap(driverNotifications) {
            // Clear existing markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};
            
            // Add markers for active drivers
            driverNotifications.forEach(notification => {
                if (notification.location && notification.location !== 'Location unavailable') {
                    try {
                        const [lat, lng] = notification.location.split(',').map(coord => parseFloat(coord.trim()));
                        
                        if (!isNaN(lat) && !isNaN(lng)) {
                            const color = notification.status === 'arrived' ? 'green' : 'orange';
                            const marker = L.circleMarker([lat, lng], {
                                radius: 8,
                                fillColor: color,
                                color: '#fff',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(map);
                            
                            marker.bindPopup(`
                                <strong>${notification.driver}</strong><br>
                                Status: ${notification.status}<br>
                                ${notification.warehouse || 'Unknown warehouse'}
                            `);
                            
                            markers[notification._id] = marker;
                        }
                    } catch (error) {
                        console.error('Error parsing location:', error);
                    }
                }
            });
        }
        
        // Update activity list
        function updateActivityList(driverNotifications) {
            const filteredNotifications = currentFilter === 'all' 
                ? driverNotifications 
                : driverNotifications.filter(n => n.status === currentFilter);
            
            if (filteredNotifications.length === 0) {
                document.getElementById('activityList').innerHTML = 
                    '<div class="loading">No driver updates found.</div>';
                return;
            }
            
            const html = filteredNotifications
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 50)
                .map(notification => {
                    const time = new Date(notification.timestamp).toLocaleString();
                    const statusClass = `status-${notification.status}`;
                    
                    return `
                        <div class="activity-item">
                            <div>
                                <strong>${notification.driver}</strong>
                                <span class="status-badge ${statusClass}">${notification.status}</span>
                                <br>
                                <small style="color: #666;">
                                    ${notification.warehouse || 'Unknown warehouse'} • ${time}
                                </small>
                            </div>
                            ${notification.status === 'arrived' && !notification.read ? 
                                `<button class="btn btn-success" onclick="checkIn('${notification._id}', '${notification.driver}')">
                                    Check In
                                </button>` : ''
                            }
                        </div>
                    `;
                }).join('');
            
            document.getElementById('activityList').innerHTML = html;
        }
        
        // Filter by status
        function filterStatus(status) {
            currentFilter = status;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateDisplay();
        }
        
        // Check in driver
        async function checkIn(id, driverName) {
            if (confirm(`Check in ${driverName}?`)) {
                try {
                    const response = await fetch(`/api/notifications/${id}/read`, {
                        method: 'PUT'
                    });
                    
                    if (response.ok) {
                        showToast(`${driverName} checked in successfully!`, 'success');
                        await loadNotifications();
                    }
                } catch (error) {
                    console.error('Error checking in:', error);
                    showToast('Error checking in driver', 'error');
                }
            }
        }
        
        // Refresh data
        function refreshData() {
            showToast('Refreshing data...', 'success');
            loadNotifications();
        }
        
        // Load demo data
        function loadDemoData() {
            const demoDrivers = [
                { name: 'John Smith', status: 'en-route', location: '25.7617, -80.1918' },
                { name: 'Sarah Johnson', status: 'arrived', location: '25.7750, -80.2000' },
                { name: 'Mike Davis', status: 'en-route', location: '25.7500, -80.2100' },
                { name: 'Lisa Wilson', status: 'arrived', location: '25.7800, -80.1900' }
            ];
            
            notifications = demoDrivers.map((driver, index) => ({
                _id: `demo-${index}`,
                driver: driver.name,
                status: driver.status,
                location: driver.location,
                warehouse: 'Miami Distribution Center',
                timestamp: new Date(),
                read: false
            }));
            
            updateDisplay();
            showToast('Demo data loaded!', 'success');
        }
        
        // Show toast message
        function showToast(message, type = 'success', icon = null) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span style="font-size: 24px;">${icon || (type === 'success' ? '✅' : '❌')}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 5000); // Show for 5 seconds
        }
        
        // Play notification sound
        function playNotificationSound() {
            try {
                // Create a simple beep sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.log('Could not play sound:', error);
            }
        }
        
        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date().toLocaleTimeString();
            document.getElementById('lastUpdate').textContent = `Last updated: ${now}`;
        }
        
        // Initialize on load
        window.onload = function() {
            initMap();
            loadNotifications();
            
            // Auto-refresh every 10 seconds
            setInterval(loadNotifications, 10000);
        };
    </script>
</body>
</html>
