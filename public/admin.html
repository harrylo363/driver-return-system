<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetForce Command Center | Enterprise Logistics Management</title>
    
    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Premium Dark Theme */
            --bg-primary: #0B0F1A;
            --bg-secondary: #1A1F2E;
            --bg-tertiary: #242B3D;
            --bg-elevated: #2A3441;
            --bg-card: #1E2532;
            --bg-glass: rgba(42, 52, 65, 0.9);
            
            /* Accent Colors */
            --accent-blue: #0EA5E9;
            --accent-blue-light: #38BDF8;
            --accent-purple: #8B5CF6;
            --accent-green: #10B981;
            --accent-orange: #F59E0B;
            --accent-red: #EF4444;
            
            /* Text Colors */
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
            --text-tertiary: #94A3B8;
            --text-muted: #64748B;
            --text-dim: #475569;
            
            /* Border & Dividers */
            --border-primary: #334155;
            --border-secondary: #475569;
            --border-accent: rgba(14, 165, 233, 0.3);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #0EA5E9 0%, #8B5CF6 100%);
            --gradient-glass: linear-gradient(135deg, rgba(248, 250, 252, 0.1) 0%, rgba(248, 250, 252, 0.05) 100%);
            --gradient-card: linear-gradient(145deg, #1E2532 0%, #242B3D 100%);
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 30px rgba(14, 165, 233, 0.3);
            
            /* Animations */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            font-size: 14px;
            font-weight: 400;
        }
        
        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 15% 20%, rgba(14, 165, 233, 0.15) 0%, transparent 45%),
                radial-gradient(circle at 85% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 45%),
                radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
                linear-gradient(145deg, rgba(11, 15, 26, 0.95) 0%, rgba(26, 31, 46, 0.98) 100%);
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }
        
        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Enterprise Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Premium Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 1000;
            transition: transform var(--transition-normal);
        }
        
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-primary);
            background: rgba(14, 165, 233, 0.05);
        }
        
        .brand-logo {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }
        
        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-primary);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-glow);
        }
        
        .logo-icon::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: rotate(45deg);
            animation: logoShine 4s infinite;
        }
        
        @keyframes logoShine {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .brand-text h1 {
            font-size: 20px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            letter-spacing: -0.02em;
        }
        
        .brand-text p {
            font-size: 12px;
            color: var(--text-tertiary);
            margin: 0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 24px 0;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 32px;
        }
        
        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0 24px 12px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all var(--transition-fast);
            position: relative;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent-blue);
            transform: scaleY(0);
            transition: transform var(--transition-fast);
        }
        
        .nav-item:hover {
            color: var(--text-primary);
            background: rgba(14, 165, 233, 0.08);
            padding-left: 28px;
        }
        
        .nav-item.active {
            color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.12);
            font-weight: 600;
        }
        
        .nav-item.active::before {
            transform: scaleY(1);
        }
        
        .nav-icon {
            font-size: 18px;
            min-width: 18px;
            text-align: center;
        }
        
        .nav-badge {
            margin-left: auto;
            background: var(--accent-blue);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid var(--border-primary);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 12px;
            border: 1px solid var(--border-primary);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: white;
        }
        
        .user-info h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .user-info p {
            font-size: 11px;
            color: var(--text-tertiary);
            margin: 0;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            background: rgba(11, 15, 26, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        /* Premium Header */
        .main-header {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-primary);
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
            flex-shrink: 0;
        }
        
        .header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 4px;
            letter-spacing: -0.02em;
        }
        
        .header-left p {
            font-size: 13px;
            color: var(--text-tertiary);
            margin: 0;
            font-weight: 500;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.12);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-green);
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .dashboard-link {
            padding: 10px 20px;
            background: rgba(14, 165, 233, 0.12);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 10px;
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-fast);
        }
        
        .dashboard-link:hover {
            background: rgba(14, 165, 233, 0.2);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        /* Content Container */
        .content-container {
            padding: 32px;
            max-width: 1600px;
            margin: 0 auto;
            flex: 1;
            overflow-y: auto;
        }
        
        /* Premium Tab Navigation */
        .tab-navigation {
            display: flex;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 6px;
            margin-bottom: 32px;
            overflow-x: auto;
            box-shadow: var(--shadow-md);
        }
        
        .tab-btn {
            padding: 14px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 12px;
            transition: all var(--transition-fast);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity var(--transition-fast);
            z-index: -1;
        }
        
        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
            transform: translateY(-1px);
        }
        
        .tab-btn.active {
            color: white;
            background: var(--gradient-primary);
            box-shadow: var(--shadow-glow);
        }
        
        .tab-btn.active::before {
            opacity: 1;
        }
        
        .tab-icon {
            font-size: 16px;
        }
        
        /* Enhanced Cards */
        .enterprise-card {
            background: var(--gradient-card);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            position: relative;
            transition: all var(--transition-normal);
        }
        
        .enterprise-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .enterprise-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-accent);
        }
        
        .enterprise-card:hover::before {
            opacity: 1;
        }
        
        .card-header {
            padding: 24px 32px 0;
            background: rgba(14, 165, 233, 0.03);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.01em;
        }
        
        .card-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
            margin: 0 0 24px;
            font-weight: 500;
        }
        
        .card-body {
            padding: 32px;
        }
        
        /* Premium Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
            align-items: start;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        
        .form-input, .form-select {
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all var(--transition-fast);
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
            min-height: 44px;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: var(--bg-tertiary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
            font-weight: 400;
        }
        
        .form-select option {
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 8px;
        }
        
        /* Premium Buttons */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            justify-content: center;
            position: relative;
            overflow: hidden;
            font-family: inherit;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left var(--transition-slow);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.5);
        }
        
        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }
        
        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: rgba(239, 68, 68, 0.12);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: rgba(16, 185, 129, 0.12);
            color: var(--accent-green);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .btn-success:hover {
            background: rgba(16, 185, 129, 0.2);
            transform: translateY(-1px);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .btn-icon {
            font-size: 16px;
        }
        
        /* Premium Upload Area */
        .upload-area {
            border: 2px dashed var(--border-primary);
            border-radius: 16px;
            padding: 48px 32px;
            text-align: center;
            transition: all var(--transition-normal);
            background: var(--bg-elevated);
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .upload-area:hover {
            border-color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.05);
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.1);
            box-shadow: var(--shadow-glow);
        }
        
        .upload-area.dragover::before {
            opacity: 0.05;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--text-muted);
            transition: all var(--transition-normal);
        }
        
        .upload-area:hover .upload-icon {
            color: var(--accent-blue);
            transform: scale(1.1);
        }
        
        .upload-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .upload-subtext {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .file-input {
            display: none;
        }
        
        /* Premium Table */
        .data-table {
            background: var(--enterprise-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        
        .table-header {
            padding: 24px 32px;
            background: rgba(14, 165, 233, 0.05);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .search-container {
            position: relative;
        }
        
        .search-input {
            padding: 12px 16px 12px 44px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            width: 300px;
            transition: all var(--transition-fast);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 16px;
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .user-table th {
            padding: 16px 24px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 700;
            text-align: left;
            border-bottom: 1px solid var(--border-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .user-table td {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-primary);
            color: var(--text-primary);
            font-weight: 500;
            vertical-align: middle;
        }
        
        .user-table tr:hover {
            background: rgba(14, 165, 233, 0.05);
        }
        
        .user-table tr:last-child td {
            border-bottom: none;
        }
        
        .user-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-inactive {
            background: rgba(100, 116, 139, 0.15);
            color: var(--text-muted);
            border: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        .role-driver {
            background: rgba(14, 165, 233, 0.15);
            color: var(--accent-blue);
            border: 1px solid rgba(14, 165, 233, 0.3);
        }
        
        .role-dispatcher {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-orange);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .role-admin {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-purple);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        /* Premium Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 15, 26, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--gradient-card);
            border: 1px solid var(--border-primary);
            border-radius: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlideIn 0.4s ease;
            box-shadow: var(--shadow-xl);
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            background: rgba(14, 165, 233, 0.05);
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }
        
        .modal-close {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 18px;
        }
        
        .modal-close:hover {
            background: var(--accent-red);
            color: white;
            border-color: var(--accent-red);
            transform: scale(1.05);
        }
        
        .modal-body {
            padding: 32px;
            max-height: calc(90vh - 160px);
            overflow-y: auto;
        }
        
        .modal-actions {
            padding: 24px 32px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            background: rgba(14, 165, 233, 0.02);
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            padding: 16px 24px;
            background: var(--gradient-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 350px;
            max-width: 500px;
            z-index: 3000;
            animation: toastSlideIn 0.4s ease;
        }
        
        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-icon {
            font-size: 20px;
            min-width: 20px;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .toast.success .toast-icon { color: var(--accent-green); }
        .toast.error .toast-icon { color: var(--accent-red); }
        .toast.warning .toast-icon { color: var(--accent-orange); }
        .toast.info .toast-icon { color: var(--accent-blue); }
        
        /* Loading States */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-primary);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-muted);
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }
        
        .empty-description {
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.5;
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Settings Cards */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }
        
        .settings-card {
            background: var(--gradient-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-md);
        }
        
        .settings-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Template Download Section */
        .template-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .template-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        
        .template-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .template-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--accent-blue);
        }
        
        .template-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .template-description {
            font-size: 12px;
            color: var(--text-tertiary);
        }
        
        /* Progress Bars */
        .progress-container {
            margin-top: 16px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 100px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-primary);
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 100px;
            transition: width 0.8s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: progressShimmer 2s infinite;
        }
        
        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 16px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 1024px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header-right {
                flex-direction: column;
                gap: 12px;
                align-items: flex-end;
            }
            
            .search-input {
                width: 200px;
            }
            
            .tab-navigation {
                overflow-x: auto;
                padding: 4px;
            }
            
            .tab-btn {
                min-width: 120px;
            }
        }
        
        @media (max-width: 768px) {
            .content-container {
                padding: 16px;
            }
            
            .main-header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .header-right {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .connection-status {
                font-size: 11px;
                padding: 6px 12px;
            }
            
            .dashboard-link {
                font-size: 12px;
                padding: 8px 16px;
            }
            
            .tab-navigation {
                padding: 4px;
                margin-bottom: 20px;
            }
            
            .tab-btn {
                padding: 10px 16px;
                font-size: 12px;
                min-width: 100px;
            }
            
            .tab-icon {
                font-size: 14px;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .card-header {
                padding: 20px 20px 0;
            }
            
            .card-title {
                font-size: 16px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 24px;
            }
            
            .user-table th,
            .user-table td {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .user-table th {
                font-size: 10px;
            }
            
            .user-actions {
                flex-direction: column;
                gap: 4px;
            }
            
            .btn-sm {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .modal-content {
                margin: 10px;
                max-width: none;
                border-radius: 16px;
            }
            
            .modal-header {
                padding: 16px 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-actions {
                padding: 16px 20px;
                flex-direction: column;
                gap: 12px;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
            
            .search-input {
                width: 100%;
                font-size: 14px;
            }
            
            .upload-area {
                padding: 32px 20px;
            }
            
            .upload-text {
                font-size: 16px;
            }
            
            .upload-subtext {
                font-size: 13px;
            }
            
            .template-section {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .template-card {
                padding: 16px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .settings-card {
                padding: 16px;
            }
            
            .toast {
                bottom: 16px;
                right: 16px;
                left: 16px;
                min-width: auto;
                max-width: none;
            }
            
            .sidebar {
                width: 100%;
                z-index: 2000;
            }
            
            .sidebar-header {
                padding: 16px 20px;
            }
            
            .sidebar-nav {
                padding: 16px 0;
            }
            
            .nav-item {
                padding: 12px 20px;
                font-size: 13px;
            }
            
            .sidebar-footer {
                padding: 16px 20px;
            }
            
            .user-profile {
                padding: 10px;
            }
            
            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .user-info h4 {
                font-size: 12px;
            }
            
            .user-info p {
                font-size: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .main-header h1 {
                font-size: 20px;
            }
            
            .main-header p {
                font-size: 12px;
            }
            
            .tab-btn span:last-child {
                display: none;
            }
            
            .tab-btn {
                min-width: 60px;
                padding: 10px 8px;
            }
            
            .form-input, .form-select {
                padding: 12px 14px;
                font-size: 14px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 13px;
            }
            
            .card-title {
                font-size: 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .table-header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .search-container {
                width: 100%;
            }
            
            .user-table {
                font-size: 11px;
            }
            
            .user-table th,
            .user-table td {
                padding: 8px 10px;
            }
            
            .status-badge {
                font-size: 9px;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Enterprise Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="brand-logo">
                <div class="logo-icon">⚡</div>
                <div class="brand-text">
                    <h1>FleetForce</h1>
                    <p>Command Center</p>
                </div>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <button class="nav-item active" onclick="switchTab('add-user', this)">
                    <span class="nav-icon">👤</span>
                    <span>Add User</span>
                </button>
                <button class="nav-item" onclick="switchTab('bulk-upload', this)">
                    <span class="nav-icon">📁</span>
                    <span>Bulk Import</span>
                </button>
                <button class="nav-item" onclick="switchTab('manage-users', this)">
                    <span class="nav-icon">👥</span>
                    <span>User Directory</span>
                    <span class="nav-badge" id="userCount">0</span>
                </button>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Operations</div>
                <a href="dashboard.html" class="nav-item" target="_blank">
                    <span class="nav-icon">📊</span>
                    <span>Live Dashboard</span>
                </a>
                <a href="driver.html" class="nav-item" target="_blank">
                    <span class="nav-icon">🚚</span>
                    <span>Driver Portal</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">System</div>
                <button class="nav-item" onclick="switchTab('settings', this)">
                    <span class="nav-icon">⚙️</span>
                    <span>Settings</span>
                </button>
                <button class="nav-item" onclick="exportAllUsers()">
                    <span class="nav-icon">📤</span>
                    <span>Export Data</span>
                </button>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">AD</div>
                <div class="user-info">
                    <h4>System Administrator</h4>
                    <p>Enterprise Edition</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Premium Header -->
        <header class="main-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" onclick="toggleSidebar()">☰</button>
                <h1>Enterprise User Management</h1>
                <p>Centralized driver and personnel administration</p>
            </div>
            <div class="header-right">
                <div class="connection-status" id="connectionStatus">
                    <div class="status-dot"></div>
                    <span>MongoDB Atlas Connected</span>
                </div>
                <div class="header-actions">
                    <a href="dashboard.html" class="dashboard-link" target="_blank">
                        <span>📊</span>
                        <span>Live Dashboard</span>
                    </a>
                </div>
            </div>
        </header>
        
        <!-- Content Container -->
        <div class="content-container">
            <!-- Premium Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('add-user', this)">
                    <span class="tab-icon">👤</span>
                    <span>Add User</span>
                </button>
                <button class="tab-btn" onclick="switchTab('bulk-upload', this)">
                    <span class="tab-icon">📁</span>
                    <span>Bulk Import</span>
                </button>
                <button class="tab-btn" onclick="switchTab('manage-users', this)">
                    <span class="tab-icon">👥</span>
                    <span>User Directory</span>
                </button>
                <button class="tab-btn" onclick="switchTab('settings', this)">
                    <span class="tab-icon">⚙️</span>
                    <span>System Settings</span>
                </button>
            </div>
            
            <!-- Add User Tab -->
            <div id="add-user" class="tab-content active">
                <div class="enterprise-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span>➕</span>
                            <span>Create New User Account</span>
                        </h2>
                        <p class="card-subtitle">Add drivers, dispatchers, and administrators to the fleet management system</p>
                    </div>
                    
                    <div class="card-body">
                        <form id="addUserForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Full Name *</label>
                                    <input type="text" class="form-input" id="userName" name="name" placeholder="Enter full name" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-input" id="userEmail" name="email" placeholder="user@company.com (optional)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-input" id="userPhone" name="phoneNumber" placeholder="+1 (555) 123-4567">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Role *</label>
                                    <select class="form-select" id="userRole" name="role" required>
                                        <option value="">Select user role</option>
                                        <option value="driver">Driver</option>
                                        <option value="dispatcher">Dispatcher</option>
                                        <option value="admin">Administrator</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Vehicle ID</label>
                                    <input type="text" class="form-input" id="userVehicle" name="vehicleId" placeholder="e.g., TRUCK-001 (for drivers)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Account Status</label>
                                    <select class="form-select" id="userStatus" name="status">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 32px;">
                                <button type="button" class="btn btn-secondary" onclick="clearForm()">
                                    <span class="btn-icon">🗑️</span>
                                    <span>Clear Form</span>
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <span class="btn-icon">➕</span>
                                    <span>Create User</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Bulk Upload Tab -->
            <div id="bulk-upload" class="tab-content">
                <div class="enterprise-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span>📁</span>
                            <span>Bulk User Import</span>
                        </h2>
                        <p class="card-subtitle">Import multiple users from CSV, Excel, or Google Sheets with advanced validation</p>
                    </div>
                    
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">📤</div>
                            <div class="upload-text">Drag & Drop Your File Here</div>
                            <div class="upload-subtext">
                                Supports CSV, Excel (.xlsx/.xls), or Google Sheets export<br>
                                Maximum file size: 10MB • Up to 1,000 users per batch
                            </div>
                            <br>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                <span class="btn-icon">📁</span>
                                <span>Choose File</span>
                            </button>
                            <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(this)">
                        </div>
                        
                        <div class="template-section">
                            <div class="template-card" onclick="downloadTemplate('csv')">
                                <div class="template-icon">📄</div>
                                <div class="template-title">CSV Template</div>
                                <div class="template-description">Download CSV format template</div>
                            </div>
                            <div class="template-card" onclick="downloadTemplate('excel')">
                                <div class="template-icon">📊</div>
                                <div class="template-title">Excel Template</div>
                                <div class="template-description">Download Excel format template</div>
                            </div>
                            <div class="template-card" onclick="openGoogleSheetsGuide()">
                                <div class="template-icon">📋</div>
                                <div class="template-title">Google Sheets</div>
                                <div class="template-description">View integration guide</div>
                            </div>
                        </div>
                        
                        <div id="uploadPreview" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: var(--text-primary); font-size: 16px; font-weight: 600;">Data Preview</h3>
                            <div id="previewContainer" style="background: var(--bg-elevated); border: 1px solid var(--border-primary); border-radius: 12px; padding: 16px; margin-bottom: 16px; overflow-x: auto;"></div>
                            <div style="display: flex; gap: 16px; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="cancelUpload()">
                                    <span class="btn-icon">❌</span>
                                    <span>Cancel</span>
                                </button>
                                <button class="btn btn-success" onclick="confirmUpload()">
                                    <span class="btn-icon">✅</span>
                                    <span>Import Users</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Manage Users Tab -->
            <div id="manage-users" class="tab-content">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">
                            <span>👥</span>
                            <span>User Directory</span>
                        </h2>
                        <div class="search-container">
                            <span class="search-icon">🔍</span>
                            <input type="text" class="search-input" id="userSearch" placeholder="Search users by name, email, role..." onkeyup="filterUsers()">
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Contact</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Vehicle</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                <tr>
                                    <td colspan="7">
                                        <div class="empty-state">
                                            <div class="loading-spinner"></div>
                                            <div class="empty-title">Loading users...</div>
                                            <div class="empty-description">Connecting to MongoDB Atlas database</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="settings-grid">
                    <!-- Push Notifications Settings -->
                    <div class="settings-card">
                        <h3 class="settings-title">
                            <span>🔔</span>
                            <span>Push Notifications</span>
                        </h3>
                        
                        <div style="display: grid; gap: 16px;">
                            <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                                Get instant notifications when drivers update their status. Notifications work even when your browser is closed!
                            </p>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
                                <span style="font-weight: 500;">Notification Status</span>
                                <span class="status-badge" id="notificationStatus">Checking...</span>
                            </div>
                            
                            <div id="notificationActions" style="display: grid; gap: 12px;">
                                <button class="btn btn-primary" onclick="enablePushNotifications()" id="enableBtn" style="width: 100%; justify-content: center;">
                                    <span class="btn-icon">🔔</span>
                                    <span>Enable Push Notifications</span>
                                </button>
                                
                                <button class="btn btn-secondary" onclick="testPushNotification()" id="testBtn" style="width: 100%; justify-content: center;" disabled>
                                    <span class="btn-icon">🧪</span>
                                    <span>Send Test Notification</span>
                                </button>
                                
                                <button class="btn btn-danger" onclick="disablePushNotifications()" id="disableBtn" style="width: 100%; justify-content: center; display: none;">
                                    <span class="btn-icon">🔕</span>
                                    <span>Disable Notifications</span>
                                </button>
                            </div>
                            
                            <div id="notificationHelp" style="padding: 16px; background: rgba(14, 165, 233, 0.08); border: 1px solid rgba(14, 165, 233, 0.2); border-radius: 12px; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                                <strong style="color: var(--text-primary);">💡 How it works:</strong><br>
                                1. Click "Enable Push Notifications"<br>
                                2. Allow notifications when your browser asks<br>
                                3. You'll automatically receive alerts when drivers update their status<br>
                                4. Notifications work even when this page is closed!
                            </div>
                            
                            <div id="currentUserId" style="display: none;">admin-user-123</div>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <h3 class="settings-title">
                            <span>⚙️</span>
                            <span>System Configuration</span>
                        </h3>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Auto-refresh Dashboard</label>
                                <select class="form-select" id="autoRefresh">
                                    <option value="30">Every 30 seconds</option>
                                    <option value="60">Every minute</option>
                                    <option value="300">Every 5 minutes</option>
                                    <option value="0">Disabled</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Default User Role</label>
                                <select class="form-select" id="defaultRole">
                                    <option value="driver">Driver</option>
                                    <option value="dispatcher">Dispatcher</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 24px;">
                            <button class="btn btn-secondary" onclick="resetSettings()">
                                <span class="btn-icon">🔄</span>
                                <span>Reset</span>
                            </button>
                            <button class="btn btn-primary" onclick="saveSettings()">
                                <span class="btn-icon">💾</span>
                                <span>Save Settings</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <h3 class="settings-title">
                            <span>📊</span>
                            <span>Data Management</span>
                        </h3>
                        
                        <div style="display: grid; gap: 16px;">
                            <button class="btn btn-secondary" onclick="exportAllUsers()" style="width: 100%; justify-content: center;">
                                <span class="btn-icon">📤</span>
                                <span>Export All Users</span>
                            </button>
                            <button class="btn btn-secondary" onclick="backupData()" style="width: 100%; justify-content: center;">
                                <span class="btn-icon">💾</span>
                                <span>Backup Database</span>
                            </button>
                            <button class="btn btn-secondary" onclick="syncWithDatabase()" style="width: 100%; justify-content: center;">
                                <span class="btn-icon">🔄</span>
                                <span>Sync with MongoDB</span>
                            </button>
                            <button class="btn btn-danger" onclick="confirmClearAllData()" style="width: 100%; justify-content: center;">
                                <span class="btn-icon">🗑️</span>
                                <span>Clear All Data</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <h3 class="settings-title">
                            <span>🔗</span>
                            <span>Integration Status</span>
                        </h3>
                        
                        <div style="display: grid; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
                                <span>MongoDB Atlas</span>
                                <span class="status-badge status-active">Connected</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
                                <span>Railway.app</span>
                                <span class="status-badge status-active">Deployed</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
                                <span>Live Dashboard</span>
                                <span class="status-badge status-active">Synced</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
                                <span>Driver Portal</span>
                                <span class="status-badge status-active">Online</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
                                <span>Push Notifications</span>
                                <span class="status-badge status-active">Ready</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span>✏️</span>
                    <span>Edit User Account</span>
                </h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-input" id="editUserName" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="editUserEmail">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="editUserPhone">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Role *</label>
                            <select class="form-select" id="editUserRole" required>
                                <option value="driver">Driver</option>
                                <option value="dispatcher">Dispatcher</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Vehicle ID</label>
                            <input type="text" class="form-input" id="editUserVehicle">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editUserStatus">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveUserChanges()">
                    <span class="btn-icon">💾</span>
                    <span>Save Changes</span>
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Your real VAPID public key for push notifications
        const VAPID_PUBLIC_KEY = 'BN3-pI2_z9rnLgHR2NowqM4yawWFlF-9wP2Gx8QzG9PnV1kdw0IkK3JWptNO8fn23bkb0O7Uo1d0cdlgVx-I4Ak';
        
        // Global Variables
        let allUsers = [];
        let uploadedData = [];
        let currentEditId = null;
        
        // Initialize - Enhanced for MongoDB Atlas & Railway
        document.addEventListener('DOMContentLoaded', function() {
            console.log('FleetForce Enterprise Command Center - MongoDB Atlas & Railway Integration');
            console.log('Environment: Railway.app deployment with MongoDB Atlas backend');
            
            // Check environment and connectivity
            checkEnvironment();
            
            // Load users from MongoDB
            loadUsers();
            
            // Setup integrations
            setupDragAndDrop();
            loadSettings();
            syncWithDashboard();
            
            // Initialize push notification status
            updateNotificationStatus();
            
            // Auto-sync every minute for Railway deployment
            setInterval(() => {
                console.log('Auto-sync check...');
                loadUsers();
            }, 60000);
            
            // Add connection status indicator
            updateConnectionStatus();
        });
        
        // PUSH NOTIFICATION FUNCTIONS
        
        // Enable push notifications for current user
        async function enablePushNotifications() {
            try {
                // Check browser support
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                    showToast('Not Supported', 'Push notifications are not supported in this browser', 'error');
                    return;
                }
                
                // Update button state
                document.getElementById('enableBtn').disabled = true;
                document.getElementById('enableBtn').innerHTML = '<span class="loading-spinner"></span><span>Setting up...</span>';
                
                // Register service worker
                console.log('Registering service worker...');
                const registration = await navigator.serviceWorker.register('/sw.js');
                console.log('Service Worker registered:', registration);
                
                // Request notification permission
                console.log('Requesting notification permission...');
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    throw new Error('Notification permission denied');
                }
                
                // Subscribe to push notifications
                console.log('Subscribing to push notifications...');
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                console.log('Push subscription successful:', subscription);
                
                // Get current user ID
                const currentUserId = getCurrentUserId();
                
                // Send subscription to server
                console.log('Sending subscription to server...');
                const response = await fetch('/api/notifications/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUserId,
                        subscription: {
                            endpoint: subscription.endpoint,
                            keys: {
                                p256dh: arrayBufferToBase64(subscription.getKey('p256dh')),
                                auth: arrayBufferToBase64(subscription.getKey('auth'))
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save subscription to server');
                }
                
                // Update UI
                updateNotificationStatus();
                showToast('Notifications Enabled!', 'You will now receive push notifications when drivers update their status', 'success');
                
            } catch (error) {
                console.error('Failed to enable push notifications:', error);
                showToast('Setup Failed', `Error: ${error.message}`, 'error');
                
                // Reset button
                document.getElementById('enableBtn').disabled = false;
                document.getElementById('enableBtn').innerHTML = '<span class="btn-icon">🔔</span><span>Enable Push Notifications</span>';
            }
        }
        
        // Send test push notification
        async function testPushNotification() {
            try {
                document.getElementById('testBtn').disabled = true;
                document.getElementById('testBtn').innerHTML = '<span class="loading-spinner"></span><span>Sending...</span>';
                
                const response = await fetch('/api/notifications/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    showToast('Test Sent!', 'Check for the notification popup!', 'success');
                } else {
                    throw new Error('Failed to send test notification');
                }
                
            } catch (error) {
                console.error('Test notification failed:', error);
                showToast('Test Failed', `Error: ${error.message}`, 'error');
            } finally {
                // Reset button
                setTimeout(() => {
                    document.getElementById('testBtn').disabled = false;
                    document.getElementById('testBtn').innerHTML = '<span class="btn-icon">🧪</span><span>Send Test Notification</span>';
                }, 2000);
            }
        }
        
        // Disable push notifications
        async function disablePushNotifications() {
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                
                if (subscription) {
                    await subscription.unsubscribe();
                }
                
                // You could also call your server to remove the subscription
                updateNotificationStatus();
                showToast('Notifications Disabled', 'Push notifications have been turned off', 'info');
                
            } catch (error) {
                console.error('Failed to disable notifications:', error);
                showToast('Error', 'Failed to disable notifications', 'error');
            }
        }
        
        // Update notification status display
        function updateNotificationStatus() {
            const statusEl = document.getElementById('notificationStatus');
            const enableBtn = document.getElementById('enableBtn');
            const testBtn = document.getElementById('testBtn');
            const disableBtn = document.getElementById('disableBtn');
            
            if (!statusEl) return;
            
            if (!('Notification' in window)) {
                statusEl.textContent = 'Not Supported';
                statusEl.className = 'status-badge status-inactive';
                enableBtn.style.display = 'none';
                return;
            }
            
            switch (Notification.permission) {
                case 'granted':
                    statusEl.textContent = 'Enabled';
                    statusEl.className = 'status-badge status-active';
                    enableBtn.style.display = 'none';
                    testBtn.disabled = false;
                    disableBtn.style.display = 'block';
                    break;
                case 'denied':
                    statusEl.textContent = 'Blocked';
                    statusEl.className = 'status-badge status-inactive';
                    enableBtn.innerHTML = '<span class="btn-icon">🔄</span><span>Unblock in Browser Settings</span>';
                    enableBtn.disabled = true;
                    break;
                default:
                    statusEl.textContent = 'Not Enabled';
                    statusEl.className = 'status-badge status-inactive';
                    enableBtn.style.display = 'block';
                    testBtn.disabled = true;
                    disableBtn.style.display = 'none';
            }
        }
        
        // Get current user ID - you'll need to implement this based on your auth system
        function getCurrentUserId() {
            // For now, return a placeholder ID
            // In a real app, you'd get this from your authentication system
            const userIdEl = document.getElementById('currentUserId');
            if (userIdEl) {
                return userIdEl.textContent;
            }
            return 'admin-user-' + Date.now(); // Temporary fallback
        }
        
        // Utility functions for push notifications
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
        
        // Environment check for Railway deployment
        async function checkEnvironment() {
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    const health = await response.json();
                    console.log('Health check:', health);
                    showToast('Environment', 'Connected to Railway backend with MongoDB Atlas', 'success');
                } else {
                    console.warn('Health check failed:', response.status);
                    showToast('Warning', 'Backend connection issues detected', 'warning');
                }
            } catch (error) {
                console.error('Environment check failed:', error);
                showToast('Error', 'Cannot connect to Railway backend', 'error');
            }
        }
        
        // User Management - Enhanced for MongoDB Atlas & Railway integration
        async function loadUsers() {
            try {
                console.log('Loading users from MongoDB Atlas via Railway...');
                
                // Primary API call to Railway backend
                const response = await fetch('/api/users', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    // Handle different response formats from Railway
                    let users = [];
                    if (Array.isArray(data)) {
                        users = data;
                    } else if (data.users) {
                        users = data.users;
                    } else if (data.data) {
                        users = data.data;
                    } else if (data.result) {
                        users = data.result;
                    }
                    
                    console.log(`Loaded ${users.length} users from MongoDB Atlas`);
                    allUsers = users;
                    
                    // Cache for offline mode
                    localStorage.setItem('fleetforce_users', JSON.stringify(users));
                    sessionStorage.setItem('fleetforce_users', JSON.stringify(users));
                    sessionStorage.setItem('fleetforce_last_sync', new Date().toISOString());
                    
                    displayUsers(allUsers);
                    updateUserCount();
                    syncUserData();
                    
                    showToast('Database Connected', `Loaded ${users.length} users from MongoDB Atlas`, 'success');
                    
                } else {
                    console.warn(`API returned ${response.status}: ${response.statusText}`);
                    throw new Error(`API Error: ${response.status} - ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('Error loading users from MongoDB:', error);
                showToast('Connection Error', 'Failed to connect to MongoDB Atlas. Using cached data.', 'warning');
                
                // Fallback to cached data
                try {
                    const cachedUsers = localStorage.getItem('fleetforce_users');
                    if (cachedUsers) {
                        allUsers = JSON.parse(cachedUsers);
                        displayUsers(allUsers);
                        updateUserCount();
                        console.log(`Using cached data: ${allUsers.length} users`);
                        
                        showToast('Offline Mode', `Using cached data (${allUsers.length} users). Check internet connection.`, 'info');
                    } else {
                        // No cached data available
                        allUsers = [];
                        displayUsers(allUsers);
                        updateUserCount();
                        showToast('No Data', 'No users found. Database connection required.', 'error');
                    }
                } catch (cacheError) {
                    console.error('Error loading cached data:', cacheError);
                    allUsers = [];
                    displayUsers(allUsers);
                    updateUserCount();
                }
            }
        }
        
        function updateUserCount() {
            const userCountEl = document.getElementById('userCount');
            if (userCountEl) {
                userCountEl.textContent = allUsers.length;
            }
        }
        
        function displayUsers(users) {
            const tbody = document.getElementById('userTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-icon">👥</div>
                                <div class="empty-title">No users found</div>
                                <div class="empty-description">
                                    Add your first user using the "Add User" tab or import users in bulk
                                    <br><br>
                                    <button class="btn btn-primary" onclick="switchTab('add-user', document.querySelector('.nav-item'))">
                                        <span class="btn-icon">➕</span>
                                        <span>Add First User</span>
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: var(--gradient-primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">
                                ${user.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">${user.name}</div>
                                <div style="font-size: 12px; color: var(--text-tertiary);">ID: ${user._id}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            <div style="font-weight: 500;">${user.email || 'No email provided'}</div>
                            ${user.phoneNumber ? `<div style="font-size: 12px; color: var(--text-tertiary);">${user.phoneNumber}</div>` : ''}
                        </div>
                    </td>
                    <td><span class="status-badge role-${user.role}">${user.role}</span></td>
                    <td><span class="status-badge ${user.active !== false ? 'status-active' : 'status-inactive'}">${user.active !== false ? 'Active' : 'Inactive'}</span></td>
                    <td>${user.vehicleId || '-'}</td>
                    <td>${new Date(user.createdAt || Date.now()).toLocaleDateString()}</td>
                    <td>
                        <div class="user-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editUser('${user._id || user.email}')">
                                <span class="btn-icon">✏️</span>
                                <span>Edit</span>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser('${user._id || user.email}')">
                                <span class="btn-icon">🗑️</span>
                                <span>Delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.name.toLowerCase().includes(search) ||
                (user.email && user.email.toLowerCase().includes(search)) ||
                user.role.toLowerCase().includes(search) ||
                (user.vehicleId && user.vehicleId.toLowerCase().includes(search))
            );
            displayUsers(filtered);
        }
        
        // Tab Management
        function switchTab(tabId, buttonElement) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons and nav items
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab and activate button
            document.getElementById(tabId).classList.add('active');
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
            
            // Find and activate corresponding nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.onclick && item.onclick.toString().includes(tabId)) {
                    item.classList.add('active');
                }
            });
            
            // Find and activate corresponding tab button
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(tabId)) {
                    btn.classList.add('active');
                }
            });
            
            // Load users when switching to manage tab
            if (tabId === 'manage-users') {
                loadUsers();
            }
        }
        
        // Add User Form - Enhanced MongoDB Atlas integration
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const userData = {
                name: formData.get('name'),
                email: formData.get('email'),
                phoneNumber: formData.get('phoneNumber'),
                role: formData.get('role'),
                vehicleId: formData.get('vehicleId'),
                active: formData.get('status') === 'active',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Validate required fields
            if (!userData.name || !userData.role) {
                showToast('Validation Error', 'Please fill in all required fields (Name and Role)', 'error');
                return;
            }
            
            // Check for duplicate email only if email is provided
            if (userData.email && allUsers.some(user => user.email === userData.email)) {
                showToast('Duplicate Email', 'A user with this email already exists', 'error');
                return;
            }
            
            try {
                showToast('Creating User', 'Saving to MongoDB Atlas...', 'info');
                
                // Save to MongoDB via Railway API
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('User created in MongoDB:', result);
                    
                    // Use the returned user data (includes MongoDB _id)
                    const savedUser = result.user || result.data || result;
                    
                    // Add to local array with MongoDB _id
                    allUsers.push(savedUser);
                    saveUsersToStorage();
                    updateUserCount();
                    syncUserData();
                    
                    clearForm();
                    showToast('Success', `User created successfully in MongoDB (ID: ${savedUser._id})`, 'success');
                    
                    // Switch to manage users tab
                    switchTab('manage-users', null);
                    
                } else {
                    const errorResult = await response.json().catch(() => ({}));
                    throw new Error(errorResult.message || errorResult.error || `HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error adding user to MongoDB:', error);
                showToast('Database Error', `Failed to save to MongoDB: ${error.message}`, 'error');
                
                // For offline capability, still add to local storage with temporary ID
                const tempUser = {
                    ...userData,
                    _id: 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    _isLocal: true // Flag for local-only users
                };
                
                allUsers.push(tempUser);
                saveUsersToStorage();
                updateUserCount();
                syncUserData();
                
                clearForm();
                showToast('Offline Mode', 'User saved locally. Will sync to MongoDB when connection is restored.', 'warning');
                
                // Switch to manage users tab
                switchTab('manage-users', null);
            }
        });
        
        function clearForm() {
            document.getElementById('addUserForm').reset();
        }
        
        // Edit User Functions
        function editUser(userId) {
            const user = allUsers.find(u => u._id === userId || u.email === userId);
            if (!user) return;
            
            currentEditId = userId;
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserPhone').value = user.phoneNumber || '';
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserVehicle').value = user.vehicleId || '';
            document.getElementById('editUserStatus').value = user.active !== false ? 'active' : 'inactive';
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditId = null;
        }
        
        async function saveUserChanges() {
            if (!currentEditId) return;
            
            const userIndex = allUsers.findIndex(u => u._id === currentEditId || u.email === currentEditId);
            if (userIndex === -1) return;
            
            const updatedUser = {
                ...allUsers[userIndex],
                name: document.getElementById('editUserName').value,
                email: document.getElementById('editUserEmail').value,
                phoneNumber: document.getElementById('editUserPhone').value,
                role: document.getElementById('editUserRole').value,
                vehicleId: document.getElementById('editUserVehicle').value,
                active: document.getElementById('editUserStatus').value === 'active',
                updatedAt: new Date().toISOString()
            };
            
            try {
                showToast('Updating User', 'Saving changes to MongoDB...', 'info');
                
                // Update in MongoDB via Railway API
                const response = await fetch(`/api/users/${currentEditId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(updatedUser)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('User updated in MongoDB:', result);
                    
                    // Update local array
                    allUsers[userIndex] = updatedUser;
                    saveUsersToStorage();
                    syncUserData();
                    
                    closeEditModal();
                    displayUsers(allUsers);
                    showToast('Success', 'User updated successfully in MongoDB', 'success');
                    
                } else {
                    const errorResult = await response.json().catch(() => ({}));
                    throw new Error(errorResult.message || errorResult.error || `HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error updating user in MongoDB:', error);
                showToast('Database Error', `Failed to update in MongoDB: ${error.message}`, 'error');
                
                // For offline capability, still update locally
                allUsers[userIndex] = updatedUser;
                allUsers[userIndex]._isLocalUpdate = true; // Flag for pending sync
                saveUsersToStorage();
                syncUserData();
                
                closeEditModal();
                displayUsers(allUsers);
                showToast('Offline Mode', 'User updated locally. Will sync to MongoDB when connection is restored.', 'warning');
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
            
            try {
                showToast('Deleting User', 'Removing from MongoDB...', 'info');
                
                // Delete from MongoDB via Railway API
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log('User deleted from MongoDB');
                    
                    // Remove from local array
                    allUsers = allUsers.filter(u => u._id !== userId && u.email !== userId);
                    saveUsersToStorage();
                    updateUserCount();
                    syncUserData();
                    
                    displayUsers(allUsers);
                    showToast('Success', 'User deleted successfully from MongoDB', 'success');
                    
                } else {
                    const errorResult = await response.json().catch(() => ({}));
                    throw new Error(errorResult.message || errorResult.error || `HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error deleting user from MongoDB:', error);
                showToast('Database Error', `Failed to delete from MongoDB: ${error.message}`, 'error');
                
                // For offline capability, mark as deleted locally
                const userIndex = allUsers.findIndex(u => u._id === userId || u.email === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex]._isDeleted = true; // Flag for pending deletion
                    allUsers[userIndex]._deletedAt = new Date().toISOString();
                    saveUsersToStorage();
                    syncUserData();
                    
                    displayUsers(allUsers.filter(u => !u._isDeleted)); // Hide deleted users
                    updateUserCount();
                    showToast('Offline Mode', 'User marked for deletion. Will sync to MongoDB when connection is restored.', 'warning');
                }
            }
        }
        
        // Bulk Upload Functions
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({ files: files });
                }
            });
        }
        
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            
            const validTypes = [
                'text/csv',
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            ];
            
            if (!validTypes.includes(file.type) && !file.name.match(/\.(csv|xlsx|xls)$/i)) {
                showToast('Invalid File', 'Please select a CSV or Excel file', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showToast('File Too Large', 'File size must be less than 10MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.match(/\.csv$/i)) {
                        parseCSV(e.target.result);
                    } else {
                        parseExcel(e.target.result);
                    }
                } catch (error) {
                    console.error('Error parsing file:', error);
                    showToast('Parse Error', 'Failed to parse file. Please check the format.', 'error');
                }
            };
            
            if (file.name.match(/\.csv$/i)) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                showToast('Invalid CSV', 'CSV must have at least a header row and one data row', 'error');
                return;
            }
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, index) => {
                    row[header.toLowerCase()] = values[index] || '';
                });
                data.push(row);
            }
            
            processUploadData(data);
        }
        
        function parseExcel(arrayBuffer) {
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet);
            
            // Convert keys to lowercase for consistency
            const processedData = data.map(row => {
                const newRow = {};
                Object.keys(row).forEach(key => {
                    newRow[key.toLowerCase().trim()] = row[key];
                });
                return newRow;
            });
            
            processUploadData(processedData);
        }
        
        function processUploadData(data) {
            if (data.length === 0) {
                showToast('Empty File', 'No data found in the file', 'error');
                return;
            }
            
            // Map common column variations
            const columnMap = {
                'name': ['name', 'full name', 'fullname', 'username', 'user name'],
                'email': ['email', 'email address', 'e-mail'],
                'phoneNumber': ['phone', 'phone number', 'phonenumber', 'mobile', 'cell'],
                'role': ['role', 'user role', 'type', 'position'],
                'vehicleId': ['vehicle', 'vehicle id', 'vehicleid', 'truck', 'truck id']
            };
            
            uploadedData = data.map(row => {
                const mappedRow = {};
                
                Object.keys(columnMap).forEach(standardKey => {
                    const possibleKeys = columnMap[standardKey];
                    const foundKey = possibleKeys.find(key => 
                        Object.keys(row).some(rowKey => 
                            rowKey.toLowerCase() === key.toLowerCase()
                        )
                    );
                    
                    if (foundKey) {
                        const actualKey = Object.keys(row).find(rowKey => 
                            rowKey.toLowerCase() === foundKey.toLowerCase()
                        );
                        mappedRow[standardKey] = row[actualKey];
                    }
                });
                
                // Set defaults
                mappedRow.role = mappedRow.role || 'driver';
                mappedRow.active = true;
                mappedRow.createdAt = new Date().toISOString();
                mappedRow.updatedAt = new Date().toISOString();
                
                return mappedRow;
            }).filter(row => row.name); // Filter out rows without name (email now optional)
            
            if (uploadedData.length === 0) {
                showToast('No Valid Data', 'No valid user records found. Please check your file format.', 'error');
                return;
            }
            
            showUploadPreview(uploadedData);
        }
        
        function showUploadPreview(data) {
            const preview = document.getElementById('uploadPreview');
            const container = document.getElementById('previewContainer');
            
            const table = `
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="background: var(--bg-tertiary);">
                            <th style="padding: 12px; border: 1px solid var(--border-primary); text-align: left; font-weight: 700; color: var(--text-secondary);">Name</th>
                            <th style="padding: 12px; border: 1px solid var(--border-primary); text-align: left; font-weight: 700; color: var(--text-secondary);">Email</th>
                            <th style="padding: 12px; border: 1px solid var(--border-primary); text-align: left; font-weight: 700; color: var(--text-secondary);">Role</th>
                            <th style="padding: 12px; border: 1px solid var(--border-primary); text-align: left; font-weight: 700; color: var(--text-secondary);">Phone</th>
                            <th style="padding: 12px; border: 1px solid var(--border-primary); text-align: left; font-weight: 700; color: var(--text-secondary);">Vehicle</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.slice(0, 10).map(user => `
                            <tr>
                                <td style="padding: 12px; border: 1px solid var(--border-primary); color: var(--text-primary);">${user.name || '-'}</td>
                                <td style="padding: 12px; border: 1px solid var(--border-primary); color: var(--text-primary);">${user.email || '-'}</td>
                                <td style="padding: 12px; border: 1px solid var(--border-primary);"><span class="status-badge role-${user.role || 'driver'}">${user.role || 'driver'}</span></td>
                                <td style="padding: 12px; border: 1px solid var(--border-primary); color: var(--text-secondary);">${user.phoneNumber || '-'}</td>
                                <td style="padding: 12px; border: 1px solid var(--border-primary); color: var(--text-secondary);">${user.vehicleId || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="margin-top: 16px; color: var(--text-secondary); font-size: 13px; text-align: center;">
                    Showing first 10 of ${data.length} users. ${data.length > 10 ? `${data.length - 10} more users will be uploaded.` : ''}
                </p>
            `;
            
            container.innerHTML = table;
            preview.style.display = 'block';
        }
        
        function cancelUpload() {
            document.getElementById('uploadPreview').style.display = 'none';
            uploadedData = [];
            document.getElementById('fileInput').value = '';
        }
        
        async function confirmUpload() {
            if (uploadedData.length === 0) return;
            
            try {
                showToast('Bulk Upload', `Starting upload of ${uploadedData.length} users to MongoDB...`, 'info');
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // Upload users in batches for better performance
                const batchSize = 5;
                for (let i = 0; i < uploadedData.length; i += batchSize) {
                    const batch = uploadedData.slice(i, i + batchSize);
                    
                    const batchPromises = batch.map(async (userData) => {
                        // Check for duplicate email in existing users (only if email provided)
                        if (userData.email && allUsers.some(user => user.email === userData.email)) {
                            errorCount++;
                            errors.push(`Duplicate email: ${userData.email}`);
                            return null;
                        }
                        
                        try {
                            // Save to MongoDB via Railway API
                            const response = await fetch('/api/users', {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                body: JSON.stringify(userData)
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                const savedUser = result.user || result.data || result;
                                
                                // Add to local array with MongoDB _id
                                allUsers.push(savedUser);
                                successCount++;
                                return savedUser;
                                
                            } else {
                                const errorResult = await response.json().catch(() => ({}));
                                throw new Error(errorResult.message || errorResult.error || `HTTP ${response.status}`);
                            }
                            
                        } catch (error) {
                            console.error('Error uploading user:', userData.name, error);
                            errorCount++;
                            errors.push(`${userData.name}: ${error.message}`);
                            
                            // For offline capability, add with temporary ID
                            const tempUser = {
                                ...userData,
                                _id: 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                _isLocal: true
                            };
                            allUsers.push(tempUser);
                            return tempUser;
                        }
                    });
                    
                    // Wait for current batch to complete before starting next
                    await Promise.all(batchPromises);
                    
                    // Show progress for large uploads
                    if (uploadedData.length > 10) {
                        const progress = Math.min(i + batchSize, uploadedData.length);
                        showToast('Upload Progress', `Processed ${progress}/${uploadedData.length} users...`, 'info');
                    }
                }
                
                saveUsersToStorage();
                updateUserCount();
                syncUserData();
                
                cancelUpload();
                
                // Show detailed results
                if (successCount > 0 && errorCount === 0) {
                    showToast('Upload Complete', `Successfully uploaded ${successCount} users to MongoDB Atlas`, 'success');
                } else if (successCount > 0 && errorCount > 0) {
                    showToast('Upload Partial', `${successCount} users uploaded, ${errorCount} failed. Check console for details.`, 'warning');
                    console.log('Upload errors:', errors);
                } else {
                    showToast('Upload Failed', `Failed to upload users to MongoDB. ${errorCount} errors occurred.`, 'error');
                    console.log('Upload errors:', errors);
                }
                
                // Switch to manage users tab
                switchTab('manage-users', null);
                
            } catch (error) {
                console.error('Bulk upload error:', error);
                showToast('Upload Error', `Bulk upload failed: ${error.message}`, 'error');
            }
        }
        
        // Template Downloads
        function downloadTemplate(type) {
            const templateData = [
                {
                    'Name': 'John Doe',
                    'Email': 'john.doe@company.com',
                    'Phone Number': '+1-555-0123',
                    'Role': 'driver',
                    'Vehicle ID': 'TRUCK001'
                },
                {
                    'Name': 'Jane Smith',
                    'Email': 'jane.smith@company.com',
                    'Phone Number': '+1-555-0124',
                    'Role': 'dispatcher',
                    'Vehicle ID': ''
                },
                {
                    'Name': 'Bob Johnson',
                    'Email': 'bob.johnson@company.com',
                    'Phone Number': '+1-555-0125',
                    'Role': 'admin',
                    'Vehicle ID': ''
                }
            ];
            
            if (type === 'csv') {
                const csv = [
                    Object.keys(templateData[0]).join(','),
                    ...templateData.map(row => Object.values(row).map(v => `"${v}"`).join(','))
                ].join('\n');
                
                downloadFile(csv, 'fleetforce-users-template.csv', 'text/csv');
            } else {
                const ws = XLSX.utils.json_to_sheet(templateData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Users');
                XLSX.writeFile(wb, 'fleetforce-users-template.xlsx');
            }
            
            showToast('Template Downloaded', `${type.toUpperCase()} template ready for use`, 'success');
        }
        
        function openGoogleSheetsGuide() {
            const guide = `
FleetForce Google Sheets Integration Guide:

1. Create a new Google Sheet
2. Add these column headers in row 1:
   - Name
   - Email
   - Phone Number
   - Role (driver/dispatcher/admin)
   - Vehicle ID

3. Fill in your user data
4. Export as CSV: File > Download > CSV
5. Upload the CSV file using the bulk import tool

Example Data:
Name          | Email                    | Phone Number | Role       | Vehicle ID
John Doe      | john.doe@company.com     | 555-0123     | driver     | TRUCK001
Jane Smith    | jane.smith@company.com   | 555-0124     | dispatcher |
Bob Johnson   | bob.johnson@company.com  | 555-0125     | admin      |

Tips:
- Email addresses must be unique
- Supported roles: driver, dispatcher, admin
- Vehicle ID is optional (mainly for drivers)
- Phone numbers are optional but recommended
            `;
            
            alert(guide);
        }
        
        // Settings Management
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('fleetforce_settings') || '{}');
            
            if (settings.autoRefresh) {
                document.getElementById('autoRefresh').value = settings.autoRefresh;
            }
            if (settings.defaultRole) {
                document.getElementById('defaultRole').value = settings.defaultRole;
            }
        }
        
        function saveSettings() {
            const settings = {
                autoRefresh: document.getElementById('autoRefresh').value,
                defaultRole: document.getElementById('defaultRole').value
            };
            
            localStorage.setItem('fleetforce_settings', JSON.stringify(settings));
            showToast('Settings Saved', 'System settings have been saved successfully', 'success');
        }
        
        function resetSettings() {
            localStorage.removeItem('fleetforce_settings');
            loadSettings();
            showToast('Settings Reset', 'Settings have been reset to defaults', 'success');
        }
        
        // Data Management
        function exportAllUsers() {
            if (allUsers.length === 0) {
                showToast('No Data', 'No users to export', 'error');
                return;
            }
            
            const csv = [
                ['Name', 'Email', 'Phone', 'Role', 'Vehicle ID', 'Status', 'Created'].join(','),
                ...allUsers.map(user => [
                    `"${user.name}"`,
                    `"${user.email}"`,
                    `"${user.phoneNumber || ''}"`,
                    `"${user.role}"`,
                    `"${user.vehicleId || ''}"`,
                    `"${user.active !== false ? 'Active' : 'Inactive'}"`,
                    `"${new Date(user.createdAt || Date.now()).toLocaleDateString()}"`
                ].join(','))
            ].join('\n');
            
            downloadFile(csv, `fleetforce-users-export-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            showToast('Export Complete', `Exported ${allUsers.length} users`, 'success');
        }
        
        function backupData() {
            const backup = {
                users: allUsers,
                timestamp: new Date().toISOString(),
                version: '2.0',
                system: 'FleetForce Enterprise'
            };
            
            const backupJson = JSON.stringify(backup, null, 2);
            downloadFile(backupJson, `fleetforce-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            showToast('Backup Created', 'Database backup downloaded successfully', 'success');
        }
        
        function syncWithDatabase() {
            showToast('Syncing', 'Refreshing data from MongoDB Atlas...', 'info');
            loadUsers();
        }
        
        function confirmClearAllData() {
            if (confirm('⚠️ WARNING: This will permanently delete ALL user data from MongoDB Atlas.\n\nThis action cannot be undone. Are you absolutely sure?')) {
                if (confirm('Type "DELETE ALL DATA" to confirm this destructive action:') && prompt('Type "DELETE ALL DATA" to confirm:') === 'DELETE ALL DATA') {
                    clearAllData();
                }
            }
        }
        
        async function clearAllData() {
            try {
                showToast('Clearing Data', 'Deleting all users from MongoDB...', 'warning');
                
                // Clear from MongoDB (if API supports bulk delete)
                const response = await fetch('/api/users/bulk-delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).catch(() => null);
                
                // Clear local storage regardless
                allUsers = [];
                saveUsersToStorage();
                updateUserCount();
                syncUserData();
                displayUsers(allUsers);
                
                showToast('Data Cleared', 'All user data has been permanently deleted', 'warning');
                
            } catch (error) {
                console.error('Error clearing data:', error);
                showToast('Error', 'Failed to clear all data from database', 'error');
            }
        }
        
        // Utility Functions
        function saveUsersToStorage() {
            localStorage.setItem('fleetforce_users', JSON.stringify(allUsers));
            sessionStorage.setItem('fleetforce_users', JSON.stringify(allUsers));
            sessionStorage.setItem('fleetforce_last_sync', new Date().toISOString());
        }
        
        function syncUserData() {
            // Enhanced sync with real-time dashboard and driver app integration
            try {
                // Clean data for sync (remove local-only flags and deleted users)
                const cleanUsers = allUsers.filter(user => !user._isDeleted);
                
                console.log(`Syncing ${cleanUsers.length} users to dashboard and driver app...`);
                
                // Update storage
                localStorage.setItem('fleetforce_users', JSON.stringify(cleanUsers));
                sessionStorage.setItem('fleetforce_users', JSON.stringify(cleanUsers));
                sessionStorage.setItem('fleetforce_last_sync', new Date().toISOString());
                
                // Broadcast to dashboard.html
                try {
                    window.postMessage({
                        type: 'ADMIN_DATA_UPDATE',
                        data: cleanUsers,
                        source: 'admin_panel',
                        timestamp: new Date().toISOString()
                    }, '*');
                    
                    console.log('Data synced to dashboard.html via postMessage');
                } catch (e) {
                    console.warn('Could not sync to dashboard via postMessage:', e);
                }
                
                // Broadcast via BroadcastChannel for cross-tab communication
                try {
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('fleetforce_sync');
                        channel.postMessage({
                            type: 'ADMIN_DATA_UPDATE',
                            data: cleanUsers,
                            source: 'admin_panel',
                            timestamp: new Date().toISOString()
                        });
                        
                        console.log('Data synced via BroadcastChannel');
                        
                        // Also broadcast driver-specific data for driver.html
                        const driversOnly = cleanUsers.filter(user => user.role === 'driver' && user.active !== false);
                        channel.postMessage({
                            type: 'DRIVER_LIST_UPDATE',
                            data: driversOnly,
                            source: 'admin_panel',
                            timestamp: new Date().toISOString()
                        });
                        
                        console.log(`Synced ${driversOnly.length} drivers to driver app`);
                    }
                } catch (e) {
                    console.warn('Could not sync via BroadcastChannel:', e);
                }
                
                // Custom event for same-page communication
                try {
                    const event = new CustomEvent('fleetforce-users-updated', {
                        detail: {
                            users: cleanUsers,
                            drivers: cleanUsers.filter(user => user.role === 'driver' && user.active !== false),
                            timestamp: new Date().toISOString()
                        }
                    });
                    window.dispatchEvent(event);
                    
                    console.log('Data synced via custom event');
                } catch (e) {
                    console.warn('Could not sync via custom event:', e);
                }
                
                // For Railway deployment - also try to notify backend of data changes
                try {
                    // This would be used to trigger webhooks or real-time updates if configured
                    fetch('/api/sync/notify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'user_data_updated',
                            count: cleanUsers.length,
                            timestamp: new Date().toISOString()
                        })
                    }).catch(() => {
                        // Silent fail - this is optional
                    });
                } catch (e) {
                    // Silent fail - this is optional
                }
                
            } catch (e) {
                console.warn('Error during data sync:', e);
            }
        }
        
        function syncWithDashboard() {
            // Enhanced dashboard integration
            
            // Listen for dashboard requests
            window.addEventListener('message', function(event) {
                console.log('Received message from dashboard:', event.data);
                
                if (event.data.type === 'DASHBOARD_REQUEST_DATA') {
                    console.log('Dashboard requesting user data...');
                    syncUserData();
                }
                
                if (event.data.type === 'DASHBOARD_STATUS_UPDATE') {
                    console.log('Dashboard status update:', event.data);
                    // Could update admin panel UI with dashboard status
                }
            });
            
            // Listen for driver app requests
            window.addEventListener('message', function(event) {
                if (event.data.type === 'DRIVER_APP_REQUEST_DRIVERS') {
                    console.log('Driver app requesting driver list...');
                    const driversOnly = allUsers.filter(user => 
                        user.role === 'driver' && 
                        user.active !== false
                    );
                    
                    window.postMessage({
                        type: 'DRIVER_LIST_RESPONSE',
                        data: driversOnly,
                        source: 'admin_panel',
                        timestamp: new Date().toISOString()
                    }, '*');
                }
            });
            
            // Listen for BroadcastChannel messages (for Railway deployment)
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('fleetforce_sync');
                
                channel.addEventListener('message', function(event) {
                    console.log('BroadcastChannel message:', event.data);
                    
                    if (event.data.type === 'REQUEST_USER_SYNC' && event.data.source !== 'admin_panel') {
                        console.log('External sync request received');
                        syncUserData();
                    }
                    
                    if (event.data.type === 'NOTIFICATION_CREATED') {
                        console.log('New notification created:', event.data);
                        // Could show notification in admin panel
                        showToast('Driver Update', event.data.message || 'Driver status updated', 'info');
                    }
                });
            }
            
            // Periodic sync to ensure data consistency (important for Railway deployment)
            setInterval(() => {
                if (allUsers.length > 0) {
                    syncUserData();
                }
            }, 30000); // Sync every 30 seconds
            
            console.log('Dashboard and driver app integration initialized');
        }
        
        async function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (!statusEl) return;
            
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    statusEl.innerHTML = '<div class="status-dot"></div><span>MongoDB Atlas Connected</span>';
                    statusEl.style.background = 'rgba(16, 185, 129, 0.12)';
                    statusEl.style.color = 'var(--accent-green)';
                    statusEl.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                } else {
                    throw new Error('Backend unavailable');
                }
            } catch (error) {
                statusEl.innerHTML = '<div class="status-dot" style="background: var(--accent-red); animation: none;"></div><span>Database Offline</span>';
                statusEl.style.background = 'rgba(239, 68, 68, 0.12)';
                statusEl.style.color = 'var(--accent-red)';
                statusEl.style.borderColor = 'rgba(239, 68, 68, 0.3)';
            }
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Mobile menu toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }
        
        // Toast Notification System
        function showToast(title, message, type = 'info') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️',
                warning: '⚠️'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastSlideIn 0.4s ease reverse';
                setTimeout(() => toast.remove(), 400);
            }, 5000);
        }
        
        // Initialize connection status checking
        setInterval(updateConnectionStatus, 30000);
        
        // Check notification status every few seconds in case user changes browser settings
        setInterval(updateNotificationStatus, 5000);
        
        // Initialize the admin panel
        loadUsers();
    </script>
</body>
</html>
