<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - User Management & Inspection Reports</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 12px 24px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab-btn:hover {
            background: #f8f9fa;
        }
        .tab-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: #f8f9fa;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .hidden {
            display: none;
        }
        .login-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }
        .action-buttons .btn {
            margin: 0;
            min-width: 160px;
            font-size: 16px;
            padding: 14px 28px;
        }
        .notification-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        .notification-status {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }
        .notification-demo {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #ffeaa7;
        }
        .role-conditional {
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        .role-conditional.active {
            opacity: 1;
        }
        .users-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .user-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-item.admin {
            border-left-color: #dc3545;
        }
        .user-item.dispatcher {
            border-left-color: #ffc107;
        }
        .user-item.driver {
            border-left-color: #28a745;
        }
        .stats-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            text-align: center;
        }
        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        /* Inspection Reports Styles */
        .search-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .inspection-stats {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }
        .inspection-stat-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        .inspection-stat-item.warning {
            border-left-color: #ffc107;
        }
        .inspection-stat-item.danger {
            border-left-color: #dc3545;
        }
        .reports-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .reports-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .reports-table th {
            background: #667eea;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
        }
        .reports-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e1e5e9;
        }
        .reports-table tr:hover {
            background: #f8f9fa;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-good {
            background: #d4edda;
            color: #155724;
        }
        .status-issues {
            background: #fff3cd;
            color: #856404;
        }
        .status-critical {
            background: #f8d7da;
            color: #721c24;
        }
        .report-actions {
            display: flex;
            gap: 5px;
        }
        .report-actions button {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .maintenance-panel {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ffeaa7;
        }
        .maintenance-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .maintenance-item.urgent {
            border-left-color: #dc3545;
        }
        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .export-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 10px;
            }
            .tab-navigation {
                flex-direction: column;
            }
            .filter-grid {
                grid-template-columns: 1fr;
            }
            .reports-table {
                overflow-x: auto;
            }
            .report-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛠️ Admin Panel</h1>
            <p>User Management & Inspection Reports</p>
        </div>

        <!-- Admin Login -->
        <div class="card" id="loginCard">
            <h2>Admin Login Required</h2>
            <div class="login-section">
                <div class="form-group">
                    <label for="adminEmail">Admin Email</label>
                    <input type="text" id="adminEmail" placeholder="admin@company.com" value="admin@company.com">
                </div>
                <div class="form-group">
                    <label for="adminPassword">Admin Password</label>
                    <input type="password" id="adminPassword" placeholder="admin123!@#" value="admin123!@#">
                </div>
                <button class="btn btn-primary" onclick="adminLogin()">Login as Admin</button>
            </div>
            <div id="loginMessage"></div>
        </div>

        <!-- Main Admin Panel -->
        <div class="card hidden" id="mainAdminPanel">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="showTab('users', this)">👥 User Management</button>
                <button class="tab-btn" onclick="showTab('inspections', this)">🚛 Inspection Reports</button>
                <button class="tab-btn" onclick="showTab('maintenance', this)">🔧 Maintenance Tracker</button>
            </div>

            <!-- User Management Tab -->
            <div id="usersTab" class="tab-content">
                <h2>Create New User</h2>
                
                <div class="grid">
                    <div>
                        <div class="form-group">
                            <label for="newUsername">Username</label>
                            <input type="text" id="newUsername" placeholder="Enter username">
                        </div>
                        <div class="form-group">
                            <label for="newEmail">Email <span style="color: #666; font-size: 12px;">(optional for drivers)</span></label>
                            <input type="text" id="newEmail" placeholder="Enter email address (optional for drivers)">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="newPassword">Password <span style="color: #666; font-size: 12px;">(optional for drivers)</span></label>
                            <input type="text" id="newPassword" placeholder="Enter password (optional for drivers)">
                        </div>
                        <div class="form-group">
                            <label for="newRole">Role</label>
                            <select id="newRole" onchange="toggleNotificationSetup()">
                                <option value="driver">Driver</option>
                                <option value="dispatcher">Dispatcher</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Push Notification Setup -->
                <div class="notification-section role-conditional" id="notificationSetup">
                    <h3>🔔 Push Notification Setup</h3>
                    <p style="color: #666; margin-bottom: 15px;">Configure browser notifications for this dispatcher/admin user</p>
                    
                    <div id="notificationStatus" class="notification-status">
                        <div class="message info">Checking notification support...</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-info" onclick="checkNotificationPermission()">🔍 Check Browser Support</button>
                        <button class="btn btn-success" onclick="enableNotifications()">🔔 Enable Notifications</button>
                        <button class="btn btn-secondary" onclick="testNotification()">📱 Test Notification</button>
                    </div>
                    
                    <div class="notification-demo" id="notificationDemo">
                        <h4>📋 Notification Instructions for User:</h4>
                        <p style="margin-bottom: 10px;">When the new user logs into the dispatcher dashboard, they should:</p>
                        <ol style="margin-left: 20px; color: #666;">
                            <li>Look for the "🔔 Push Notifications" section</li>
                            <li>Click "Enable Notifications" and allow browser permissions</li>
                            <li>Test notifications to ensure they work properly</li>
                            <li>On iPhone/iPad, they'll get enhanced mobile alerts automatically</li>
                        </ol>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-success" onclick="createUser()">✅ Create User</button>
                    <button class="btn btn-info" onclick="loadUsers()">🔄 Refresh User List</button>
                </div>

                <div id="createUserMessage"></div>

                <!-- User List -->
                <div class="users-list">
                    <h3>Existing Users</h3>
                    <div id="usersList">
                        <div class="info message">Click "Refresh User List" to load users</div>
                    </div>
                </div>
            </div>

            <!-- Inspection Reports Tab -->
            <div id="inspectionsTab" class="tab-content hidden">
                <h2>🚛 Vehicle Inspection Reports</h2>
                
                <!-- Search & Filter Section -->
                <div class="search-filters">
                    <h3>Search & Filter Reports</h3>
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="searchDriver">Driver Name</label>
                            <input type="text" id="searchDriver" placeholder="Search by driver name..." onchange="filterReports()">
                        </div>
                        <div class="form-group">
                            <label for="searchVehicle">Vehicle Number</label>
                            <input type="text" id="searchVehicle" placeholder="Tractor or trailer number..." onchange="filterReports()">
                        </div>
                        <div class="form-group">
                            <label for="filterStatus">Report Status</label>
                            <select id="filterStatus" onchange="filterReports()">
                                <option value="">All Reports</option>
                                <option value="good">No Issues</option>
                                <option value="issues">Minor Issues</option>
                                <option value="critical">Critical Issues</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date Range</label>
                            <div class="date-range">
                                <input type="date" id="dateFrom" onchange="filterReports()">
                                <input type="date" id="dateTo" onchange="filterReports()">
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="loadInspectionReports()">🔍 Search Reports</button>
                        <button class="btn btn-secondary" onclick="clearFilters()">🗑️ Clear Filters</button>
                    </div>
                </div>

                <!-- Inspection Statistics -->
                <div class="inspection-stats" id="inspectionStats">
                    <div class="inspection-stat-item">
                        <div class="stat-number" id="totalReports">0</div>
                        <div class="stat-label">Total Reports</div>
                    </div>
                    <div class="inspection-stat-item">
                        <div class="stat-number" id="goodReports">0</div>
                        <div class="stat-label">No Issues</div>
                    </div>
                    <div class="inspection-stat-item warning">
                        <div class="stat-number" id="issueReports">0</div>
                        <div class="stat-label">Minor Issues</div>
                    </div>
                    <div class="inspection-stat-item danger">
                        <div class="stat-number" id="criticalReports">0</div>
                        <div class="stat-label">Critical Issues</div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="export-section">
                    <h4>📊 Export & Reports</h4>
                    <button class="btn btn-info" onclick="exportReports('csv')">📄 Export to CSV</button>
                    <button class="btn btn-success" onclick="exportReports('pdf')">📑 Generate Summary PDF</button>
                    <button class="btn btn-warning" onclick="generateMaintenanceReport()">🔧 Maintenance Report</button>
                </div>

                <!-- Reports Table -->
                <div class="reports-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Driver</th>
                                <th>Tractor</th>
                                <th>Trailer</th>
                                <th>Status</th>
                                <th>Issues</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                    No inspection reports found. Click "Search Reports" to load data.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="inspectionMessage"></div>
            </div>

            <!-- Maintenance Tracker Tab -->
            <div id="maintenanceTab" class="tab-content hidden">
                <h2>🔧 Vehicle Maintenance Tracker</h2>
                <p style="color: #666; margin-bottom: 20px;">Track vehicles requiring maintenance based on inspection reports</p>
                
                <!-- Maintenance Summary -->
                <div class="inspection-stats">
                    <div class="inspection-stat-item">
                        <div class="stat-number" id="totalVehicles">0</div>
                        <div class="stat-label">Total Vehicles</div>
                    </div>
                    <div class="inspection-stat-item warning">
                        <div class="stat-number" id="maintenanceNeeded">0</div>
                        <div class="stat-label">Maintenance Needed</div>
                    </div>
                    <div class="inspection-stat-item danger">
                        <div class="stat-number" id="urgentRepairs">0</div>
                        <div class="stat-label">Urgent Repairs</div>
                    </div>
                    <div class="inspection-stat-item danger">
                        <div class="stat-number" id="outOfService">0</div>
                        <div class="stat-label">Out of Service</div>
                    </div>
                </div>

                <!-- Maintenance Items -->
                <div class="maintenance-panel">
                    <h3>⚠️ Vehicles Requiring Attention</h3>
                    <div id="maintenanceList">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            Click "Load Maintenance Data" to view vehicles requiring maintenance
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="loadMaintenanceData()">🔄 Load Maintenance Data</button>
                    <button class="btn btn-success" onclick="exportMaintenanceReport()">📊 Export Maintenance Report</button>
                </div>

                <div id="maintenanceMessage"></div>
            </div>
        </div>
    </div>

    <script>
        let authToken = null;
        let allUsers = [];
        let allInspectionReports = [];
        let filteredReports = [];

        // Notification Manager for Admin Panel
        class NotificationManager {
            static isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            }

            static async requestPermission() {
                if (this.isIOS()) {
                    return false;
                }

                if (!('Notification' in window)) {
                    return false;
                }

                if (Notification.permission === 'granted') {
                    return true;
                }

                if (Notification.permission !== 'denied') {
                    try {
                        const permission = await Notification.requestPermission();
                        return permission === 'granted';
                    } catch (error) {
                        return false;
                    }
                }

                return false;
            }

            static getPermissionStatus() {
                if (this.isIOS()) {
                    return 'ios-fallback';
                }
                if (!('Notification' in window)) {
                    return 'not-supported';
                }
                return Notification.permission;
            }

            static getBrowserInfo() {
                if (this.isIOS()) {
                    return 'iPhone/iPad Safari';
                }
                const userAgent = navigator.userAgent;
                if (userAgent.includes('Safari')) return 'Safari Desktop';
                if (userAgent.includes('Chrome')) return 'Chrome';
                if (userAgent.includes('Firefox')) return 'Firefox';
                if (userAgent.includes('Edge')) return 'Edge';
                return 'Unknown';
            }

            static sendTestNotification() {
                if (this.isIOS()) {
                    this.sendIOSAlert();
                    return;
                }

                if (Notification.permission === 'granted') {
                    try {
                        const notification = new Notification('🚚 Admin Panel Test', {
                            body: 'Push notifications are working correctly!',
                            tag: 'admin-test-notification',
                            requireInteraction: true
                        });

                        notification.onclick = function() {
                            window.focus();
                            notification.close();
                        };

                        setTimeout(() => notification.close(), 8000);
                        return;
                    } catch (error) {
                        console.log('Browser notification failed, using fallback');
                    }
                }

                this.sendIOSAlert();
            }

            static sendIOSAlert() {
                alert('🚚 Test Notification\n\nPush notifications are working!\n\nThe dispatcher will receive alerts like this when drivers update their status.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('adminEmail').focus();
            
            // Set default date range to last 30 days
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
        });

        async function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();

            if (!email || !password) {
                showMessage('loginMessage', 'Email and password required', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: email, password })
                });

                const data = await response.json();

                if (response.ok && data.user.role === 'admin') {
                    authToken = data.token;
                    document.getElementById('loginCard').style.display = 'none';
                    document.getElementById('mainAdminPanel').classList.remove('hidden');
                    showMessage('createUserMessage', `Welcome, ${data.user.username}!`, 'success');
                    loadUsers();
                    checkNotificationPermission();
                } else {
                    showMessage('loginMessage', 'Admin access required', 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'Connection error. Make sure your app is running.', 'error');
            }
        }

        function showTab(tabName, buttonElement) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab and activate button
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            buttonElement.classList.add('active');
            
            // Load data if needed
            if (tabName === 'inspections') {
                loadInspectionReports();
            } else if (tabName === 'maintenance') {
                loadMaintenanceData();
            }
        }

        function toggleNotificationSetup() {
            const role = document.getElementById('newRole').value;
            const notificationSetup = document.getElementById('notificationSetup');
            
            if (role === 'dispatcher' || role === 'admin') {
                notificationSetup.classList.add('active');
                checkNotificationPermission();
            } else {
                notificationSetup.classList.remove('active');
            }
        }

        function checkNotificationPermission() {
            const status = NotificationManager.getPermissionStatus();
            const browser = NotificationManager.getBrowserInfo();
            const notificationStatus = document.getElementById('notificationStatus');
            
            if (status === 'ios-fallback') {
                notificationStatus.innerHTML = `
                    <div class="message success">
                        📱 iPhone/iPad detected - Mobile alerts will be used<br>
                        <small>Dispatchers will get full-screen notifications optimized for iOS</small>
                    </div>`;
            } else if (status === 'not-supported') {
                notificationStatus.innerHTML = `
                    <div class="message info">
                        📱 Browser notifications not supported - Using mobile alerts<br>
                        <small>Dispatchers will get enhanced visual alerts and sounds</small>
                    </div>`;
            } else if (status === 'granted') {
                notificationStatus.innerHTML = `<div class="message success">✅ Browser notifications enabled! (${browser})</div>`;
            } else if (status === 'denied') {
                notificationStatus.innerHTML = `
                    <div class="message info">
                        📱 Browser notifications blocked - Mobile alerts will be used instead<br>
                        <small>Dispatchers will get full-screen alerts instead of browser notifications</small>
                    </div>`;
            } else {
                notificationStatus.innerHTML = `<div class="message info">🔔 Browser notifications available for ${browser}</div>`;
            }
        }

        async function enableNotifications() {
            const isIOS = NotificationManager.isIOS();
            
            if (isIOS) {
                showMessage('createUserMessage', '📱 iPhone/iPad detected! Mobile notifications are automatically optimized for iOS.', 'success');
                checkNotificationPermission();
                return;
            }

            const granted = await NotificationManager.requestPermission();
            checkNotificationPermission();
            
            if (granted) {
                showMessage('createUserMessage', '✅ Browser notifications enabled! Dispatchers using this browser will receive push notifications.', 'success');
            } else {
                showMessage('createUserMessage', '📱 Using mobile-optimized alerts instead. Dispatchers will still get notifications.', 'info');
            }
        }

        function testNotification() {
            console.log('Admin test notification triggered');
            
            NotificationManager.sendTestNotification();
            
            const browser = NotificationManager.getBrowserInfo();
            if (NotificationManager.isIOS()) {
                showMessage('createUserMessage', '📱 iPhone test notification sent! This is how dispatchers will be alerted.', 'success');
            } else {
                showMessage('createUserMessage', `🔔 Test notification sent! (${browser}) Dispatchers will receive similar alerts.`, 'success');
            }
        }

        async function createUser() {
            const username = document.getElementById('newUsername').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const role = document.getElementById('newRole').value;

            if (!username) {
                showMessage('createUserMessage', 'Username is required', 'error');
                return;
            }

            if (role !== 'driver') {
                if (!email || !password) {
                    showMessage('createUserMessage', 'Email and password are required for dispatchers and admins', 'error');
                    return;
                }
            }

            try {
                const userData = { username: username, role: role };
                if (email) userData.email = email;
                if (password) userData.password = password;

                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (response.ok) {
                    let message = `✅ ${role} "${username}" created successfully!`;
                    
                    if (role === 'dispatcher' || role === 'admin') {
                        message += '\n\n📋 Next Steps:\n';
                        message += '• Share login credentials with the new user\n';
                        message += '• Instruct them to enable notifications in the dashboard\n';
                        message += '• Have them test notifications to ensure they work';
                    }
                    
                    showMessage('createUserMessage', message, 'success');
                    
                    document.getElementById('newUsername').value = '';
                    document.getElementById('newEmail').value = '';
                    document.getElementById('newPassword').value = '';
                    
                    setTimeout(loadUsers, 1000);
                } else {
                    showMessage('createUserMessage', data.error || 'Failed to create user', 'error');
                }
            } catch (error) {
                showMessage('createUserMessage', 'Error creating user', 'error');
            }
        }

        async function loadUsers() {
            if (!authToken) return;

            try {
                const response = await fetch('/api/users', {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const users = await response.json();
                    allUsers = users;
                    displayUsers(allUsers);
                    updateUserStats(allUsers);
                } else {
                    showMessage('createUserMessage', '⚠️ User API not found. Please add the users.js routes to your server.', 'error');
                }
            } catch (error) {
                console.error('Load users error:', error);
                showMessage('createUserMessage', `❌ Error loading users: ${error.message}`, 'error');
            }
        }

        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="info message">No users found</div>';
                return;
            }

            const usersHTML = users.map(user => {
                const notificationIcon = (user.role === 'dispatcher' || user.role === 'admin') ? '🔔' : '';
                
                return `
                    <div class="user-item ${user.role}">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 4px;">${user.username} ${notificationIcon}</div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 4px;">${user.email}</div>
                            <span style="background: ${getRoleColor(user.role)}; color: ${getRoleTextColor(user.role)}; padding: 2px 8px; border-radius: 12px; font-size: 12px; text-transform: uppercase; font-weight: bold;">${user.role}</span>
                            ${(user.role === 'dispatcher' || user.role === 'admin') ? '<span style="margin-left: 8px; font-size: 11px; color: #666;">Push notifications enabled</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editUser('${user._id}', '${user.username}', '${user.email}', '${user.role}')" style="padding: 6px 12px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; background: #ffc107; color: #212529;">✏️ Edit</button>
                            <button onclick="deleteUser('${user._id}', '${user.username}')" style="padding: 6px 12px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; background: #dc3545; color: white;">🗑️ Delete</button>
                        </div>
                    </div>
                `;
            }).join('');

            usersList.innerHTML = usersHTML;
        }

        function getRoleColor(role) {
            switch(role) {
                case 'admin': return '#f8d7da';
                case 'dispatcher': return '#fff3cd';
                case 'driver': return '#d4edda';
                default: return '#e9ecef';
            }
        }

        function getRoleTextColor(role) {
            switch(role) {
                case 'admin': return '#721c24';
                case 'dispatcher': return '#856404';
                case 'driver': return '#155724';
                default: return '#495057';
            }
        }

        function updateUserStats(users) {
            const totalUsers = users.length;
            const totalDrivers = users.filter(u => u.role === 'driver').length;
            const totalDispatchers = users.filter(u => u.role === 'dispatcher').length;
            const totalAdmins = users.filter(u => u.role === 'admin').length;

            let statsSection = document.getElementById('userStats');
            if (!statsSection) {
                const usersList = document.getElementById('usersList');
                statsSection = document.createElement('div');
                statsSection.id = 'userStats';
                statsSection.className = 'stats-section';
                statsSection.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalDrivers">0</div>
                        <div class="stat-label">Drivers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalDispatchers">0</div>
                        <div class="stat-label">Dispatchers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalAdmins">0</div>
                        <div class="stat-label">Admins</div>
                    </div>
                `;
                usersList.parentNode.insertBefore(statsSection, usersList);
            }

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalDrivers').textContent = totalDrivers;
            document.getElementById('totalDispatchers').textContent = totalDispatchers;
            document.getElementById('totalAdmins').textContent = totalAdmins;
        }

        function editUser(id, username, email, role) {
            showTab('users', document.querySelector('.tab-btn'));
            document.getElementById('newUsername').value = username;
            document.getElementById('newEmail').value = email;
            document.getElementById('newRole').value = role;
            toggleNotificationSetup();
            showMessage('createUserMessage', `📝 Editing user "${username}". Modify the fields above and click "Create User" to update.`, 'info');
        }

        function deleteUser(userId, username) {
            if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                performDelete(userId, username);
            }
        }

        async function performDelete(userId, username) {
            if (!authToken) return;

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showMessage('createUserMessage', `✅ User "${username}" deleted successfully!`, 'success');
                    allUsers = allUsers.filter(user => user._id !== userId);
                    displayUsers(allUsers);
                    updateUserStats(allUsers);
                } else {
                    const data = await response.json();
                    showMessage('createUserMessage', data.error || 'Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showMessage('createUserMessage', 'Error deleting user. Check if /api/users endpoint exists.', 'error');
            }
        }

        // INSPECTION REPORTS FUNCTIONALITY
        async function loadInspectionReports() {
            try {
                showMessage('inspectionMessage', 'Loading inspection reports...', 'info');
                
                const response = await fetch('/api/inspections/list', {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const reports = await response.json();
                    allInspectionReports = reports;
                    filterReports();
                    updateInspectionStats();
                    showMessage('inspectionMessage', `✅ Loaded ${reports.length} inspection reports`, 'success');
                } else {
                    console.log('Inspection API not found, showing demo data');
                    loadDemoInspectionReports();
                }
            } catch (error) {
                console.error('Error loading inspection reports:', error);
                showMessage('inspectionMessage', '⚠️ Connection error - showing demo data', 'error');
                loadDemoInspectionReports();
            }
        }

        function loadDemoInspectionReports() {
            // Generate demo inspection reports
            allInspectionReports = [
                {
                    _id: 'demo1',
                    driver: 'John Smith',
                    checkInTime: new Date(Date.now() - 86400000).toISOString(),
                    tractorNumber: 'T-001',
                    trailerNumber: 'TR-105',
                    moffettNumber: 'M-025',
                    fuelLevel: 'Full',
                    safetyChecks: ['tires', 'lights', 'brakes', 'mirrors', 'horn'],
                    equipmentChecks: ['moffett', 'hydraulics', 'chains', 'tarps'],
                    repairsNeeded: 'Minor',
                    damageFound: 'Small scratch on trailer side panel',
                    status: 'issues'
                },
                {
                    _id: 'demo2',
                    driver: 'Sarah Johnson',
                    checkInTime: new Date(Date.now() - 172800000).toISOString(),
                    tractorNumber: 'T-003',
                    trailerNumber: 'TR-108',
                    moffettNumber: 'M-012',
                    fuelLevel: '3/4',
                    safetyChecks: ['tires', 'lights', 'brakes', 'mirrors', 'horn'],
                    equipmentChecks: ['moffett', 'hydraulics', 'chains', 'tarps', 'landingGear', 'fifthWheel'],
                    repairsNeeded: 'None',
                    damageFound: '',
                    status: 'good'
                },
                {
                    _id: 'demo3',
                    driver: 'Mike Davis',
                    checkInTime: new Date(Date.now() - 259200000).toISOString(),
                    tractorNumber: 'T-007',
                    trailerNumber: 'TR-201',
                    moffettNumber: 'M-018',
                    fuelLevel: '1/2',
                    safetyChecks: ['lights', 'mirrors', 'horn'],
                    equipmentChecks: ['chains', 'tarps'],
                    repairsNeeded: 'Urgent',
                    damageFound: 'Hydraulic leak detected, tire wear on front right',
                    status: 'critical'
                }
            ];
            
            filterReports();
            updateInspectionStats();
            showMessage('inspectionMessage', '📝 Showing demo inspection reports - connect to server for real data', 'info');
        }

        function filterReports() {
            const driverFilter = document.getElementById('searchDriver').value.toLowerCase();
            const vehicleFilter = document.getElementById('searchVehicle').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredReports = allInspectionReports.filter(report => {
                // Driver filter
                if (driverFilter && !report.driver.toLowerCase().includes(driverFilter)) {
                    return false;
                }
                
                // Vehicle filter
                if (vehicleFilter) {
                    const tractorMatch = report.tractorNumber && report.tractorNumber.toLowerCase().includes(vehicleFilter);
                    const trailerMatch = report.trailerNumber && report.trailerNumber.toLowerCase().includes(vehicleFilter);
                    if (!tractorMatch && !trailerMatch) {
                        return false;
                    }
                }
                
                // Status filter
                if (statusFilter && report.status !== statusFilter) {
                    return false;
                }
                
                // Date filter
                if (dateFrom || dateTo) {
                    const reportDate = new Date(report.checkInTime).toISOString().split('T')[0];
                    if (dateFrom && reportDate < dateFrom) return false;
                    if (dateTo && reportDate > dateTo) return false;
                }
                
                return true;
            });

            displayInspectionReports();
        }

        function displayInspectionReports() {
            const tbody = document.getElementById('reportsTableBody');
            
            if (filteredReports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            No inspection reports match your filters.
                        </td>
                    </tr>
                `;
                return;
            }

            const reportsHTML = filteredReports.map(report => {
                const date = new Date(report.checkInTime).toLocaleDateString();
                const statusBadge = getStatusBadge(report.status);
                const issuesText = report.damageFound || 'None reported';
                
                return `
                    <tr>
                        <td>${date}</td>
                        <td><strong>${report.driver}</strong></td>
                        <td>${report.tractorNumber || 'N/A'}</td>
                        <td>${report.trailerNumber || 'N/A'}</td>
                        <td>${statusBadge}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${issuesText}</td>
                        <td>
                            <div class="report-actions">
                                <button onclick="viewReport('${report._id}')" style="background: #17a2b8; color: white;">👁️ View</button>
                                <button onclick="downloadReport('${report._id}')" style="background: #28a745; color: white;">📄 PDF</button>
                                <button onclick="deleteReport('${report._id}')" style="background: #dc3545; color: white;">🗑️ Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = reportsHTML;
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'good':
                    return '<span class="status-badge status-good">✅ No Issues</span>';
                case 'issues':
                    return '<span class="status-badge status-issues">⚠️ Minor Issues</span>';
                case 'critical':
                    return '<span class="status-badge status-critical">🚨 Critical</span>';
                default:
                    return '<span class="status-badge status-good">✅ Good</span>';
            }
        }

        function updateInspectionStats() {
            const total = allInspectionReports.length;
            const good = allInspectionReports.filter(r => r.status === 'good').length;
            const issues = allInspectionReports.filter(r => r.status === 'issues').length;
            const critical = allInspectionReports.filter(r => r.status === 'critical').length;

            document.getElementById('totalReports').textContent = total;
            document.getElementById('goodReports').textContent = good;
            document.getElementById('issueReports').textContent = issues;
            document.getElementById('criticalReports').textContent = critical;
        }

        function clearFilters() {
            document.getElementById('searchDriver').value = '';
            document.getElementById('searchVehicle').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            filterReports();
        }

        function viewReport(reportId) {
            const report = allInspectionReports.find(r => r._id === reportId);
            if (!report) return;

            alert(`INSPECTION REPORT\n\n` +
                  `Driver: ${report.driver}\n` +
                  `Date: ${new Date(report.checkInTime).toLocaleString()}\n` +
                  `Tractor: ${report.tractorNumber}\n` +
                  `Trailer: ${report.trailerNumber}\n` +
                  `Moffett: ${report.moffettNumber}\n` +
                  `Fuel Level: ${report.fuelLevel}\n\n` +
                  `Safety Checks Passed: ${report.safetyChecks.length}\n` +
                  `Equipment Checks Passed: ${report.equipmentChecks.length}\n` +
                  `Repairs Needed: ${report.repairsNeeded}\n\n` +
                  `Issues/Damage:\n${report.damageFound || 'None reported'}`);
        }

        function downloadReport(reportId) {
            const report = allInspectionReports.find(r => r._id === reportId);
            if (!report) return;

            showMessage('inspectionMessage', `📄 Downloading inspection report for ${report.driver}...`, 'info');
            
            setTimeout(() => {
                showMessage('inspectionMessage', `✅ Report downloaded: ${report.driver}_${new Date(report.checkInTime).toISOString().slice(0,10)}.pdf`, 'success');
            }, 1000);
        }

        function deleteReport(reportId) {
            const report = allInspectionReports.find(r => r._id === reportId);
            if (!report) return;

            if (confirm(`Are you sure you want to delete the inspection report for ${report.driver}?`)) {
                allInspectionReports = allInspectionReports.filter(r => r._id !== reportId);
                filterReports();
                updateInspectionStats();
                showMessage('inspectionMessage', `✅ Inspection report deleted`, 'success');
            }
        }

        function exportReports(format) {
            if (format === 'csv') {
                exportToCSV();
            } else if (format === 'pdf') {
                generateSummaryPDF();
            }
        }

        function exportToCSV() {
            const headers = ['Date', 'Driver', 'Tractor', 'Trailer', 'Moffett', 'Fuel Level', 'Status', 'Repairs Needed', 'Issues'];
            const csvContent = [
                headers.join(','),
                ...filteredReports.map(report => [
                    new Date(report.checkInTime).toLocaleDateString(),
                    report.driver,
                    report.tractorNumber || '',
                    report.trailerNumber || '',
                    report.moffettNumber || '',
                    report.fuelLevel || '',
                    report.status || 'good',
                    report.repairsNeeded || 'None',
                    (report.damageFound || 'None').replace(/,/g, ';')
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inspection_reports_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage('inspectionMessage', '📄 CSV export downloaded successfully!', 'success');
        }

        function generateSummaryPDF() {
            showMessage('inspectionMessage', '📑 Generating summary PDF report...', 'info');
            
            setTimeout(() => {
                showMessage('inspectionMessage', '✅ Summary PDF generated and downloaded!', 'success');
            }, 2000);
        }

        function generateMaintenanceReport() {
            showMessage('inspectionMessage', '🔧 Generating maintenance report...', 'info');
            
            setTimeout(() => {
                showMessage('inspectionMessage', '✅ Maintenance report generated!', 'success');
            }, 1500);
        }

        // MAINTENANCE TRACKER FUNCTIONALITY
        async function loadMaintenanceData() {
            try {
                showMessage('maintenanceMessage', 'Loading maintenance data...', 'info');
                
                const maintenanceNeeds = processMaintenanceNeeds();
                displayMaintenanceData(maintenanceNeeds);
                updateMaintenanceStats(maintenanceNeeds);
                
                showMessage('maintenanceMessage', '✅ Maintenance data loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading maintenance data:', error);
                showMessage('maintenanceMessage', '❌ Error loading maintenance data', 'error');
            }
        }

        function processMaintenanceNeeds() {
            const vehicleIssues = {};
            
            allInspectionReports.forEach(report => {
                const vehicleKey = report.tractorNumber || report.trailerNumber || 'Unknown';
                
                if (!vehicleIssues[vehicleKey]) {
                    vehicleIssues[vehicleKey] = {
                        vehicle: vehicleKey,
                        type: report.tractorNumber ? 'Tractor' : 'Trailer',
                        lastInspection: report.checkInTime,
                        driver: report.driver,
                        issues: [],
                        priority: 'good'
                    };
                }
                
                if (report.damageFound) {
                    vehicleIssues[vehicleKey].issues.push({
                        issue: report.damageFound,
                        repairPriority: report.repairsNeeded,
                        reportDate: report.checkInTime
                    });
                    
                    if (report.repairsNeeded === 'Critical') {
                        vehicleIssues[vehicleKey].priority = 'critical';
                    } else if (report.repairsNeeded === 'Urgent' && vehicleIssues[vehicleKey].priority !== 'critical') {
                        vehicleIssues[vehicleKey].priority = 'urgent';
                    } else if (report.repairsNeeded === 'Moderate' && vehicleIssues[vehicleKey].priority === 'good') {
                        vehicleIssues[vehicleKey].priority = 'moderate';
                    }
                }
            });
            
            return Object.values(vehicleIssues).filter(vehicle => vehicle.issues.length > 0);
        }

        function displayMaintenanceData(maintenanceNeeds) {
            const container = document.getElementById('maintenanceList');
            
            if (maintenanceNeeds.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        🎉 No vehicles currently require maintenance based on inspection reports
                    </div>
                `;
                return;
            }

            const maintenanceHTML = maintenanceNeeds.map(vehicle => {
                const priorityClass = vehicle.priority === 'critical' ? 'urgent' : '';
                const priorityIcon = vehicle.priority === 'critical' ? '🚨' : vehicle.priority === 'urgent' ? '⚠️' : '🔧';
                
                return `
                    <div class="maintenance-item ${priorityClass}">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                                ${priorityIcon} ${vehicle.type}: ${vehicle.vehicle}
                            </div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 4px;">
                                Last Driver: ${vehicle.driver} | Last Inspection: ${new Date(vehicle.lastInspection).toLocaleDateString()}
                            </div>
                            <div style="color: #333; font-size: 14px;">
                                Issues: ${vehicle.issues.map(issue => issue.issue).join('; ')}
                            </div>
                            <span style="background: ${getPriorityColor(vehicle.priority)}; color: ${getPriorityTextColor(vehicle.priority)}; padding: 2px 8px; border-radius: 12px; font-size: 12px; text-transform: uppercase; font-weight: bold; margin-top: 8px; display: inline-block;">
                                ${vehicle.priority} Priority
                            </span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="scheduleRepair('${vehicle.vehicle}')" style="padding: 8px 12px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; background: #28a745; color: white;">📅 Schedule</button>
                            <button onclick="markCompleted('${vehicle.vehicle}')" style="padding: 8px 12px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; background: #17a2b8; color: white;">✅ Complete</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = maintenanceHTML;
        }

        function getPriorityColor(priority) {
            switch(priority) {
                case 'critical': return '#f8d7da';
                case 'urgent': return '#fff3cd';
                case 'moderate': return '#d4edda';
                default: return '#e9ecef';
            }
        }

        function getPriorityTextColor(priority) {
            switch(priority) {
                case 'critical': return '#721c24';
                case 'urgent': return '#856404';
                case 'moderate': return '#155724';
                default: return '#495057';
            }
        }

        function updateMaintenanceStats(maintenanceNeeds) {
            const total = new Set(allInspectionReports.map(r => r.tractorNumber || r.trailerNumber)).size;
            const needsMaintenance = maintenanceNeeds.length;
            const urgent = maintenanceNeeds.filter(v => v.priority === 'urgent').length;
            const critical = maintenanceNeeds.filter(v => v.priority === 'critical').length;

            document.getElementById('totalVehicles').textContent = total;
            document.getElementById('maintenanceNeeded').textContent = needsMaintenance;
            document.getElementById('urgentRepairs').textContent = urgent;
            document.getElementById('outOfService').textContent = critical;
        }

        function scheduleRepair(vehicleId) {
            showMessage('maintenanceMessage', `📅 Repair scheduled for vehicle ${vehicleId}`, 'success');
        }

        function markCompleted(vehicleId) {
            if (confirm(`Mark maintenance as completed for vehicle ${vehicleId}?`)) {
                showMessage('maintenanceMessage', `✅ Maintenance completed for vehicle ${vehicleId}`, 'success');
                loadMaintenanceData();
            }
        }

        function exportMaintenanceReport() {
            showMessage('maintenanceMessage', '📊 Exporting maintenance report...', 'info');
            
            setTimeout(() => {
                showMessage('maintenanceMessage', '✅ Maintenance report exported successfully!', 'success');
            }, 1500);
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="message ${type}">${message.replace(/\n/g, '<br>')}</div>`;
                
                if (type === 'success') {
                    setTimeout(() => {
                        element.innerHTML = '';
                    }, 5000);
                }
            }
        }
    </script>
</body>
</html>
