<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Driver Return System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        /* Connection Status Indicator */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        /* Environment Indicator */
        .env-indicator {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            z-index: 1000;
            background: #17a2b8;
            color: white;
        }
        
        .env-indicator.development {
            background: #ffc107;
            color: #212529;
        }
        
        .env-indicator.production {
            background: #28a745;
            color: white;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .hidden {
            display: none;
        }
        
        .login-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e1e5e9;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
            color: white;
        }
        
        .loading {
            position: relative;
            color: transparent;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            color: white;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .tab-btn {
            padding: 12px 24px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        
        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .tab-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
            box-shadow: 0 4px 15px rgba(255,255,255,0.3);
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .data-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .data-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .data-item:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .data-item.admin {
            border-left-color: #dc3545;
        }
        
        .data-item.dispatcher {
            border-left-color: #ffc107;
        }
        
        .data-item.driver {
            border-left-color: #28a745;
        }
        
        .data-item.critical {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }
        
        .data-item.issues {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
        }
        
        .data-info {
            flex: 1;
            min-width: 250px;
        }
        
        .data-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .data-actions button {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .data-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-good {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }
        
        .status-issues {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
        }
        
        .status-critical {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }
        
        .filter-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #e1e5e9;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 25px 0;
        }
        
        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            overflow-x: auto;
            margin: 25px 0;
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
            font-size: 14px;
        }
        
        .data-table tr:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            padding-left: 40px;
        }
        
        .search-box::before {
            content: '🔍';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
            font-size: 16px;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal.show .modal-container {
            transform: scale(1);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }
        
        .modal-header h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }
        
        .modal-actions .btn {
            margin: 0;
            padding: 12px 25px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .tab-navigation {
                flex-direction: column;
                gap: 8px;
            }
            
            .export-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .data-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .data-actions {
                justify-content: center;
                margin-top: 15px;
            }
            
            .connection-status, .env-indicator {
                position: relative;
                top: auto;
                right: auto;
                margin: 10px auto;
                display: block;
                text-align: center;
                width: fit-content;
            }
            
            .header {
                margin-bottom: 40px;
            }
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .debug-panel.show {
            opacity: 1;
            visibility: visible;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #333;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebug()">DEBUG</button>
    
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel">
        <div id="debugContent">
            <div>🔧 Debug Console</div>
            <div>Environment: <span id="debugEnv">unknown</span></div>
            <div>API URL: <span id="debugAPI">unknown</span></div>
            <div>Connection: <span id="debugConnection">unknown</span></div>
            <div>Last Request: <span id="debugLastRequest">none</span></div>
            <div>Errors: <span id="debugErrors">0</span></div>
        </div>
    </div>

    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status connecting">
        🟡 Connecting...
    </div>
    
    <!-- Environment Indicator -->
    <div id="envIndicator" class="env-indicator">
        ENV: Unknown
    </div>

    <div class="container">
        <div class="header">
            <h1>🛠️ Admin Panel</h1>
            <p>Driver Return System - Fleet Management Dashboard</p>
        </div>

        <!-- Admin Login -->
        <div class="card" id="loginCard">
            <h2>🔐 Admin Authentication</h2>
            <div class="login-section">
                <div class="form-group">
                    <label for="adminEmail">Admin Email</label>
                    <input type="email" id="adminEmail" placeholder="admin@company.com" value="admin@company.com">
                </div>
                <div class="form-group">
                    <label for="adminPassword">Admin Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter password" value="admin123">
                </div>
                <button class="btn btn-primary" id="loginBtn" onclick="adminLogin()">
                    🚀 Login as Admin
                </button>
                <div style="margin-top: 15px; font-size: 12px; color: #666;">
                    <p><strong>Demo Credentials:</strong> admin@company.com / admin123</p>
                    <p><strong>API Status:</strong> <span id="apiStatus">Checking...</span></p>
                </div>
            </div>
            <div id="loginMessage"></div>
        </div>

        <!-- Main Admin Panel -->
        <div class="card hidden" id="mainAdminPanel">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="showTab('dashboard', this)">📊 Dashboard</button>
                <button class="tab-btn" onclick="showTab('users', this)">👥 Users</button>
                <button class="tab-btn" onclick="showTab('inspections', this)">🚛 Inspections</button>
                <button class="tab-btn" onclick="showTab('maintenance', this)">🔧 Maintenance</button>
                <button class="tab-btn" onclick="showTab('settings', this)">⚙️ Settings</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content">
                <h2>📊 Fleet Dashboard</h2>
                
                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="dashTotalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #28a745;">
                        <div class="stat-number" id="dashActiveDrivers">0</div>
                        <div class="stat-label">Active Drivers</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #ffc107;">
                        <div class="stat-number" id="dashPendingInspections">0</div>
                        <div class="stat-label">Pending Inspections</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #dc3545;">
                        <div class="stat-number" id="dashCriticalIssues">0</div>
                        <div class="stat-label">Critical Issues</div>
                    </div>
                </div>

                <div class="grid">
                    <div>
                        <h3>🚀 Quick Actions</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="showTab('users', document.querySelector('.tab-btn:nth-child(2)'))">
                                👥 Manage Users
                            </button>
                            <button class="btn btn-success" onclick="loadInspectionReports()">
                                📋 View Reports
                            </button>
                            <button class="btn btn-info" onclick="exportSystemReport()">
                                📊 System Report
                            </button>
                            <button class="btn btn-warning" onclick="runSystemCheck()">
                                🔧 System Check
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3>📈 Recent Activity</h3>
                        <div id="recentActivity" style="margin-top: 15px;">
                            <div class="empty-state">
                                <div class="icon">📊</div>
                                <p>Loading activity feed...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dashboardMessage"></div>
            </div>

            <!-- User Management Tab -->
            <div id="usersTab" class="tab-content hidden">
                <h2>👥 User Management</h2>
                
                <div class="grid">
                    <div>
                        <h3>Create New User</h3>
                        <div class="form-group">
                            <label for="newUsername">Username *</label>
                            <input type="text" id="newUsername" placeholder="Enter username" required>
                        </div>
                        <div class="form-group">
                            <label for="newEmail">Email</label>
                            <input type="email" id="newEmail" placeholder="user@company.com">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password *</label>
                            <input type="password" id="newPassword" placeholder="Enter password" required>
                        </div>
                        <div class="form-group">
                            <label for="newRole">Role</label>
                            <select id="newRole">
                                <option value="driver">Driver</option>
                                <option value="dispatcher">Dispatcher</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button class="btn btn-success" id="createUserBtn" onclick="createUser()">
                            ✅ Create User
                        </button>
                    </div>
                    <div>
                        <h3>User Statistics</h3>
                        <div class="stats-grid" id="userStats">
                            <div class="stat-card">
                                <div class="stat-number" id="totalUsers">0</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalDrivers">0</div>
                                <div class="stat-label">Drivers</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalDispatchers">0</div>
                                <div class="stat-label">Dispatchers</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalAdmins">0</div>
                                <div class="stat-label">Admins</div>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="loadUsers()">
                            🔄 Refresh Users
                        </button>
                        <button class="btn btn-warning" onclick="exportUsers()">
                            📄 Export Users
                        </button>
                    </div>
                </div>

                <div id="userMessage"></div>

                <!-- User List -->
                <div class="data-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Active Users</h3>
                        <div class="search-box">
                            <input type="text" id="userSearch" placeholder="Search users..." style="width: 300px;">
                        </div>
                    </div>
                    <div id="usersList">
                        <div class="empty-state">
                            <div class="icon">👥</div>
                            <h3>No Users Loaded</h3>
                            <p>Click "Refresh Users" to load user data from the database</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inspection Reports Tab -->
            <div id="inspectionsTab" class="tab-content hidden">
                <h2>🚛 Vehicle Inspection Reports</h2>
                
                <!-- Search and Filter Section -->
                <div class="filter-section">
                    <h3>🔍 Search & Filter Reports</h3>
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="searchDriver">Driver Name</label>
                            <input type="text" id="searchDriver" placeholder="Search by driver...">
                        </div>
                        <div class="form-group">
                            <label for="searchVehicle">Vehicle ID</label>
                            <input type="text" id="searchVehicle" placeholder="Tractor or trailer...">
                        </div>
                        <div class="form-group">
                            <label for="filterStatus">Status</label>
                            <select id="filterStatus">
                                <option value="">All Reports</option>
                                <option value="good">✅ No Issues</option>
                                <option value="issues">⚠️ Minor Issues</option>
                                <option value="critical">🚨 Critical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateFilter">Date Range</label>
                            <select id="dateFilter">
                                <option value="">All Dates</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="loadInspectionReports()">
                            🔍 Search Reports
                        </button>
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            🗑️ Clear Filters
                        </button>
                        <button class="btn btn-success" onclick="createNewInspection()">
                            ➕ New Inspection
                        </button>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-grid" id="inspectionStats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalReports">0</div>
                        <div class="stat-label">Total Reports</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="goodReports">0</div>
                        <div class="stat-label">No Issues</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #ffc107;">
                        <div class="stat-number" id="issueReports">0</div>
                        <div class="stat-label">Minor Issues</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #dc3545;">
                        <div class="stat-number" id="criticalReports">0</div>
                        <div class="stat-label">Critical Issues</div>
                    </div>
                </div>

                <!-- Export Section -->
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%); padding: 25px; border-radius: 12px; text-align: center;">
                    <h4>📊 Export & Reports</h4>
                    <div class="export-buttons">
                        <button class="btn btn-info" onclick="exportToCSV()">📄 Export CSV</button>
                        <button class="btn btn-success" onclick="generateSummaryReport()">📑 Summary PDF</button>
                        <button class="btn btn-warning" onclick="generateMaintenanceReport()">🔧 Maintenance PDF</button>
                        <button class="btn btn-secondary" onclick="scheduleReport()">📅 Schedule Report</button>
                    </div>
                </div>

                <!-- Reports Table -->
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>📅 Date & Time</th>
                                <th>👤 Driver</th>
                                <th>🚛 Vehicle Info</th>
                                <th>📊 Status</th>
                                <th>⚠️ Issues Found</th>
                                <th>⚡ Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <tr>
                                <td colspan="6">
                                    <div class="empty-state">
                                        <div class="icon">🚛</div>
                                        <h3>No Reports Found</h3>
                                        <p>Click "Search Reports" to load inspection data from the database</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="inspectionMessage"></div>
            </div>

            <!-- Maintenance Tracker Tab -->
            <div id="maintenanceTab" class="tab-content hidden">
                <h2>🔧 Vehicle Maintenance Tracker</h2>
                
                <!-- Maintenance Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalVehicles">0</div>
                        <div class="stat-label">Total Vehicles</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #ffc107;">
                        <div class="stat-number" id="maintenanceNeeded">0</div>
                        <div class="stat-label">Needs Maintenance</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #dc3545;">
                        <div class="stat-number" id="urgentRepairs">0</div>
                        <div class="stat-label">Urgent Repairs</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #28a745;">
                        <div class="stat-number" id="scheduledMaintenance">0</div>
                        <div class="stat-label">Scheduled</div>
                    </div>
                </div>

                <div style="text-align: center; margin: 25px 0;">
                    <button class="btn btn-primary" onclick="loadMaintenanceData()">
                        🔄 Load Maintenance Data
                    </button>
                    <button class="btn btn-success" onclick="exportMaintenanceReport()">
                        📊 Export Report
                    </button>
                    <button class="btn btn-info" onclick="scheduleMaintenanceBulk()">
                        📅 Bulk Schedule
                    </button>
                    <button class="btn btn-warning" onclick="generateWorkOrders()">
                        📋 Work Orders
                    </button>
                </div>

                <!-- Maintenance List -->
                <div class="data-container">
                    <h3>⚠️ Vehicles Requiring Attention</h3>
                    <div id="maintenanceList">
                        <div class="empty-state">
                            <div class="icon">🔧</div>
                            <h3>No Maintenance Data</h3>
                            <p>Click "Load Maintenance Data" to view vehicles requiring attention</p>
                        </div>
                    </div>
                </div>

                <div id="maintenanceMessage"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content hidden">
                <h2>⚙️ System Settings</h2>
                
                <div class="grid">
                    <div>
                        <h3>🔧 System Configuration</h3>
                        <div class="form-group">
                            <label for="apiEndpoint">API Endpoint</label>
                            <input type="url" id="apiEndpoint" placeholder="https://your-api.railway.app">
                        </div>
                        <div class="form-group">
                            <label for="refreshInterval">Auto-refresh Interval (seconds)</label>
                            <input type="number" id="refreshInterval" value="30" min="10" max="300">
                        </div>
                        <div class="form-group">
                            <label for="timeoutDuration">Request Timeout (seconds)</label>
                            <input type="number" id="timeoutDuration" value="10" min="5" max="60">
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">
                            💾 Save Settings
                        </button>
                    </div>
                    <div>
                        <h3>🔐 Security</h3>
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" placeholder="Enter current password">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm new password">
                        </div>
                        <button class="btn btn-warning" onclick="changePassword()">
                            🔑 Change Password
                        </button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>🔄 System Actions</h3>
                    <div class="export-buttons">
                        <button class="btn btn-info" onclick="runSystemCheck()">
                            🔍 System Health Check
                        </button>
                        <button class="btn btn-success" onclick="exportSystemReport()">
                            📊 Export System Report
                        </button>
                        <button class="btn btn-warning" onclick="clearCache()">
                            🗑️ Clear Cache
                        </button>
                        <button class="btn btn-danger" onclick="logout()">
                            🚪 Logout
                        </button>
                    </div>
                </div>

                <div id="settingsMessage"></div>
            </div>
        </div>
    </div>

    <!-- Modal for detailed views -->
    <div class="modal" id="detailModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitle">Details</h3>
                <p id="modalSubtitle"></p>
            </div>
            <div id="modalContent">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">❌ Close</button>
                <button class="btn btn-primary" id="modalAction" onclick="handleModalAction()">✅ Action</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Configuration with Railway.app and MongoDB Atlas support
        const CONFIG = {
            // Detect environment and set API URL accordingly
            ENVIRONMENT: detectEnvironment(),
            
            // API Configuration - Railway.app URL detection
            API_BASE_URL: detectAPIBaseURL(),
            
            // MongoDB Atlas connection status
            DB_CONNECTED: false,
            DB_CONNECTION_STRING: '',
            
            // Request settings optimized for Railway.app
            REQUEST_TIMEOUT: 15000, // Increased for Railway cold starts
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000,
            
            // Auto-refresh settings
            REFRESH_INTERVAL: 30000,
            CONNECTION_CHECK_INTERVAL: 5000,
            
            // Debug settings
            DEBUG_MODE: localStorage.getItem('adminDebugMode') === 'true',
            
            // CORS settings
            CORS_ENABLED: true,
            
            // Cache settings
            CACHE_ENABLED: true,
            CACHE_DURATION: 60000, // 1 minute
            
            // Feature flags
            FEATURES: {
                OFFLINE_MODE: true,
                DEMO_DATA: true,
                PDF_EXPORT: true,
                BULK_OPERATIONS: true,
                REAL_TIME_UPDATES: false // Disable for now due to Railway WebSocket limitations
            }
        };

        // Global state management
        const AppState = {
            authToken: null,
            isAuthenticated: false,
            currentUser: null,
            connectionStatus: 'disconnected',
            lastError: null,
            errorCount: 0,
            cache: new Map(),
            
            // Data stores
            users: [],
            inspectionReports: [],
            maintenanceItems: [],
            
            // UI state
            currentTab: 'dashboard',
            isLoading: false,
            filters: {
                inspections: {},
                maintenance: {},
                users: {}
            }
        };

        // Utility Functions
        function detectEnvironment() {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'development';
            } else if (hostname.includes('railway.app') || hostname.includes('up.railway.app')) {
                return 'production';
            } else {
                return 'unknown';
            }
        }

        function detectAPIBaseURL() {
            const hostname = window.location.hostname;
            
            // Development
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3000/api';
            }
            
            // Railway.app production - try to detect from current URL
            if (hostname.includes('railway.app') || hostname.includes('up.railway.app')) {
                // If admin panel is hosted separately, you might need to hardcode your Railway API URL
                // Replace this with your actual Railway API URL
                const railwayAPIURL = 'https://driver-return-system-production.up.railway.app/api';
                return railwayAPIURL;
            }
            
            // Fallback to relative API
            return '/api';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Enhanced API Client with Railway.app optimizations
        class APIClient {
            static async request(endpoint, options = {}) {
                const url = `${CONFIG.API_BASE_URL}${endpoint}`;
                let attempt = 0;
                
                updateDebugInfo('lastRequest', `${options.method || 'GET'} ${endpoint}`);
                
                while (attempt < CONFIG.MAX_RETRIES) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), CONFIG.REQUEST_TIMEOUT);

                        const defaultOptions = {
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                // CORS headers for Railway.app
                                'Access-Control-Allow-Origin': '*',
                                ...(AppState.authToken && { 'Authorization': `Bearer ${AppState.authToken}` })
                            },
                            signal: controller.signal,
                            // Important for Railway.app CORS
                            mode: 'cors',
                            credentials: 'omit'
                        };

                        const response = await fetch(url, { ...defaultOptions, ...options });
                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            if (response.status === 401) {
                                this.handleUnauthorized();
                                throw new Error('Authentication required');
                            }
                            if (response.status === 404) {
                                throw new Error('API endpoint not found - check Railway deployment');
                            }
                            if (response.status === 500) {
                                throw new Error('Server error - check Railway logs');
                            }
                            throw new Error(`API Error: ${response.status} ${response.statusText}`);
                        }

                        let data;
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            data = await response.json();
                        } else {
                            data = await response.text();
                        }

                        this.updateConnectionStatus(true);
                        AppState.errorCount = 0; // Reset error count on success
                        return data;

                    } catch (error) {
                        attempt++;
                        AppState.errorCount++;
                        
                        updateDebugInfo('errors', AppState.errorCount);
                        
                        if (error.name === 'AbortError') {
                            console.warn(`Request timeout (attempt ${attempt}/${CONFIG.MAX_RETRIES}):`, endpoint);
                        } else {
                            console.error(`Request failed (attempt ${attempt}/${CONFIG.MAX_RETRIES}):`, error.message);
                        }
                        
                        this.updateConnectionStatus(false);
                        
                        if (attempt >= CONFIG.MAX_RETRIES) {
                            // On final failure, provide helpful error messages
                            if (error.message.includes('fetch')) {
                                throw new Error('Cannot connect to server. Check Railway deployment status.');
                            }
                            throw error;
                        }
                        
                        // Wait before retry
                        await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * attempt));
                    }
                }
            }

            static async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }

            static async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            static async put(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            }

            static async delete(endpoint) {
                return this.request(endpoint, { method: 'DELETE' });
            }

            static updateConnectionStatus(connected) {
                AppState.connectionStatus = connected ? 'connected' : 'disconnected';
                CONFIG.DB_CONNECTED = connected;
                
                const statusElement = document.getElementById('connectionStatus');
                const apiStatusElement = document.getElementById('apiStatus');
                
                if (connected) {
                    statusElement.className = 'connection-status connected';
                    statusElement.innerHTML = '🟢 Connected';
                    if (apiStatusElement) apiStatusElement.textContent = 'Connected';
                    updateDebugInfo('connection', 'Connected');
                } else {
                    statusElement.className = 'connection-status disconnected';
                    statusElement.innerHTML = '🔴 Connection Error';
                    if (apiStatusElement) apiStatusElement.textContent = 'Disconnected';
                    updateDebugInfo('connection', 'Disconnected');
                }
            }

            static handleUnauthorized() {
                AppState.authToken = null;
                AppState.isAuthenticated = false;
                localStorage.removeItem('adminToken');
                
                document.getElementById('mainAdminPanel').classList.add('hidden');
                document.getElementById('loginCard').style.display = 'block';
                showMessage('loginMessage', '⚠️ Session expired. Please login again.', 'warning');
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log('🚀 Initializing Driver Return System Admin Panel');
            console.log('Environment:', CONFIG.ENVIRONMENT);
            console.log('API URL:', CONFIG.API_BASE_URL);
            
            // Update environment indicator
            const envIndicator = document.getElementById('envIndicator');
            envIndicator.textContent = `ENV: ${CONFIG.ENVIRONMENT.toUpperCase()}`;
            envIndicator.className = `env-indicator ${CONFIG.ENVIRONMENT}`;
            
            // Update debug info
            updateDebugInfo('env', CONFIG.ENVIRONMENT);
            updateDebugInfo('api', CONFIG.API_BASE_URL);
            
            // Set up connection monitoring
            checkConnection();
            setInterval(checkConnection, CONFIG.CONNECTION_CHECK_INTERVAL);
            
            // Set up network monitoring
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            // Initialize UI
            document.getElementById('adminEmail').focus();
            setupSearchHandlers();
            
            // Check for existing auth token
            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                AppState.authToken = savedToken;
                checkAuthAndProceed();
            }
            
            // Load dashboard data if authenticated
            if (AppState.isAuthenticated) {
                loadDashboardData();
            }
            
            console.log('✅ App initialization complete');
        }

        async function checkConnection() {
            try {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = 'connection-status connecting';
                statusElement.innerHTML = '🟡 Checking...';
                
                // Try to connect to the API health endpoint
                await APIClient.get('/health');
                APIClient.updateConnectionStatus(true);
                
            } catch (error) {
                APIClient.updateConnectionStatus(false);
                console.warn('Connection check failed:', error.message);
                
                // Update API status on login page
                const apiStatusElement = document.getElementById('apiStatus');
                if (apiStatusElement) {
                    apiStatusElement.textContent = `Error: ${error.message}`;
                    apiStatusElement.style.color = '#dc3545';
                }
            }
        }

        function handleOnline() {
            showMessage('loginMessage', '🟢 Connection restored', 'success');
            checkConnection();
        }

        function handleOffline() {
            APIClient.updateConnectionStatus(false);
            showMessage('loginMessage', '🔴 Connection lost - working offline', 'warning');
        }

        function setupSearchHandlers() {
            const searchInputs = ['searchDriver', 'searchVehicle', 'userSearch'];
            const selects = ['filterStatus', 'dateFilter'];
            
            searchInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', debounce(() => {
                        if (id === 'userSearch') filterUsers();
                        else filterReports();
                    }, 300));
                }
            });
            
            selects.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        filterReports();
                    });
                }
            });
        }

        // Authentication
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();

            if (!email || !password) {
                showMessage('loginMessage', 'Please enter both email and password', 'error');
                return;
            }

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.classList.add('loading');
            loginBtn.disabled = true;

            try {
                // Try to authenticate with the API
                if (AppState.connectionStatus === 'connected') {
                    const response = await APIClient.post('/auth/admin-login', {
                        email,
                        password
                    });

                    handleSuccessfulLogin(response.token || response.accessToken, response.user);
                } else {
                    // Fallback to demo mode if connection fails
                    if (email === 'admin@company.com' && (password === 'admin123' || password === 'admin123!@#')) {
                        handleSuccessfulLogin('demo-token', {
                            email: email,
                            role: 'admin',
                            username: 'Demo Admin'
                        });
                        showMessage('loginMessage', '⚠️ Working in offline demo mode', 'warning');
                    } else {
                        throw new Error('Invalid credentials. In offline mode, use: admin@company.com / admin123');
                    }
                }
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Check if it's a demo login attempt during connection issues
                if (email === 'admin@company.com' && (password === 'admin123' || password === 'admin123!@#')) {
                    handleSuccessfulLogin('demo-token', {
                        email: email,
                        role: 'admin',
                        username: 'Demo Admin'
                    });
                    showMessage('loginMessage', '⚠️ Using demo mode due to connection issues', 'warning');
                } else {
                    showMessage('loginMessage', error.message || 'Login failed. Please check your credentials and try again.', 'error');
                }
            } finally {
                loginBtn.classList.remove('loading');
                loginBtn.disabled = false;
            }
        }

        function handleSuccessfulLogin(token, user = null) {
            AppState.authToken = token;
            AppState.isAuthenticated = true;
            AppState.currentUser = user;
            
            localStorage.setItem('adminToken', token);
            if (user) {
                localStorage.setItem('adminUser', JSON.stringify(user));
            }
            
            document.getElementById('loginCard').style.display = 'none';
            document.getElementById('mainAdminPanel').classList.remove('hidden');
            
            showMessage('dashboardMessage', '✅ Welcome to the Admin Panel! System ready.', 'success');
            
            // Load initial data
            loadDashboardData();
            loadUsers();
            
            // Set up auto-refresh if in production
            if (CONFIG.ENVIRONMENT === 'production' && AppState.connectionStatus === 'connected') {
                setInterval(refreshData, CONFIG.REFRESH_INTERVAL);
            }
        }

        async function checkAuthAndProceed() {
            try {
                const response = await APIClient.get('/auth/verify');
                const savedUser = localStorage.getItem('adminUser');
                
                handleSuccessfulLogin(AppState.authToken, savedUser ? JSON.parse(savedUser) : response.user);
            } catch (error) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                AppState.authToken = null;
                AppState.isAuthenticated = false;
            }
        }

        function logout() {
            AppState.authToken = null;
            AppState.isAuthenticated = false;
            AppState.currentUser = null;
            
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            
            document.getElementById('mainAdminPanel').classList.add('hidden');
            document.getElementById('loginCard').style.display = 'block';
            
            // Reset all data
            AppState.users = [];
            AppState.inspectionReports = [];
            AppState.maintenanceItems = [];
            AppState.cache.clear();
            
            showMessage('loginMessage', '👋 Logged out successfully', 'info');
        }

        // Tab Management
        function showTab(tabName, buttonElement) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab and activate button
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            buttonElement.classList.add('active');
            
            AppState.currentTab = tabName;
            
            // Load tab-specific data
            switch(tabName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'inspections':
                    loadInspectionReports();
                    break;
                case 'maintenance':
                    loadMaintenanceData();
                    break;
            }
        }

        // Dashboard Functions
        async function loadDashboardData() {
            try {
                showMessage('dashboardMessage', '📊 Loading dashboard data...', 'info');
                
                // Load basic stats
                if (AppState.users.length === 0) await loadUsers();
                if (AppState.inspectionReports.length === 0) await loadInspectionReports();
                if (AppState.maintenanceItems.length === 0) await loadMaintenanceData();
                
                updateDashboardStats();
                loadRecentActivity();
                
                showMessage('dashboardMessage', '✅ Dashboard loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showMessage('dashboardMessage', `❌ Error loading dashboard: ${error.message}`, 'error');
            }
        }

        function updateDashboardStats() {
            document.getElementById('dashTotalUsers').textContent = AppState.users.length;
            document.getElementById('dashActiveDrivers').textContent = 
                AppState.users.filter(u => u.role === 'driver').length;
            document.getElementById('dashPendingInspections').textContent = 
                AppState.inspectionReports.filter(r => r.status === 'issues').length;
            document.getElementById('dashCriticalIssues').textContent = 
                AppState.inspectionReports.filter(r => r.status === 'critical').length;
        }

        function loadRecentActivity() {
            const activityContainer = document.getElementById('recentActivity');
            
            const activities = [
                { type: 'user', message: 'New driver registered: John Smith', time: '2 hours ago', icon: '👤' },
                { type: 'inspection', message: 'Critical issue reported on T-007', time: '4 hours ago', icon: '🚨' },
                { type: 'maintenance', message: 'Maintenance completed on TR-105', time: '6 hours ago', icon: '✅' },
                { type: 'system', message: 'Database backup completed', time: '8 hours ago', icon: '💾' }
            ];
            
            const activityHTML = activities.map(activity => `
                <div class="data-item" style="margin-bottom: 10px; padding: 15px;">
                    <div class="data-info">
                        <div style="font-weight: 600;">${activity.icon} ${activity.message}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">${activity.time}</div>
                    </div>
                </div>
            `).join('');
            
            activityContainer.innerHTML = activityHTML;
        }

        // User Management Functions
        async function loadUsers() {
            try {
                showMessage('userMessage', '👥 Loading users...', 'info');
                
                if (AppState.connectionStatus === 'connected' && AppState.authToken !== 'demo-token') {
                    const response = await APIClient.get('/users');
                    AppState.users = response.users || response || [];
                } else {
                    // Demo data fallback
                    AppState.users = [
                        { _id: 'user1', username: 'admin', email: 'admin@company.com', role: 'admin', createdAt: new Date(Date.now() - 86400000 * 30).toISOString(), lastLogin: new Date().toISOString() },
                        { _id: 'user2', username: 'dispatcher1', email: 'dispatch@company.com', role: 'dispatcher', createdAt: new Date(Date.now() - 86400000 * 25).toISOString(), lastLogin: new Date(Date.now() - 3600000).toISOString() },
                        { _id: 'user3', username: 'John Smith', email: 'john.smith@company.com', role: 'driver', createdAt: new Date(Date.now() - 86400000 * 20).toISOString(), lastLogin: new Date(Date.now() - 7200000).toISOString() },
                        { _id: 'user4', username: 'Sarah Johnson', email: 'sarah.johnson@company.com', role: 'driver', createdAt: new Date(Date.now() - 86400000 * 15).toISOString(), lastLogin: new Date(Date.now() - 1800000).toISOString() },
                        { _id: 'user5', username: 'Mike Davis', email: 'mike.davis@company.com', role: 'driver', createdAt: new Date(Date.now() - 86400000 * 10).toISOString(), lastLogin: new Date(Date.now() - 3600000).toISOString() },
                        { _id: 'user6', username: 'Lisa Wilson', email: 'lisa.wilson@company.com', role: 'driver', createdAt: new Date(Date.now() - 86400000 * 5).toISOString(), lastLogin: new Date(Date.now() - 900000).toISOString() }
                    ];
                }
                
                displayUsers();
                updateUserStats();
                updateDashboardStats();
                showMessage('userMessage', `✅ Loaded ${AppState.users.length} users successfully`, 'success');
                
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('userMessage', `❌ Error loading users: ${error.message}`, 'error');
            }
        }

        async function createUser() {
            const username = document.getElementById('newUsername').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const role = document.getElementById('newRole').value;

            if (!username || !password) {
                showMessage('userMessage', 'Username and password are required', 'error');
                return;
            }

            // Check for duplicate usernames
            if (AppState.users.some(user => user.username.toLowerCase() === username.toLowerCase())) {
                showMessage('userMessage', 'Username already exists. Please choose a different username.', 'error');
                return;
            }

            const createBtn = document.getElementById('createUserBtn');
            createBtn.classList.add('loading');
            createBtn.disabled = true;

            try {
                const userData = {
                    username,
                    email: email || `${username.toLowerCase().replace(/\s+/g, '.')}@company.com`,
                    password,
                    role
                };

                let newUser;
                if (AppState.connectionStatus === 'connected' && AppState.authToken !== 'demo-token') {
                    const response = await APIClient.post('/users', userData);
                    newUser = response.user || response;
                } else {
                    // Demo mode
                    newUser = {
                        _id: generateId(),
                        ...userData,
                        createdAt: new Date().toISOString(),
                        lastLogin: null
                    };
                    AppState.users.push(newUser);
                }

                // Clear form
                document.getElementById('newUsername').value = '';
                document.getElementById('newEmail').value = '';
                document.getElementById('newPassword').value = '';
                
                displayUsers();
                updateUserStats();
                updateDashboardStats();
                showMessage('userMessage', `✅ ${role.charAt(0).toUpperCase() + role.slice(1)} "${username}" created successfully!`, 'success');
                
            } catch (error) {
                console.error('Error creating user:', error);
                showMessage('userMessage', `❌ Error creating user: ${error.message}`, 'error');
            } finally {
                createBtn.classList.remove('loading');
                createBtn.disabled = false;
            }
        }

        function displayUsers() {
            const usersList = document.getElementById('usersList');
            const searchTerm = document.getElementById('userSearch')?.value.toLowerCase() || '';
            
            let usersToShow = AppState.users;
            if (searchTerm) {
                usersToShow = AppState.users.filter(user => 
                    user.username.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    user.role.toLowerCase().includes(searchTerm)
                );
            }
            
            if (usersToShow.length === 0) {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">👥</div>
                        <h3>${searchTerm ? 'No matching users' : 'No users found'}</h3>
                        <p>${searchTerm ? 'Try adjusting your search terms' : 'Click "Refresh Users" to load user data'}</p>
                    </div>
                `;
                return;
            }

            const usersHTML = usersToShow.map(user => `
                <div class="data-item ${user.role}">
                    <div class="data-info">
                        <div style="font-weight: bold; font-size: 16px; margin-bottom: 6px;">${user.username}</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 8px;">${user.email}</div>
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <span class="status-badge" style="background: ${getRoleColor(user.role)}; color: ${getRoleTextColor(user.role)};">${user.role}</span>
                            ${user.createdAt ? `<span style="color: #888; font-size: 11px;">📅 ${new Date(user.createdAt).toLocaleDateString()}</span>` : ''}
                            ${user.lastLogin ? `<span style="color: #28a745; font-size: 11px;">🟢 ${formatDate(user.lastLogin)}</span>` : '<span style="color: #dc3545; font-size: 11px;">🔴 Never</span>'}
                        </div>
                    </div>
                    <div class="data-actions">
                        <button onclick="viewUser('${user._id}')" style="background: #17a2b8; color: white;">👁️ View</button>
                        <button onclick="editUser('${user._id}')" style="background: #ffc107; color: #212529;">✏️ Edit</button>
                        <button onclick="deleteUser('${user._id}', '${user.username}')" style="background: #dc3545; color: white;">🗑️ Delete</button>
                    </div>
                </div>
            `).join('');

            usersList.innerHTML = usersHTML;
        }

        function filterUsers() {
            displayUsers();
        }

        function getRoleColor(role) {
            switch(role) {
                case 'admin': return '#f8d7da';
                case 'dispatcher': return '#fff3cd';
                case 'driver': return '#d4edda';
                default: return '#e9ecef';
            }
        }

        function getRoleTextColor(role) {
            switch(role) {
                case 'admin': return '#721c24';
                case 'dispatcher': return '#856404';
                case 'driver': return '#155724';
                default: return '#495057';
            }
        }

        function updateUserStats() {
            const totalUsers = AppState.users.length;
            const totalDrivers = AppState.users.filter(u => u.role === 'driver').length;
            const totalDispatchers = AppState.users.filter(u => u.role === 'dispatcher').length;
            const totalAdmins = AppState.users.filter(u => u.role === 'admin').length;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalDrivers').textContent = totalDrivers;
            document.getElementById('totalDispatchers').textContent = totalDispatchers;
            document.getElementById('totalAdmins').textContent = totalAdmins;
        }

        function viewUser(userId) {
            const user = AppState.users.find(u => u._id === userId);
            if (!user) return;

            const modalContent = `
                <div style="text-align: left;">
                    <div class="grid" style="gap: 20px;">
                        <div>
                            <h4>👤 User Information</h4>
                            <div style="margin: 15px 0;">
                                <strong>Username:</strong> ${user.username}
                            </div>
                            <div style="margin: 15px 0;">
                                <strong>Email:</strong> ${user.email}
                            </div>
                            <div style="margin: 15px 0;">
                                <strong>Role:</strong> <span class="status-badge" style="background: ${getRoleColor(user.role)}; color: ${getRoleTextColor(user.role)};">${user.role}</span>
                            </div>
                        </div>
                        <div>
                            <h4>📊 Activity</h4>
                            ${user.createdAt ? `<div style="margin: 15px 0;"><strong>Created:</strong> ${formatDate(user.createdAt)}</div>` : ''}
                            ${user.lastLogin ? `<div style="margin: 15px 0;"><strong>Last Login:</strong> ${formatDate(user.lastLogin)}</div>` : '<div style="margin: 15px 0;"><strong>Last Login:</strong> <span style="color: #dc3545;">Never</span></div>'}
                            <div style="margin: 15px 0;">
                                <strong>Status:</strong> <span style="color: #28a745; font-weight: bold;">✅ Active</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            showModal('User Details', user.username, modalContent, 'Edit User', () => editUser(userId));
        }

        async function editUser(userId) {
            const user = AppState.users.find(u => u._id === userId);
            if (!user) return;

            const newUsername = prompt(`Edit username for ${user.username}:`, user.username);
            if (!newUsername || newUsername.trim() === user.username) return;

            const trimmedUsername = newUsername.trim();
            
            // Check for duplicates
            if (AppState.users.some(u => u._id !== userId && u.username.toLowerCase() === trimmedUsername.toLowerCase())) {
                showMessage('userMessage', 'Username already exists. Please choose a different username.', 'error');
                return;
            }

            try {
                if (AppState.connectionStatus === 'connected' && AppState.authToken !== 'demo-token') {
                    await APIClient.put(`/users/${userId}`, { username: trimmedUsername });
                }
                
                user.username = trimmedUsername;
                displayUsers();
                closeModal();
                showMessage('userMessage', `✅ User updated to "${trimmedUsername}"`, 'success');
                
            } catch (error) {
                console.error('Error updating user:', error);
                showMessage('userMessage', `❌ Error updating user: ${error.message}`, 'error');
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Delete user "${username}"?\n\nThis action cannot be undone and will remove all associated data.`)) {
                return;
            }

            try {
                if (AppState.connectionStatus === 'connected' && AppState.authToken !== 'demo-token') {
                    await APIClient.delete(`/users/${userId}`);
                }
                
                AppState.users = AppState.users.filter(user => user._id !== userId);
                displayUsers();
                updateUserStats();
                updateDashboardStats();
                showMessage('userMessage', `✅ User "${username}" deleted successfully`, 'success');
                
            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage('userMessage', `❌ Error deleting user: ${error.message}`, 'error');
            }
        }

        // Inspection Reports Functions
        async function loadInspectionReports() {
            try {
                showMessage('inspectionMessage', '🚛 Loading inspection reports...', 'info');
                
                if (AppState.connectionStatus === 'connected' && AppState.authToken !== 'demo-token') {
                    const response = await APIClient.get('/inspections');
                    AppState.inspectionReports = response.reports || response || [];
                } else {
                    // Demo data
                    AppState.inspectionReports = generateDemoInspectionData();
                }
                
                filterReports();
                updateInspectionStats();
                updateDashboardStats();
                showMessage('inspectionMessage', `✅ Loaded ${AppState.inspectionReports.length} inspection reports`, 'success');
                
            } catch (error) {
                console.error('Error loading inspection reports:', error);
                showMessage('inspectionMessage', `❌ Error loading reports: ${error.message}`, 'error');
            }
        }

        function generateDemoInspectionData() {
            const drivers = ['John Smith', 'Sarah Johnson', 'Mike Davis', 'Lisa Wilson', 'Tom Anderson', 'Emily Brown'];
            const statuses = ['good', 'issues', 'critical'];
            const tractors = ['T-001', 'T-003', 'T-007', 'T-012', 'T-015', 'T-018', 'T-021', 'T-025'];
            const trailers = ['TR-105', 'TR-108', 'TR-201', 'TR-304', 'TR-210', 'TR-150', 'TR-275', 'TR-320'];
            const locations = ['Main Depot', 'North Terminal', 'South Hub', 'East Facility', 'West Gate'];
            
            const issues = {
                good: [''],
                issues: [
                    'Minor tire wear on rear axle',
                    'Small scratch on trailer side panel',
                    'Brake pad wear, replacement recommended',
                    'Oil leak, minor maintenance required',
                    'Air filter needs replacement',
                    'Minor electrical issue with turn signals'
                ],
                critical: [
                    'Hydraulic leak detected, immediate attention required',
                    'Severe tire wear, unsafe for operation',
                    'Brake system failure, vehicle out of service',
                    'Engine overheating, transmission problems',
                    'Structural damage to trailer frame',
                    'Critical electrical system failure'
                ]
            };

            const reports = [];
            for (let i = 0; i < 30; i++) {
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const checkInTime = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                
                reports.push({
                    _id: generateId(),
                    driver: drivers[Math.floor(Math.random() * drivers.length)],
                    checkInTime: checkInTime.toISOString(),
                    tractorNumber: tractors[Math.floor(Math.random() * tractors.length)],
                    trailerNumber: trailers[Math.floor(Math.random() * trailers.length)],
                    status: status,
                    damageFound: issues[status][Math.floor(Math.random() * issues[status].length)],
                    mileage: Math.floor(Math.random() * 100000) + 50000,
                    location: locations[Math.floor(Math.random() * locations.length)],
                    inspectorNotes: status === 'critical' ? 'Immediate attention required' : status === 'issues' ? 'Schedule maintenance soon' : 'All systems operational'
                });
            }

            return reports.sort((a, b) => new Date(b.checkInTime) - new Date(a.checkInTime));
        }

        function filterReports() {
            const driverFilter = document.getElementById('searchDriver')?.value.toLowerCase() || '';
            const vehicleFilter = document.getElementById('searchVehicle')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const dateFilter = document.getElementById('dateFilter')?.value || '';

            AppState.filters.inspections = {
                driver: driverFilter,
                vehicle: vehicleFilter,
                status: statusFilter,
                date: dateFilter
            };

            const filteredReports = AppState.inspectionReports.filter(report => {
                // Driver filter
                if (driverFilter && !report.driver.toLowerCase().includes(driverFilter)) {
                    return false;
                }
                
                // Vehicle filter
                if (vehicleFilter) {
                    const tractorMatch = report.tractorNumber && report.tractorNumber.toLowerCase().includes(vehicleFilter);
                    const trailerMatch = report.trailerNumber && report.trailerNumber.toLowerCase().includes(vehicleFilter);
                    if (!tractorMatch && !trailerMatch) {
                        return false;
                    }
                }
                
                // Status filter
                if (statusFilter && report.status !== statusFilter) {
                    return false;
                }
                
                // Date filter
                if (dateFilter) {
                    const reportDate = new Date(report.checkInTime);
                    const now = new Date();
                    
                    switch(dateFilter) {
                        case 'today':
                            if (reportDate.toDateString() !== now.toDateString()) return false;
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            if (reportDate < weekAgo) return false;
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            if (reportDate < monthAgo) return false;
                            break;
                    }
                }
                
                return true;
            });

            displayInspectionReports(filteredReports);
        }

        function displayInspectionReports(reports = null) {
            const tbody = document.getElementById('reportsTableBody');
            const reportsToShow = reports || AppState.inspectionReports;
            
            if (reportsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="icon">🚛</div>
                                <h3>No inspection reports found</h3>
                                <p>No reports match your search criteria or none have been loaded yet</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const reportsHTML = reportsToShow.map(report => {
                const date = new Date(report.checkInTime).toLocaleDateString();
                const time = new Date(report.checkInTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const statusBadge = getStatusBadge(report.status);
                const issues = report.damageFound || 'None reported';
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: bold;">${date}</div>
                            <div style="font-size: 12px; color: #666;">${time}</div>
                            ${report.location ? `<div style="font-size: 11px; color: #999;">📍 ${report.location}</div>` : ''}
                        </td>
                        <td>
                            <div style="font-weight: bold;">${report.driver}</div>
                            ${report.mileage ? `<div style="font-size: 12px; color: #666;">🛣️ ${report.mileage.toLocaleString()} mi</div>` : ''}
                        </td>
                        <td>
                            <div style="font-size: 13px; color: #666;">🚛 ${report.tractorNumber || 'N/A'}</div>
                            <div style="font-size: 13px; color: #666;">📦 ${report.trailerNumber || 'N/A'}</div>
                        </td>
                        <td>${statusBadge}</td>
                        <td style="max-width: 250px;">
                            <div style="overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                ${issues}
                            </div>
                            ${report.inspectorNotes ? `<div style="font-size: 11px; color: #666; margin-top: 4px;">📝 ${report.inspectorNotes}</div>` : ''}
                        </td>
                        <td>
                            <button onclick="viewReport('${report._id}')" style="background: #17a2b8; color: white; padding: 6px 12px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 4px;">👁️ View</button>
                            <button onclick="downloadReport('${report._id}')" style="background: #28a745; color: white; padding: 6px 12px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer;">📄 Export</button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = reportsHTML;
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'good':
                    return '<span class="status-badge status-good">✅ No Issues</span>';
                case 'issues':
                    return '<span class="status-badge status-issues">⚠️ Minor Issues</span>';
                case 'critical':
                    return '<span class="status-badge status-critical">🚨 Critical</span>';
                default:
                    return '<span class="status-badge status-good">✅ Good</span>';
            }
        }

        function updateInspectionStats() {
            const total = AppState.inspectionReports.length;
            const good = AppState.inspectionReports.filter(r => r.status === 'good').length;
            const issues = AppState.inspectionReports.filter(r => r.status === 'issues').length;
            const critical = AppState.inspectionReports.filter(r => r.status === 'critical').length;

            document.getElementById('totalReports').textContent = total;
            document.getElementById('goodReports').textContent = good;
            document.getElementById('issueReports').textContent = issues;
            document.getElementById('criticalReports').textContent = critical;
        }

        function clearFilters() {
            document.getElementById('searchDriver').value = '';
            document.getElementById('searchVehicle').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('dateFilter').value = '';
            filterReports();
            showMessage('inspectionMessage', '🗑️ Search filters cleared', 'info');
        }

        function viewReport(reportId) {
            const report = AppState.inspectionReports.find(r => r._id === reportId);
            if (!report) return;

            const modalContent = `
                <div style="text-align: left;">
                    <div class="grid" style="gap: 20px;">
                        <div>
                            <h4>🚛 Vehicle Information</h4>
                            <div style="margin: 10px 0;"><strong>Tractor:</strong> ${report.tractorNumber || 'N/A'}</div>
                            <div style="margin: 10px 0;"><strong>Trailer:</strong> ${report.trailerNumber || 'N/A'}</div>
                            ${report.mileage ? `<div style="margin: 10px 0;"><strong>Mileage:</strong> ${report.mileage.toLocaleString()} mi</div>` : ''}
                            ${report.location ? `<div style="margin: 10px 0;"><strong>Location:</strong> ${report.location}</div>` : ''}
                            
                            <h4 style="margin-top: 20px;">👤 Inspection Details</h4>
                            <div style="margin: 10px 0;"><strong>Driver:</strong> ${report.driver}</div>
                            <div style="margin: 10px 0;"><strong>Date & Time:</strong> ${formatDate(report.checkInTime)}</div>
                            <div style="margin: 10px 0;"><strong>Status:</strong> ${getStatusBadge(report.status)}</div>
                        </div>
                        <div>
                            <h4>⚠️ Issues & Notes</h4>
                            <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <strong>Issues Found:</strong><br>
                                ${report.damageFound || 'No issues reported - vehicle passed inspection'}
                            </div>
                            ${report.inspectorNotes ? `
                                <div style="margin: 15px 0; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                                    <strong>Inspector Notes:</strong><br>
                                    ${report.inspectorNotes}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            showModal('Inspection Report Details', `${report.tractorNumber} / ${report.trailerNumber}`, modalContent, 'Export PDF', () => downloadReport(reportId));
        }

        // Maintenance Functions
        async function loadMaintenanceData() {
            try {
                showMessage('maintenanceMessage', '🔧 Loading maintenance data...', 'info');
                
                // Generate maintenance items from inspection reports
                const maintenanceNeeds = AppState.inspectionReports
                    .filter(r => r.status === 'issues' || r.status === 'critical')
                    .map(report => ({
                        _id: `maint_${report._id}`,
                        vehicleId: `${report.tractorNumber}/${report.trailerNumber}`,
                        tractorNumber: report.tractorNumber,
                        trailerNumber: report.trailerNumber,
                        priority: report.status === 'critical' ? 'urgent' : 'moderate',
                        issue: report.damageFound,
                        reportDate: report.checkInTime,
                        driver: report.driver,
                        status: 'pending',
                        estimatedCost: Math.floor(Math.random() * 5000) + 500,
                        scheduledDate: null
                    }));
                
                AppState.maintenanceItems = maintenanceNeeds;
                displayMaintenanceData();
                updateMaintenanceStats();
                
                showMessage('maintenanceMessage', `✅ Loaded ${maintenanceNeeds.length} maintenance items`, 'success');
                
            } catch (error) {
                console.error('Error loading maintenance data:', error);
                showMessage('maintenanceMessage', `❌ Error loading maintenance data: ${error.message}`, 'error');
            }
        }

        function displayMaintenanceData() {
            const container = document.getElementById('maintenanceList');
            
            if (AppState.maintenanceItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">🎉</div>
                        <h3>No Maintenance Required</h3>
                        <p>All vehicles are in good condition based on recent inspections</p>
                    </div>
                `;
                return;
            }

            const maintenanceHTML = AppState.maintenanceItems.map(item => {
                const priorityClass = item.priority === 'urgent' ? 'critical' : 'issues';
                const priorityIcon = item.priority === 'urgent' ? '🚨' : '⚠️';
                
                return `
                    <div class="data-item ${priorityClass}">
                        <div class="data-info">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 6px;">
                                ${priorityIcon} Vehicle: ${item.vehicleId}
                            </div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 6px;">
                                Last Driver: ${item.driver} | Date: ${new Date(item.reportDate).toLocaleDateString()}
                            </div>
                            <div style="color: #333; font-size: 14px; margin-bottom: 10px;">
                                <strong>Issues:</strong> ${item.issue}
                            </div>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <span class="status-badge" style="background: ${item.priority === 'urgent' ? '#f8d7da' : '#fff3cd'}; color: ${item.priority === 'urgent' ? '#721c24' : '#856404'};">
                                    ${item.priority.toUpperCase()} Priority
                                </span>
                                <span style="font-size: 12px; color: #666;">💰 Est. Cost: ${item.estimatedCost.toLocaleString()}</span>
                                ${item.scheduledDate ? `<span style="font-size: 12px; color: #28a745;">📅 Scheduled: ${new Date(item.scheduledDate).toLocaleDateString()}</span>` : ''}
                            </div>
                        </div>
                        <div class="data-actions">
                            <button onclick="scheduleRepair('${item._id}')" style="background: #28a745; color: white;" ${item.scheduledDate ? 'disabled' : ''}>
                                📅 ${item.scheduledDate ? 'Scheduled' : 'Schedule'}
                            </button>
                            <button onclick="markCompleted('${item._id}')" style="background: #17a2b8; color: white;">✅ Complete</button>
                            <button onclick="viewMaintenanceItem('${item._id}')" style="background: #ffc107; color: #212529;">👁️ Details</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = maintenanceHTML;
        }

        function updateMaintenanceStats() {
            const totalVehicles = new Set([
                ...AppState.inspectionReports.map(r => r.tractorNumber),
                ...AppState.inspectionReports.map(r => r.trailerNumber)
            ]).size;
            
            const maintenanceNeeded = AppState.maintenanceItems.length;
            const urgent = AppState.maintenanceItems.filter(v => v.priority === 'urgent').length;
            const scheduled = AppState.maintenanceItems.filter(v => v.scheduledDate).length;

            document.getElementById('totalVehicles').textContent = totalVehicles;
            document.getElementById('maintenanceNeeded').textContent = maintenanceNeeded;
            document.getElementById('urgentRepairs').textContent = urgent;
            document.getElementById('scheduledMaintenance').textContent = scheduled;
        }

        function scheduleRepair(itemId) {
            const item = AppState.maintenanceItems.find(i => i._id === itemId);
            if (!item) return;

            const dateInput = prompt(`Schedule repair for ${item.vehicleId}\n\nEnter date (YYYY-MM-DD):`, 
                new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
            
            if (dateInput) {
                const scheduledDate = new Date(dateInput);
                if (scheduledDate > new Date()) {
                    item.scheduledDate = scheduledDate.toISOString();
                    displayMaintenanceData();
                    updateMaintenanceStats();
                    showMessage('maintenanceMessage', `📅 Repair scheduled for ${item.vehicleId} on ${scheduledDate.toLocaleDateString()}`, 'success');
                } else {
                    showMessage('maintenanceMessage', '❌ Please select a future date', 'error');
                }
            }
        }

        function markCompleted(itemId) {
            const item = AppState.maintenanceItems.find(i => i._id === itemId);
            if (!item) return;

            if (confirm(`Mark maintenance as completed for ${item.vehicleId}?\n\nThis will remove it from the maintenance list and update the vehicle status.`)) {
                // Remove from maintenance list
                AppState.maintenanceItems = AppState.maintenanceItems.filter(i => i._id !== itemId);
                
                // Update corresponding inspection report
                const report = AppState.inspectionReports.find(r => 
                    r.tractorNumber === item.tractorNumber && r.trailerNumber === item.trailerNumber);
                if (report) {
                    report.status = 'good';
                    report.damageFound = '';
                }
                
                displayMaintenanceData();
                updateMaintenanceStats();
                updateInspectionStats();
                updateDashboardStats();
                showMessage('maintenanceMessage', `✅ Maintenance completed for ${item.vehicleId}`, 'success');
            }
        }

        function viewMaintenanceItem(itemId) {
            const item = AppState.maintenanceItems.find(i => i._id === itemId);
            if (!item) return;

            const modalContent = `
                <div style="text-align: left;">
                    <div class="grid" style="gap: 20px;">
                        <div>
                            <h4>🚛 Vehicle Information</h4>
                            <div style="margin: 10px 0;"><strong>Vehicle ID:</strong> ${item.vehicleId}</div>
                            <div style="margin: 10px 0;"><strong>Tractor:</strong> ${item.tractorNumber}</div>
                            <div style="margin: 10px 0;"><strong>Trailer:</strong> ${item.trailerNumber}</div>
                            <div style="margin: 10px 0;"><strong>Last Driver:</strong> ${item.driver}</div>
                            <div style="margin: 10px 0;"><strong>Report Date:</strong> ${formatDate(item.reportDate)}</div>
                        </div>
                        <div>
                            <h4>🔧 Maintenance Details</h4>
                            <div style="margin: 10px 0;"><strong>Priority:</strong> 
                                <span class="status-badge" style="background: ${item.priority === 'urgent' ? '#f8d7da' : '#fff3cd'}; color: ${item.priority === 'urgent' ? '#721c24' : '#856404'};">
                                    ${item.priority.toUpperCase()}
                                </span>
                            </div>
                            <div style="margin: 10px 0;"><strong>Estimated Cost:</strong> ${item.estimatedCost.toLocaleString()}</div>
                            <div style="margin: 10px 0;"><strong>Status:</strong> ${item.status}</div>
                            ${item.scheduledDate ? `<div style="margin: 10px 0;"><strong>Scheduled Date:</strong> ${formatDate(item.scheduledDate)}</div>` : ''}
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>⚠️ Issues Reported</h4>
                        <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            ${item.issue}
                        </div>
                    </div>
                </div>
            `;

            showModal('Maintenance Details', item.vehicleId, modalContent, 'Schedule Repair', () => scheduleRepair(itemId));
        }

        // Export Functions
        function exportToCSV() {
            const headers = ['Date', 'Time', 'Driver', 'Tractor', 'Trailer', 'Status', 'Issues', 'Location'];
            const csvContent = [
                headers.join(','),
                ...AppState.inspectionReports.map(report => [
                    new Date(report.checkInTime).toLocaleDateString(),
                    new Date(report.checkInTime).toLocaleTimeString(),
                    `"${report.driver}"`,
                    report.tractorNumber || '',
                    report.trailerNumber || '',
                    report.status,
                    `"${(report.damageFound || 'None').replace(/"/g, '""')}"`,
                    `"${report.location || ''}"`
                ].join(','))
            ].join('\n');

            downloadFile(csvContent, `inspection_reports_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
            showMessage('inspectionMessage', '📄 CSV export downloaded successfully!', 'success');
        }

        function exportUsers() {
            const headers = ['Username', 'Email', 'Role', 'Created', 'Last Login', 'Status'];
            const csvContent = [
                headers.join(','),
                ...AppState.users.map(user => [
                    `"${user.username}"`,
                    `"${user.email}"`,
                    user.role,
                    user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '',
                    user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never',
                    'Active'
                ].join(','))
            ].join('\n');

            downloadFile(csvContent, `users_export_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
            showMessage('userMessage', '📄 Users CSV export downloaded successfully!', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // System Functions
        async function runSystemCheck() {
            showMessage('settingsMessage', '🔍 Running system health check...', 'info');
            
            const checks = [
                { name: 'API Connection', test: () => APIClient.get('/health') },
                { name: 'Database Connection', test: () => new Promise(resolve => setTimeout(resolve, 1000)) },
                { name: 'User Authentication', test: () => AppState.isAuthenticated },
                { name: 'Data Integrity', test: () => AppState.users.length > 0 }
            ];
            
            const results = [];
            
            for (const check of checks) {
                try {
                    await check.test();
                    results.push(`✅ ${check.name}: OK`);
                } catch (error) {
                    results.push(`❌ ${check.name}: ${error.message || 'Failed'}`);
                }
            }
            
            const reportContent = `
                <div style="text-align: left;">
                    <h4>🔍 System Health Report</h4>
                    <div style="margin: 20px 0; font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        ${results.join('<br>')}
                    </div>
                    <div style="margin-top: 20px;">
                        <strong>Environment:</strong> ${CONFIG.ENVIRONMENT}<br>
                        <strong>API URL:</strong> ${CONFIG.API_BASE_URL}<br>
                        <strong>Connection Status:</strong> ${AppState.connectionStatus}<br>
                        <strong>Total Users:</strong> ${AppState.users.length}<br>
                        <strong>Total Reports:</strong> ${AppState.inspectionReports.length}<br>
                        <strong>Maintenance Items:</strong> ${AppState.maintenanceItems.length}
                    </div>
                </div>
            `;
            
            showModal('System Health Check', 'Health Report', reportContent, 'Close', closeModal);
            showMessage('settingsMessage', '✅ System health check completed', 'success');
        }

        function exportSystemReport() {
            const reportData = {
                timestamp: new Date().toISOString(),
                environment: CONFIG.ENVIRONMENT,
                api_url: CONFIG.API_BASE_URL,
                connection_status: AppState.connectionStatus,
                stats: {
                    total_users: AppState.users.length,
                    total_drivers: AppState.users.filter(u => u.role === 'driver').length,
                    total_reports: AppState.inspectionReports.length,
                    critical_issues: AppState.inspectionReports.filter(r => r.status === 'critical').length,
                    maintenance_needed: AppState.maintenanceItems.length
                },
                recent_activity: AppState.inspectionReports.slice(0, 5).map(r => ({
                    date: r.checkInTime,
                    driver: r.driver,
                    status: r.status,
                    vehicle: `${r.tractorNumber}/${r.trailerNumber}`
                }))
            };
            
            downloadFile(JSON.stringify(reportData, null, 2), 
                `system_report_${new Date().toISOString().slice(0,10)}.json`, 
                'application/json');
            
            showMessage('settingsMessage', '📊 System report exported successfully!', 'success');
        }

        function clearCache() {
            AppState.cache.clear();
            localStorage.removeItem('adminCache');
            showMessage('settingsMessage', '🗑️ Cache cleared successfully', 'success');
        }

        // Settings Functions
        function saveSettings() {
            const apiEndpoint = document.getElementById('apiEndpoint').value.trim();
            const refreshInterval = document.getElementById('refreshInterval').value;
            const timeoutDuration = document.getElementById('timeoutDuration').value;
            
            if (apiEndpoint) {
                CONFIG.API_BASE_URL = apiEndpoint;
                updateDebugInfo('api', apiEndpoint);
            }
            
            if (refreshInterval) {
                CONFIG.REFRESH_INTERVAL = parseInt(refreshInterval) * 1000;
            }
            
            if (timeoutDuration) {
                CONFIG.REQUEST_TIMEOUT = parseInt(timeoutDuration) * 1000;
            }
            
            // Save to localStorage
            localStorage.setItem('adminSettings', JSON.stringify({
                apiEndpoint: CONFIG.API_BASE_URL,
                refreshInterval: CONFIG.REFRESH_INTERVAL,
                requestTimeout: CONFIG.REQUEST_TIMEOUT
            }));
            
            showMessage('settingsMessage', '💾 Settings saved successfully', 'success');
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage('settingsMessage', 'All password fields are required', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage('settingsMessage', 'New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showMessage('settingsMessage', 'New password must be at least 6 characters long', 'error');
                return;
            }
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showMessage('settingsMessage', '🔑 Password changed successfully', 'success');
        }

        // Modal Functions
        function showModal(title, subtitle, content, actionText = 'OK', actionCallback = closeModal) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalSubtitle').textContent = subtitle;
            document.getElementById('modalContent').innerHTML = content;
            
            const actionBtn = document.getElementById('modalAction');
            actionBtn.textContent = actionText;
            actionBtn.onclick = actionCallback;
            
            document.getElementById('detailModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        function handleModalAction() {
            // This will be overridden by specific modal actions
            closeModal();
        }

        // Debug Functions
        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            const isVisible = debugPanel.classList.contains('show');
            
            if (isVisible) {
                debugPanel.classList.remove('show');
                CONFIG.DEBUG_MODE = false;
            } else {
                debugPanel.classList.add('show');
                CONFIG.DEBUG_MODE = true;
                updateAllDebugInfo();
            }
            
            localStorage.setItem('adminDebugMode', CONFIG.DEBUG_MODE.toString());
        }

        function updateDebugInfo(key, value) {
            if (!CONFIG.DEBUG_MODE) return;
            
            const element = document.getElementById(`debug${key.charAt(0).toUpperCase() + key.slice(1)}`);
            if (element) {
                element.textContent = value;
            }
        }

        function updateAllDebugInfo() {
            updateDebugInfo('env', CONFIG.ENVIRONMENT);
            updateDebugInfo('api', CONFIG.API_BASE_URL);
            updateDebugInfo('connection', AppState.connectionStatus);
            updateDebugInfo('errors', AppState.errorCount);
        }

        // Utility Functions
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            container.innerHTML = `<div class="message ${type}">${icons[type] || ''} ${message}</div>`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        async function refreshData() {
            if (!AppState.isAuthenticated) return;
            
            try {
                await Promise.all([
                    loadUsers(),
                    loadInspectionReports(),
                    loadMaintenanceData()
                ]);
                updateDashboardStats();
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        // Placeholder functions for buttons that don't have full implementations yet
        function createNewInspection() {
            showMessage('inspectionMessage', '🚛 New inspection feature coming soon!', 'info');
        }

        function scheduleReport() {
            showMessage('inspectionMessage', '📅 Report scheduling feature coming soon!', 'info');
        }

        function scheduleMaintenanceBulk() {
            showMessage('maintenanceMessage', '📅 Bulk scheduling feature coming soon!', 'info');
        }

        function generateWorkOrders() {
            showMessage('maintenanceMessage', '📋 Work order generation feature coming soon!', 'info');
        }

        function downloadReport() {
            showMessage('inspectionMessage', '📄 PDF export feature coming soon!', 'info');
        }

        function generateSummaryReport() {
            showMessage('inspectionMessage', '📑 PDF report generation feature coming soon!', 'info');
        }

        function generateMaintenanceReport() {
            showMessage('inspectionMessage', '🔧 Maintenance PDF feature coming soon!', 'info');
        }

        function exportMaintenanceReport() {
            showMessage('maintenanceMessage', '📊 Export feature coming soon!', 'info');
        }

        // Initialize debug mode if previously enabled
        if (CONFIG.DEBUG_MODE) {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    document.getElementById('debugPanel').classList.add('show');
                    updateAllDebugInfo();
                }, 1000);
            });
        }
    </script>
</body>
</html>
