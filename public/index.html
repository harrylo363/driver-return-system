<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Return System - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-color: #f3f4f6;
            --border-color: #e5e7eb;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        /* Navigation Bar */
        .nav-bar {
            background: #1f2937;
            padding: 10px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .nav-bar a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .nav-bar a:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-bar a.active {
            background: var(--primary-color);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .header-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .stat-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 0.5rem 1rem;
            background-color: var(--light-color);
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .stat-badge .count {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        main {
            padding: 2rem 0;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .stat-card-title {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .stat-card-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 1.25rem;
        }
        
        .icon-blue { background-color: #dbeafe; color: var(--primary-color); }
        .icon-green { background-color: #d1fae5; color: var(--success-color); }
        .icon-yellow { background-color: #fef3c7; color: var(--warning-color); }
        .icon-red { background-color: #fee2e2; color: var(--danger-color); }
        
        .stat-card-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .stat-card-label {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            position: relative;
            transition: color 0.2s;
        }
        
        .tab:hover {
            color: var(--primary-color);
        }
        
        .tab.active {
            color: var(--primary-color);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--primary-color);
        }
        
        .tab-content {
            padding: 1.5rem;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .list-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #f9fafb;
            border-bottom: 1px solid var(--border-color);
        }
        
        .list-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .list-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .filter-input {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .list-content {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .list-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .list-item:hover {
            background-color: #f9fafb;
        }
        
        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .list-item-title {
            font-weight: 600;
            color: #111827;
        }
        
        .list-item-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-en-route { background-color: #dbeafe; color: #1e40af; }
        .status-arrived { background-color: #d1fae5; color: #065f46; }
        .status-delayed { background-color: #fee2e2; color: #991b1b; }
        .status-completed { background-color: #e5e7eb; color: #374151; }
        
        .urgency-low { background-color: #d1fae5; color: #065f46; }
        .urgency-medium { background-color: #fef3c7; color: #92400e; }
        .urgency-high { background-color: #fed7d7; color: #991b1b; }
        .urgency-critical { background-color: #fee2e2; color: #7f1d1d; }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #111827;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background-color: var(--success-color);
        }
        
        .toast.error {
            background-color: var(--danger-color);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header-stats {
                display: none;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-bar {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <a href="index.html" class="active">📊 Main Dashboard</a>
        <a href="dashboard.html">🗺️ Dispatch Map</a>
        <a href="driver.html">🚚 Driver Portal</a>
        <a href="admin.html">🔧 Admin Panel</a>
    </nav>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span>🚚</span>
                    <span>Driver Return System</span>
                </div>
                <div class="header-stats">
                    <div class="stat-badge">
                        <span>Active Drivers:</span>
                        <span class="count" id="activeDriversCount">0</span>
                    </div>
                    <div class="stat-badge">
                        <span>Unread Alerts:</span>
                        <span class="count" id="unreadAlertsCount">0</span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <!-- Statistics Dashboard -->
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <h3 class="stat-card-title">Total Notifications</h3>
                        <div class="stat-card-icon icon-blue">📊</div>
                    </div>
                    <div class="stat-card-value" id="totalNotifications">0</div>
                    <div class="stat-card-label">All time notifications</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-header">
                        <h3 class="stat-card-title">Unread Notifications</h3>
                        <div class="stat-card-icon icon-yellow">🔔</div>
                    </div>
                    <div class="stat-card-value" id="unreadNotifications">0</div>
                    <div class="stat-card-label">Requires attention</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-header">
                        <h3 class="stat-card-title">Total Inspections</h3>
                        <div class="stat-card-icon icon-green">📋</div>
                    </div>
                    <div class="stat-card-value" id="totalInspections">0</div>
                    <div class="stat-card-label">Vehicle inspections</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-header">
                        <h3 class="stat-card-title">Critical Issues</h3>
                        <div class="stat-card-icon icon-red">⚠️</div>
                    </div>
                    <div class="stat-card-value" id="criticalIssues">0</div>
                    <div class="stat-card-label">Urgent repairs needed</div>
                </div>
            </div>
            
            <!-- Main Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('notifications')">
                        🔔 Notifications
                    </button>
                    <button class="tab" onclick="switchTab('inspections')">
                        📋 Inspections
                    </button>
                    <button class="tab" onclick="switchTab('new-notification')">
                        ➕ New Notification
                    </button>
                    <button class="tab" onclick="switchTab('new-inspection')">
                        📝 New Inspection
                    </button>
                </div>
                
                <!-- Notifications Tab -->
                <div id="notifications" class="tab-content active">
                    <div class="list-header">
                        <h2 class="list-title">Recent Notifications</h2>
                        <div class="list-actions">
                            <input type="text" class="filter-input" placeholder="Filter by driver..." 
                                   onkeyup="filterNotifications(this.value)">
                            <button class="btn btn-primary" onclick="loadNotifications()">
                                🔄 Refresh
                            </button>
                        </div>
                    </div>
                    <div class="list-content" id="notificationsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">📭</div>
                            <p>No notifications yet</p>
                        </div>
                    </div>
                </div>
                
                <!-- Inspections Tab -->
                <div id="inspections" class="tab-content">
                    <div class="list-header">
                        <h2 class="list-title">Recent Inspections</h2>
                        <div class="list-actions">
                            <input type="text" class="filter-input" placeholder="Filter by driver..." 
                                   onkeyup="filterInspections(this.value)">
                            <button class="btn btn-primary" onclick="loadInspections()">
                                🔄 Refresh
                            </button>
                        </div>
                    </div>
                    <div class="list-content" id="inspectionsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p>No inspections yet</p>
                        </div>
                    </div>
                </div>
                
                <!-- New Notification Form -->
                <div id="new-notification" class="tab-content">
                    <h2 style="margin-bottom: 1.5rem;">Create New Notification</h2>
                    <form id="notificationForm" onsubmit="submitNotification(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="driver">Driver Name *</label>
                                <input type="text" id="driver" name="driver" class="form-control" 
                                       placeholder="Enter driver name" required>
                            </div>
                            <div class="form-group">
                                <label for="status">Status *</label>
                                <select id="status" name="status" class="form-control" required>
                                    <option value="">Select status</option>
                                    <option value="en-route">En Route</option>
                                    <option value="arrived">Arrived</option>
                                    <option value="delayed">Delayed</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="location">Current Location *</label>
                                <input type="text" id="location" name="location" class="form-control" 
                                       placeholder="e.g., Highway 101 North" required>
                            </div>
                            <div class="form-group">
                                <label for="warehouse">Warehouse *</label>
                                <input type="text" id="warehouse" name="warehouse" class="form-control" 
                                       placeholder="e.g., Miami Distribution Center" required>
                            </div>
                            <div class="form-group">
                                <label for="estimatedArrival">Estimated Arrival</label>
                                <input type="text" id="estimatedArrival" name="estimatedArrival" 
                                       class="form-control" placeholder="e.g., 30 minutes">
                            </div>
                            <div class="form-group">
                                <label for="priority">Priority</label>
                                <select id="priority" name="priority" class="form-control">
                                    <option value="normal">Normal</option>
                                    <option value="low">Low</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <textarea id="notes" name="notes" class="form-control" 
                                      placeholder="Additional information..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span>📤</span>
                            <span>Submit Notification</span>
                        </button>
                    </form>
                </div>
                
                <!-- New Inspection Form -->
                <div id="new-inspection" class="tab-content">
                    <h2 style="margin-bottom: 1.5rem;">Create New Inspection Report</h2>
                    <form id="inspectionForm" onsubmit="submitInspection(event)">
                        <h3 style="margin-bottom: 1rem; color: #374151;">Driver & Vehicle Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="inspDriver">Driver Name *</label>
                                <input type="text" id="inspDriver" name="driver" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="tractorNumber">Tractor Number *</label>
                                <input type="text" id="tractorNumber" name="tractorNumber" 
                                       class="form-control" placeholder="e.g., TR-001" required>
                            </div>
                            <div class="form-group">
                                <label for="trailerNumber">Trailer Number *</label>
                                <input type="text" id="trailerNumber" name="trailerNumber" 
                                       class="form-control" placeholder="e.g., TL-001" required>
                            </div>
                            <div class="form-group">
                                <label for="moffettNumber">Moffett Number</label>
                                <input type="text" id="moffettNumber" name="moffettNumber" 
                                       class="form-control" placeholder="e.g., MF-001">
                            </div>
                            <div class="form-group">
                                <label for="odometerReading">Odometer Reading *</label>
                                <input type="number" id="odometerReading" name="odometerReading" 
                                       class="form-control" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="fuelLevel">Fuel Level *</label>
                                <select id="fuelLevel" name="fuelLevel" class="form-control" required>
                                    <option value="">Select fuel level</option>
                                    <option value="empty">Empty</option>
                                    <option value="1/4">1/4 Tank</option>
                                    <option value="1/2">1/2 Tank</option>
                                    <option value="3/4">3/4 Tank</option>
                                    <option value="full">Full</option>
                                </select>
                            </div>
                        </div>
                        
                        <h3 style="margin: 1.5rem 0 1rem; color: #374151;">Inspection & Issues</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="damageFound">Damage Found</label>
                                <textarea id="damageFound" name="damageFound" class="form-control" 
                                          placeholder="Describe any damage found..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="repairsNeeded">Repairs Needed</label>
                                <textarea id="repairsNeeded" name="repairsNeeded" class="form-control" 
                                          placeholder="List required repairs..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="urgencyLevel">Urgency Level</label>
                                <select id="urgencyLevel" name="urgencyLevel" class="form-control">
                                    <option value="low">Low - Can wait</option>
                                    <option value="medium">Medium - Schedule soon</option>
                                    <option value="high">High - Priority</option>
                                    <option value="critical">Critical - Immediate</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deliveryNotes">Delivery Notes</label>
                                <textarea id="deliveryNotes" name="deliveryNotes" class="form-control" 
                                          placeholder="Any delivery-related notes..."></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="additionalComments">Additional Comments</label>
                            <textarea id="additionalComments" name="additionalComments" 
                                      class="form-control" rows="3" 
                                      placeholder="Any other observations or comments..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            <span>📝</span>
                            <span>Submit Inspection</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>
    
    <div id="toast" class="toast"></div>
    
    <script>
        // API base URL - will work for both local and production
        const API_URL = '/api';
        let currentTab = 'notifications';
        let notificationsCache = [];
        let inspectionsCache = [];
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we need to switch to a specific tab
            const activeTab = sessionStorage.getItem('activeTab');
            if (activeTab) {
                // Switch to the requested tab
                setTimeout(() => {
                    // Find the tab button and click it
                    const tabButtons = document.querySelectorAll('.tab');
                    const tabMap = {
                        'notifications': 0,
                        'inspections': 1,
                        'new-notification': 2,
                        'new-inspection': 3
                    };
                    
                    if (tabMap[activeTab] !== undefined && tabButtons[tabMap[activeTab]]) {
                        tabButtons[tabMap[activeTab]].click();
                    }
                    
                    sessionStorage.removeItem('activeTab');
                }, 100);
            }
            
            // Initialize data
            loadStats();
            loadNotifications();
            loadInspections();
            
            // Refresh data every 30 seconds
            setInterval(() => {
                loadStats();
                if (currentTab === 'notifications') loadNotifications();
                if (currentTab === 'inspections') loadInspections();
            }, 30000);
        });
        
        // Tab switching
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Load data if needed
            if (tabName === 'notifications') loadNotifications();
            if (tabName === 'inspections') loadInspections();
        }
        
        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats`);
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data.overview;
                    document.getElementById('totalNotifications').textContent = stats.totalNotifications || 0;
                    document.getElementById('unreadNotifications').textContent = stats.unreadNotifications || 0;
                    document.getElementById('totalInspections').textContent = stats.totalInspections || 0;
                    document.getElementById('criticalIssues').textContent = stats.criticalIssues || 0;
                    
                    // Update header stats
                    document.getElementById('unreadAlertsCount').textContent = stats.unreadNotifications || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch(`${API_URL}/notifications`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    notificationsCache = result.data;
                    renderNotifications(result.data);
                } else {
                    document.getElementById('notificationsList').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📭</div>
                            <p>No notifications yet</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                showToast('Error loading notifications', 'error');
            }
        }
        
        // Render notifications
        function renderNotifications(notifications) {
            const html = notifications.map(notification => {
                const date = new Date(notification.timestamp);
                const timeAgo = getTimeAgo(date);
                
                return `
                    <div class="list-item" onclick="markAsRead('${notification._id}')">
                        <div class="list-item-header">
                            <div>
                                <span class="list-item-title">${notification.driver}</span>
                                <span class="status-badge status-${notification.status}">${notification.status}</span>
                                ${notification.priority && notification.priority !== 'normal' ? 
                                    `<span class="status-badge urgency-${notification.priority}">${notification.priority}</span>` : ''}
                            </div>
                            <div class="list-item-meta">
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                        <div class="list-item-meta">
                            <span>📍 ${notification.location}</span>
                            <span>🏢 ${notification.warehouse}</span>
                            ${notification.estimatedArrival ? `<span>⏱️ ETA: ${notification.estimatedArrival}</span>` : ''}
                        </div>
                        ${notification.notes ? `<div style="margin-top: 0.5rem; color: #6b7280;">${notification.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('notificationsList').innerHTML = html;
        }
        
        // Filter notifications
        function filterNotifications(searchTerm) {
            const filtered = notificationsCache.filter(n => 
                n.driver.toLowerCase().includes(searchTerm.toLowerCase())
            );
            renderNotifications(filtered);
        }
        
        // Load inspections
        async function loadInspections() {
            try {
                const response = await fetch(`${API_URL}/inspections`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    inspectionsCache = result.data;
                    renderInspections(result.data);
                } else {
                    document.getElementById('inspectionsList').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p>No inspections yet</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading inspections:', error);
                showToast('Error loading inspections', 'error');
            }
        }
        
        // Render inspections
        function renderInspections(inspections) {
            const html = inspections.map(inspection => {
                const date = new Date(inspection.submittedAt || inspection.checkInTime);
                const timeAgo = getTimeAgo(date);
                
                return `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div>
                                <span class="list-item-title">${inspection.driver}</span>
                                <span class="status-badge urgency-${inspection.urgencyLevel || 'low'}">
                                    ${inspection.urgencyLevel || 'low'} priority
                                </span>
                                ${inspection.status ? `<span class="status-badge">${inspection.status}</span>` : ''}
                            </div>
                            <div class="list-item-meta">
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                        <div class="list-item-meta">
                            <span>🚛 ${inspection.tractorNumber}</span>
                            <span>📦 ${inspection.trailerNumber}</span>
                            <span>⛽ ${inspection.fuelLevel}</span>
                            <span>📏 ${inspection.odometerReading?.toLocaleString()} miles</span>
                        </div>
                        ${inspection.damageFound || inspection.repairsNeeded ? `
                            <div style="margin-top: 0.5rem; color: #dc2626;">
                                ${inspection.damageFound ? `Damage: ${inspection.damageFound}<br>` : ''}
                                ${inspection.repairsNeeded ? `Repairs: ${inspection.repairsNeeded}` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('inspectionsList').innerHTML = html;
        }
        
        // Filter inspections
        function filterInspections(searchTerm) {
            const filtered = inspectionsCache.filter(i => 
                i.driver.toLowerCase().includes(searchTerm.toLowerCase())
            );
            renderInspections(filtered);
        }
        
        // Submit notification
        async function submitNotification(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            // Remove empty fields
            Object.keys(data).forEach(key => {
                if (!data[key]) delete data[key];
            });
            
            try {
                const response = await fetch(`${API_URL}/notifications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Notification created successfully', 'success');
                    event.target.reset();
                    loadNotifications();
                    loadStats();
                    
                    // Switch to notifications tab
                    document.querySelectorAll('.tab')[0].click();
                } else {
                    showToast(result.error || 'Error creating notification', 'error');
                }
            } catch (error) {
                console.error('Error submitting notification:', error);
                showToast('Error submitting notification', 'error');
            }
        }
        
        // Submit inspection
        async function submitInspection(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            // Add default safety and equipment checks
            data.safetyChecks = ['Pre-trip inspection completed'];
            data.equipmentChecks = ['Equipment check completed'];
            
            // Remove empty fields
            Object.keys(data).forEach(key => {
                if (!data[key]) delete data[key];
            });
            
            try {
                const response = await fetch(`${API_URL}/inspections`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Inspection submitted successfully', 'success');
                    event.target.reset();
                    loadInspections();
                    loadStats();
                    
                    // Switch to inspections tab
                    document.querySelectorAll('.tab')[1].click();
                } else {
                    showToast(result.error || 'Error submitting inspection', 'error');
                }
            } catch (error) {
                console.error('Error submitting inspection:', error);
                showToast('Error submitting inspection', 'error');
            }
        }
        
        // Mark notification as read
        async function markAsRead(notificationId) {
            try {
                await fetch(`${API_URL}/notifications/${notificationId}/read`, {
                    method: 'PATCH'
                });
                loadNotifications();
                loadStats();
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + ' years ago';
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + ' months ago';
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + ' days ago';
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + ' hours ago';
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + ' minutes ago';
            
            return Math.floor(seconds) + ' seconds ago';
        }
    </script>
</body>
</html>
